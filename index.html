<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>INDOCART</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

  <style>
  :root {
    --bg: #f7f9fc;
    --card: #ffffff;
    --accent: #0b74da;
    --accent-dark: #094fa1;
    --muted: #6b7280;
    --shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    --radius: 10px;
    --font: "Poppins", system-ui, sans-serif;
    --font-size-base: 13px;
    --font-size-small: 11px;
    --spacing-sm: 6px;
    --spacing-md: 10px;
    --spacing-lg: 14px;
  }

  *, *::before, *::after {
    box-sizing: border-box;
  }

  body {
    margin: 0;
    font-family: var(--font);
    background-color: var(--bg);
    color: #111;
    overflow-x: hidden;
    font-size: var(--font-size-base);
  }

  header {
    background: linear-gradient(90deg, var(--accent), var(--accent-dark));
    color: #fff;
    padding: var(--spacing-lg) var(--spacing-md);
    box-shadow: var(--shadow);
  }

  header .muted {
    color: #ffffff !important;
    font-weight: 500;
    text-shadow: 0 1px 2px rgba(0,0,0,0.2);
  }

  header #cartCount {
    color: #ffffff;
    font-weight: 600;
  }

  .container {
    max-width: 100%;
    margin: 0 auto;
    padding: var(--spacing-md);
  }

  h2, h3 {
    margin: var(--spacing-md) 0;
  }

  .grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--spacing-lg);
  }

  @media (min-width: 900px) {
    .grid {
      grid-template-columns: 1fr 360px;
    }
  }

  .card {
    background: var(--card);
    border-radius: var(--radius);
    padding: var(--spacing-lg);
    box-shadow: var(--shadow);
    overflow: hidden;
  }

  .row {
    display: flex;
    gap: var(--spacing-md);
    flex-wrap: wrap;
    margin-bottom: var(--spacing-lg);
  }

  .col {
    flex: 1;
    min-width: 100px;
  }

  input, select {
    width: 100%;
    padding: var(--spacing-sm);
    border: 1px solid #dee2e6;
    border-radius: var(--radius);
    font-size: var(--font-size-base);
    outline: none;
    transition: 0.2s ease;
  }

  input:focus, select:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 2px rgba(11, 116, 218, 0.15);
  }

  button {
    background: var(--accent);
    color: #fff;
    padding: var(--spacing-sm) var(--spacing-md);
    border: none;
    border-radius: var(--radius);
    font-weight: 600;
    font-size: var(--font-size-base);
    cursor: pointer;
    transition: background 0.2s ease;
    width: 100%;
    box-sizing: border-box;
  }

  button:hover {
    background: var(--accent-dark);
  }

  button.ghost {
    background: transparent;
    color: var(--accent);
    border: 1px solid rgba(11, 116, 218, 0.2);
  }

  button.small {
    padding: var(--spacing-sm) var(--spacing-md);
    font-size: var(--font-size-small);
  }

  button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .muted {
    color: var(--muted);
    font-size: var(--font-size-small);
  }

  .badge {
    background: #eef6ff;
    color: var(--accent);
    padding: var(--spacing-sm) var(--spacing-md);
    border-radius: 999px;
    font-weight: 600;
    font-size: var(--font-size-small);
  }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: var(--font-size-base);
    min-width: 100%;
  }

  th, td {
    padding: var(--spacing-sm);
    border-bottom: 1px solid #f1f3f5;
    text-align: left;
    vertical-align: top;
    word-break: break-word;
  }

  th {
    font-weight: 600;
    color: #333;
    background: #f9fbfd;
  }

  .table-wrapper {
    overflow-x: auto;
    width: 100%;
    -webkit-overflow-scrolling: touch;
    margin-top: var(--spacing-sm);
    border-radius: var(--radius);
    background: var(--card);
    box-shadow: var(--shadow);
  }

  /* ===== PREVIEW STRUK POPUP (abu muda elegan) ===== */
  #receiptPreviewModal {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.45);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 12000;
  }

  #receiptPreviewBox {
    background: #f5f7fa;
    border-radius: 10px;
    padding: 18px;
    width: 92%;
    max-width: 420px;
    box-shadow: 0 12px 40px rgba(6, 15, 25, 0.15);
    font-size: 13px;
  }

  #receiptContent {
    background: #fff;
    border-radius: 8px;
    padding: 12px;
    margin: 10px 0;
    max-height: 340px;
    overflow-y: auto;
    border: 1px solid #e6e9ee;
  }

  #receiptActions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 10px;
  }

  #receiptActions button { width: auto; }

  /* camera & guide overlays keep their z-index */
  #cameraModal, #guideOverlay, #paymentModal { z-index: 9000; }
  </style>

  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>

<body>
  <header>
    <div style="display:flex;justify-content:space-between;align-items:center;gap:var(--spacing-md);flex-wrap:wrap">
      <h2 style="margin:0;font-size:1.25rem">INDOCART</h2>
      <div style="display:flex;gap:var(--spacing-md);align-items:center">
        <div class="muted">Keranjang: <span id="cartCount">0</span> barang</div>
        <div class="badge" id="shopStatus">Offline</div>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="grid">

      <!-- Dashboard Laporan -->
      <div class="card">
        <h2 style="font-size:1.5rem; margin-bottom: var(--spacing-md)">ðŸ“Š Dashboard Laporan</h2>
        <div class="tabs">
          <button class="tab-btn active" onclick="openTab('penjualan')">Penjualan</button>
          <button class="tab-btn" onclick="openTab('restock')">Restock</button>
          <button class="tab-btn" onclick="openTab('stok')">Stok Akhir</button>
        </div>

        <div id="penjualan" class="tab-content active">
          <h3>Laporan Penjualan</h3>
          <div class="flex">
            <label class="muted">From <input id="filterFrom" type="date" /></label>
            <label class="muted">To <input id="filterTo" type="date" /></label>
            <button onclick="loadSales()" class="small">Tampilkan</button>
            <button onclick="exportSales()" class="small ghost">Export CSV</button>
            <button onclick="printSales()" class="small ghost">Cetak</button>
            <button onclick="clearSales()" class="small ghost" title="Hapus laporan hari ini">Clear Laporan</button>
          </div>

          <div class="table-wrapper" style="max-height:200px; margin-top: var(--spacing-sm)">
            <table id="salesTbl">
              <thead><tr><th>No</th><th>Tanggal</th><th>Invoice</th><th>Item</th><th>Total</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div id="restock" class="tab-content">
          <h3>Laporan Restock (Barang Masuk)</h3>
          <div class="flex">
            <button onclick="loadRestock()" class="small">Tampilkan</button>
            <button onclick="exportRestock()" class="small ghost">Export CSV</button>
            <button onclick="printRestock()" class="small ghost">Cetak</button>
          </div>

          <div class="table-wrapper" style="max-height:200px; margin-top: var(--spacing-sm)">
            <table id="restockTbl">
              <thead><tr><th>No</th><th>Tanggal</th><th>SKU</th><th>Nama</th><th>Jumlah</th><th>Stok Akhir</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div id="stok" class="tab-content">
          <h3>Stok Akhir Produk</h3>
          <div class="table-wrapper" style="max-height:200px; margin-top: var(--spacing-sm)">
            <table id="finalStockTbl">
              <thead><tr><th>No</th><th>SKU</th><th>Nama</th><th>Stok</th><th>Harga</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Tambah / Edit Produk -->
      <div class="card">
        <section>
          <h3>Tambah Produk</h3>
          <form id="formProduct" onsubmit="submitProduct();return false" style="margin-bottom: var(--spacing-lg)">
            <div class="row">
              <div class="col">
                <label class="muted">Kode Barang / SKU</label>
                <div style="display:flex;gap:var(--spacing-sm)">
                  <input id="sku" placeholder="Kode Barang" type="text" required />
                  <button type="button" class="small" onclick="scanSku()" title="Scan Kode Barang">Scan</button>
                </div>
              </div>
              <div class="col">
                <label class="muted">Nama Produk</label>
                <input id="name" placeholder="Nama Produk" type="text" required />
              </div>
            </div>
            <div class="row">
              <div class="col">
                <label class="muted">Harga Jual (Rp)</label>
                <input id="price" placeholder="Harga Jual (Rp)" type="number" required />
              </div>
              <div class="col">
                <label class="muted">Stok (angka)</label>
                <input id="qty" placeholder="Stok (angka)" type="number" required />
              </div>
            </div>
            <div style="display:flex;gap:var(--spacing-sm);flex-wrap:wrap;align-items:center">
              <button type="submit" id="formSubmitBtn">Tambah</button>
              <button type="button" class="ghost" onclick="resetForm()">Reset</button>
              <div class="muted" style="margin-left: auto; font-size: var(--font-size-small)">
                Jika nama sudah ada, stok akan <strong>dijumlahkan</strong>.
              </div>
            </div>
          </form>

          <h3>Restock Produk</h3>
          <form id="formRestock" onsubmit="restockProduct();return false" class="flex" style="gap:var(--spacing-sm); flex-wrap:wrap; align-items:center">
            <select id="restockName" required>
              <option value="">Pilih Produk...</option>
            </select>
            <input id="restockQty" placeholder="Jumlah Restock" type="number" required />
            <button type="submit">Tambah Stok</button>
          </form>

          <h3>Daftar Produk</h3>
          <input id="search" placeholder="Cari produk (Kode/Nama)..." oninput="render()"
                 style="margin-bottom: var(--spacing-lg); width: 100%; padding: var(--spacing-sm);
                        border-radius: var(--radius); border:1px solid #e8eef8" />
          <div class="table-wrapper" style="max-height: 300px;">
            <table id="tbl">
              <thead><tr><th>SKU</th><th>Nama</th><th>Stok</th><th>Harga</th><th>Aksi</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </section>
      </div>

      <!-- Sisi Kanan: Keranjang dan Scan Produk -->
      <div class="card">
        <h3>Keranjang (<span id="cartCount2">0</span>)</h3>
        <div id="cart"><i class="muted">Keranjang kosong</i></div>
        <div class="flex" style="margin-top: var(--spacing-md); flex-direction: column; gap: var(--spacing-sm)">
          <div class="note">Total: <strong id="total">Rp 0</strong></div>
          <div style="width: 100%; margin-top: var(--spacing-md)">
            <button id="checkoutBtn" onclick="checkout()" disabled>Bayar</button>
            <button class="ghost" onclick="clearCart()">Kosongkan</button>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>Scan Produk</h3>
        <div class="flex" style="gap: var(--spacing-sm); flex-wrap: wrap; margin-bottom: var(--spacing-sm)">
          <button id="btnStartScan" onclick="startScan('sell')" class="small">Mulai Scan Jual</button>
          <button id="btnStopScan" onclick="stopScan()" class="small ghost">Stop Scan</button>
          <label class="muted" style="margin-left: auto">Mode:
            <select id="scanMode" style="margin-left: var(--spacing-sm)">
              <option value="single">1x auto-stop</option>
              <option value="continuous">Multi-scan</option>
            </select>
          </label>
        </div>
        <div style="display:flex; gap:var(--spacing-sm); align-items:center; margin-bottom: var(--spacing-sm)">
          <label><input type="checkbox" id="autoSell" /> <span class="muted">Auto-sell on scan</span></label>
        </div>
        <div class="muted note" style="margin-top: var(--spacing-sm)">Gunakan kamera ponsel. Pilih mode single jika ingin berhenti setelah 1 scan.</div>
      </div>
      
    </div>
  </main>

  <div id="cameraModal" style="
  display:none;
  position:fixed;
  top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,0.6);
  justify-content:center;
  align-items:center;
  z-index:9000;
">
  <div style="
    background:#fff;
    border-radius:10px;
    padding:20px;
    max-width:400px;
    width:90%;
    box-shadow:0 4px 12px rgba(0,0,0,0.2);
  ">
    <h3 style="margin-top:0;margin-bottom:10px">ðŸ“· Scan Barcode</h3>
    <div id="cameraReader" style="width:100%;background:#000;min-height:250px;border-radius:8px;overflow:hidden"></div>
    <div style="display:flex;justify-content:end;margin-top:10px;gap:10px">
      <button class="ghost small" onclick="closeCamera()">Tutup</button>
    </div>
  </div>
</div>

  <div id="guideOverlay">
    <div id="guideBox">
      <h3>Selamat Datang di POS Toko Sembako</h3>
      <p>Klik mulai untuk tutorial singkat semua fitur, atau skip jika sudah hafal.</p>
      <button onclick="startGuide()">Mulai</button>
      <button onclick="skipGuide()">Skip</button>
    </div>
  </div>

  <!-- payment modal -->
  <div id="paymentModal">
    <div class="box">
      <h3 style="margin-top:0">Pembayaran</h3>
      <div id="pmTop" style="margin-bottom:8px" class="muted">Pilih metode pembayaran untuk menyelesaikan transaksi.</div>

      <div id="paymentMethods">
        <div class="pm-btn" data-method="cash" onclick="selectPaymentMethod('cash', this)">Tunai</div>
        <div class="pm-btn" data-method="transfer" onclick="selectPaymentMethod('transfer', this)">Transfer Bank</div>
        <div class="pm-btn" data-method="card" onclick="selectPaymentMethod('card', this)">Kartu (EDC)</div>
        <div class="pm-btn" data-method="qris" onclick="selectPaymentMethod('qris', this)">QRIS / e-Wallet</div>
      </div>

      <div id="paymentInfoBox" class="pay-instr">Total: <strong id="payTotal">Rp 0</strong></div>

      <div style="display:flex;gap:8px">
        <button onclick="confirmPayment()" id="confirmPayBtn">Konfirmasi Pembayaran</button>
        <button class="ghost" onclick="closePaymentModal()">Batal</button>
      </div>

      <div id="payDebug" style="margin-top:10px" class="muted"></div>
    </div>
  </div>

  <!-- PREVIEW STRUK MODAL -->
  <div id="receiptPreviewModal">
    <div id="receiptPreviewBox">
      <h3>Preview Struk Pembelian</h3>
      <div id="receiptContent">
        <!-- Struk akan dimasukkan dinamis -->
      </div>
      <div id="receiptActions">
        <button onclick="printPreviewReceipt()">Cetak Struk</button>
        <button class="ghost" onclick="closeReceiptPreview()">Tutup</button>
      </div>
    </div>
  </div>

  <!-- receipt area template (hidden) -->
  <div id="receiptTemplate" style="display:none"><div id="receiptArea"></div></div>

<script>
/* ---------- data ---------- */
let products = JSON.parse(localStorage.getItem('products')||'[]');
let sales = JSON.parse(localStorage.getItem('sales')||'[]');
let restocks = JSON.parse(localStorage.getItem('restocks')||'[]');
let cart = [];

// pendingPaidInvoice stored during session so user can finalize after paying
let pendingPaidInvoice = localStorage.getItem('pendingPaidInvoice') || null;
let selectedPaymentMethod = null;

/* ---------- utility ---------- */
function getLocalDateTime(){
  const d=new Date();
  const yyyy=d.getFullYear();
  const mm=String(d.getMonth()+1).padStart(2,"0");
  const dd=String(d.getDate()).padStart(2,"0");
  const hh=String(d.getHours()).padStart(2,"0");
  const mi=String(d.getMinutes()).padStart(2,"0");
  const ss=String(d.getSeconds()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd} ${hh}:${mi}:${ss}`;
}

function parseStoredDate(dStr){
  if(!dStr) return null;
  let iso = dStr;
  if(dStr.indexOf(' ') !== -1 && dStr.indexOf('T') === -1){
    iso = dStr.replace(' ', 'T');
  }
  const d = new Date(iso);
  if(isNaN(d.getTime())){
    const alt = dStr.replace(/\//g,'-').replace(' ', 'T');
    const d2 = new Date(alt);
    if(isNaN(d2.getTime())) return null;
    return d2;
  }
  return d;
}

/* ---------- render product list ---------- */
function render(){
  const tbl=document.querySelector("#tbl tbody");
  const search=document.querySelector("#search").value.toLowerCase();
  tbl.innerHTML="";
  products.forEach((p,i)=>{
    if(p.name.toLowerCase().includes(search)||p.sku.includes(search)){
      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td>${p.sku}</td>
        <td>${p.name}</td>
        <td>${p.qty}</td>
        <td>Rp ${p.price.toLocaleString()}</td>
        <td class="actions">
          <button class="small" onclick="editProduct('${p.sku}')">Edit</button>
          <button class="small ghost" onclick="deleteProduct('${p.sku}')">Hapus</button>
        </td>`;
      tbl.appendChild(tr);
    }
  });
  updateRestockDropdown();
}

/* ---------- product CRUD ---------- */
function submitProduct(){
  const sku = document.getElementById("sku").value.trim();
  const name = document.getElementById("name").value.trim();
  const price = parseInt(document.getElementById("price").value);
  const qty = parseInt(document.getElementById("qty").value);
  if(!sku || !name || !price || !qty) return alert("Lengkapi data!");
  
  const exist = products.find(p => p.sku === sku);
  if(exist){
    exist.qty += qty;
    exist.price = price;
  } else {
    products.push({sku, name, price, qty});
  }

  localStorage.setItem("products", JSON.stringify(products));
  render();
  resetForm();

  alert("Berhasil ditambahkan!");
}

function resetForm(){
  document.getElementById("sku").value="";
  document.getElementById("name").value="";
  document.getElementById("price").value="";
  document.getElementById("qty").value="";
  document.getElementById("formSubmitBtn").textContent="Tambah";
}

function editProduct(sku){
  const p=products.find(x=>x.sku===sku);
  if(!p) return;
  document.getElementById("sku").value=p.sku;
  document.getElementById("name").value=p.name;
  document.getElementById("price").value=p.price;
  document.getElementById("qty").value=p.qty;
  document.getElementById("formSubmitBtn").textContent="Update";
}

function deleteProduct(sku){
  if(!confirm("Hapus produk ini?")) return;
  products=products.filter(p=>p.sku!==sku);
  localStorage.setItem("products",JSON.stringify(products));
  render();
}

function updateRestockDropdown(){
  const sel=document.getElementById("restockName");
  if(!sel) return;
  sel.innerHTML='<option value="">Pilih Produk...</option>';
  products.forEach(p=>{
    const opt=document.createElement("option");
    opt.value=p.sku; opt.textContent=p.name;
    sel.appendChild(opt);
  });
}

/* ---------- restock ---------- */
function restockProduct(){
  const sku=document.getElementById("restockName").value;
  const qty=parseInt(document.getElementById("restockQty").value);
  if(!sku||!qty) return alert("Pilih produk & jumlah!");
  const p=products.find(x=>x.sku===sku);
  if(!p) return alert("Produk tidak ditemukan");

  p.qty+=qty;
  localStorage.setItem("products",JSON.stringify(products));

  restocks.push({
    date:getLocalDateTime(),
    sku:p.sku,
    name:p.name,
    qty,
    stockAfter:p.qty
  });
  localStorage.setItem("restocks",JSON.stringify(restocks));

  render(); document.getElementById("restockQty").value="";
}

/* ---------- CART ---------- */
function addToCart(sku){
  const p=products.find(x=>x.sku===sku);
  if(!p) return alert("Produk tidak ditemukan");
  const cartItem=cart.find(c=>c.sku===sku);
  if(cartItem){
    if(cartItem.qty>=p.qty) return alert("Stok tidak cukup");
    cartItem.qty+=1;
  }else{
    cart.push({sku:p.sku,name:p.name,price:p.price,qty:1});
  }
  renderCart();
}

function renderCart(){
  const el=document.getElementById("cart");
  const count=document.getElementById("cartCount");
  const count2=document.getElementById("cartCount2");
  const checkoutBtn=document.getElementById("checkoutBtn");
  const totalEl=document.getElementById("total");
  if(cart.length===0){
    el.innerHTML='<i class="muted">Keranjang kosong</i>';
    count.textContent="0";
    count2.textContent="0";
    checkoutBtn.disabled=true;
    totalEl.textContent="Rp 0";
    return;
  }
  let html="<table style='width:100%'>", total=0;
  cart.forEach((c,i)=>{
    total+=c.price*c.qty;
    html += `
    <tr>
      <td style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
        ${c.name} <span style="color:#6b7280;">x${c.qty}</span>
      </td>
      <td style="text-align:right;">Rp ${(c.price*c.qty).toLocaleString()}</td>
      <td style="text-align:center;">
        <button class="small ghost" onclick="removeFromCart('${c.sku}')">-</button>
      </td>
    </tr>`;
  });
  html+="</table>";
  el.innerHTML=html;
  count.textContent=cart.length;
  count2.textContent=cart.length;
  checkoutBtn.disabled=false;
  totalEl.textContent="Rp "+total.toLocaleString();

  if(pendingPaidInvoice){
    document.getElementById("checkoutBtn").textContent = "Selesaikan Penjualan";
  } else {
    document.getElementById("checkoutBtn").textContent = "Bayar";
  }
}

function removeFromCart(sku){ cart = cart.filter(c=>c.sku!==sku); renderCart(); }
function clearCart(){ cart=[]; pendingPaidInvoice = null; localStorage.removeItem('pendingPaidInvoice'); renderCart(); }

/* ---------- PAYMENT FLOW ---------- */
function checkout(){
  if(pendingPaidInvoice){
    finishSale(pendingPaidInvoice);
    return;
  }
  if(cart.length === 0) return alert("Keranjang kosong");
  openPaymentModal();
}

function openPaymentModal(){
  selectedPaymentMethod = null;
  document.querySelectorAll('.pm-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('payDebug').textContent = '';
  const total = cart.reduce((s,i)=>s + i.price*i.qty, 0);
  document.getElementById('payTotal').textContent = "Rp " + total.toLocaleString();
  document.getElementById('paymentModal').style.display = 'flex';
}

function closePaymentModal(){
  document.getElementById('paymentModal').style.display = 'none';
  selectedPaymentMethod = null;
}

function selectPaymentMethod(method, el){
  selectedPaymentMethod = method;
  document.querySelectorAll('.pm-btn').forEach(b=>b.classList.remove('active'));
  if(el) el.classList.add('active');
  let info = '';
  if(method === 'cash') info = 'Pembayaran tunai: Terima uang tunai dari pelanggan dan kembalikan jika perlu.';
  if(method === 'transfer') info = 'Transfer bank: Tunjukkan nomor VA / rekening ke pembeli. Konfirmasi manual atau otomatis melalui gateway.';
  if(method === 'card') info = 'Kartu/EDC: Lakukan pembayaran melalui mesin EDC (fisik).';
  if(method === 'qris') info = 'QRIS / e-wallet: Tampilkan QR untuk dipindai pembeli. Setelah terbayar, konfirmasi.';
  document.getElementById('paymentInfoBox').innerHTML = `<div class="pay-instr">${info}</div><div>Total: <strong id="payTotal">Rp ${cart.reduce((s,i)=>s+i.price*i.qty,0).toLocaleString()}</strong></div>`;
}

function confirmPayment(){
  if(!selectedPaymentMethod) return alert("Pilih metode pembayaran terlebih dahulu");
  const btn = document.getElementById('confirmPayBtn');
  btn.disabled = true;
  btn.textContent = "Memproses...";
  setTimeout(()=>{
    const invoice = 'INV' + Date.now();
    const now = new Date();
    const date = now.toISOString();
    const dateDisplay = now.toLocaleString();
    const total = cart.reduce((s,i)=>s + i.price*i.qty, 0);

    const transaction = {
      invoice,
      date,
      dateDisplay,
      items: JSON.parse(JSON.stringify(cart)),
      total,
      method: selectedPaymentMethod,
      status: 'paid',
      finalized: false
    };

    sales.push(transaction);
    localStorage.setItem('sales', JSON.stringify(sales));

    pendingPaidInvoice = invoice;
    localStorage.setItem('pendingPaidInvoice', invoice);

    btn.disabled = false;
    btn.textContent = "Konfirmasi Pembayaran";
    closePaymentModal();
    renderCart();
    alert("Pembayaran berhasil dicatat. Invoice: " + invoice + ". Tekan tombol Selesaikan Penjualan untuk finalisasi & melihat struk.");
  }, 900);
}

/* ---------- FINALIZE SALE ---------- */
function finishSale(invoice){
  const txIndex = sales.findIndex(s=>s.invoice===invoice);
  if(txIndex === -1) return alert("Transaksi tidak ditemukan");
  const tx = sales[txIndex];
  if(tx.finalized){
    alert("Transaksi sudah diselesaikan: " + invoice);
    pendingPaidInvoice = null;
    localStorage.removeItem('pendingPaidInvoice');
    renderCart(); render(); renderFinalStock();
    return;
  }

  tx.items.forEach(it=>{
    const p = products.find(x=>x.sku===it.sku);
    if(p){
      p.qty = Math.max(0, p.qty - it.qty);
    }
  });

  tx.status = 'completed';
  tx.finalized = true;
  tx.completedAt = getLocalDateTime();

  localStorage.setItem('products', JSON.stringify(products));
  localStorage.setItem('sales', JSON.stringify(sales));

  const doPreview = confirm("Penjualan selesai. Mau lihat preview struk?");
  if(doPreview) showReceiptPreview(tx);

  pendingPaidInvoice = null;
  localStorage.removeItem('pendingPaidInvoice');
  cart = [];
  renderCart(); render(); renderFinalStock();
  alert("Penjualan selesai dan stok diperbarui. Invoice: " + invoice);
}

/* ---------- PREVIEW STRUK HANDLERS ---------- */
function showReceiptPreview(t){
  const cont = document.getElementById("receiptContent");
  let html = `<div style="font-size:13px"><strong>Invoice:</strong> ${t.invoice}<br><strong>Tanggal:</strong> ${t.dateDisplay || getLocalDateTime()}<br><strong>Metode:</strong> ${t.method || '-'}</div><hr/>`;
  html += `<table style="width:100%;font-size:13px;border-collapse:collapse"><tr><th align="left">Nama</th><th>Qty</th><th align="right">Subtotal</th></tr>`;
  t.items.forEach(i=>{
    html += `<tr><td style="padding:6px 0">${i.name}</td><td style="text-align:center">${i.qty}</td><td style="text-align:right">Rp ${(i.price*i.qty).toLocaleString()}</td></tr>`;
  });
  html += `</table><hr/><div style="text-align:right;font-weight:700">Total: Rp ${t.total.toLocaleString()}</div>`;
  cont.innerHTML = html;
  document.getElementById("receiptPreviewModal").style.display = 'flex';
}

function closeReceiptPreview(){ document.getElementById("receiptPreviewModal").style.display = 'none'; }

function printPreviewReceipt(){
  const content = document.getElementById("receiptContent").innerHTML;
  const w = window.open("", "_blank", "width=400,height=600");
  w.document.write("<html><head><title>Struk Pembelian</title></head><body style='font-family:Arial,Helvetica,sans-serif;padding:10px'>"+content+"</body></html>");
  w.document.close();
  w.focus();
  try{ w.print(); setTimeout(()=>{ try{ w.close() }catch(e){} }, 800); }catch(e){ try{ w.close() }catch(_){} }
}

/* ---------- REPORTS & EXPORT ---------- */
function getCsvDateFromRecord(rec){
  let dObj = null;
  if(rec && rec.date) dObj = parseStoredDate(rec.date);
  if((!dObj || isNaN(dObj)) && rec && rec.dateDisplay) dObj = parseStoredDate(rec.dateDisplay);
  if(dObj && !isNaN(dObj)){
    const yyyy = dObj.getFullYear();
    const mm = String(dObj.getMonth()+1).padStart(2,"0");
    const dd = String(dObj.getDate()).padStart(2,"0");
    const hh = String(dObj.getHours()).padStart(2,"0");
    const mi = String(dObj.getMinutes()).padStart(2,"0");
    const ss = String(dObj.getSeconds()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd} ${hh}:${mi}:${ss}`;
  }
  return rec.dateDisplay || "";
}

function loadSales(){
  const from=document.getElementById("filterFrom").value;
  const to=document.getElementById("filterTo").value;
  const tbl=document.querySelector("#salesTbl tbody");
  tbl.innerHTML="";
  let counter = 1;
  sales.forEach((s)=>{
    const dObj = new Date(s.date);
    const d = s.dateDisplay || dObj.toLocaleString();
    let valid=true;
    if(from && dObj < new Date(from)) valid=false;
    if(to && dObj > new Date(to)) valid=false;
    if(valid){
      tbl.innerHTML+=`
        <tr>
          <td>${counter}</td>
          <td>${d}</td>
          <td>${s.invoice}</td>
          <td>${s.items.map(x=>x.name+" x"+x.qty).join(", ")}</td>
          <td>Rp ${s.total.toLocaleString()}</td>
        </tr>`;
      counter++;
    }
  });
}

function loadRestock(){
  const tbl=document.querySelector("#restockTbl tbody");
  tbl.innerHTML="";
  restocks.forEach((r,i)=>{
    const dObj = parseStoredDate(r.date);
    const dDisplay = dObj ? dObj.toLocaleDateString('id-ID') : r.date;
    tbl.innerHTML+=`
      <tr>
        <td>${i+1}</td>
        <td>${dDisplay}</td>
        <td>${r.sku}</td>
        <td>${r.name}</td>
        <td>${r.qty}</td>
        <td>${r.stockAfter}</td>
      </tr>`;
  });
}

function exportSales(){
  if(sales.length === 0) return alert("Tidak ada data penjualan");
  let csv = "No;Tanggal;Invoice;Item;Total
";
  let counter = 1;
  sales.forEach((s) => {
    const d = getCsvDateFromRecord(s);
    const items = s.items.map(x => `${x.name} x${x.qty}`).join(" | ");
    csv += `${counter};"${d}";"${s.invoice}";"${items}";"${s.total}"
`;
    counter++;
  });
  downloadCSV(csv, "laporan_penjualan.csv");
}

function exportRestock(){
  if(restocks.length === 0) return alert("Tidak ada data restock");
  let csv = "No;Tanggal;SKU;Nama;Qty;StokAkhir
";
  let counter = 1;
  restocks.forEach(r=>{
    csv += `${counter};"${r.date}";"${r.sku}";"${r.name}";"${r.qty}";"${r.stockAfter}"
`;
    counter++;
  });
  downloadCSV(csv, "laporan_restock.csv");
}

function downloadCSV(content, filename){
  const blob = new Blob([content], { type: "text/csv;charset=utf-8;" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = filename;
  link.style.display = "none";
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

function printRestock(){ window.print(); }
function clearSales(){ if(!confirm("Hapus semua laporan penjualan?")) return; sales=[]; localStorage.setItem("sales", JSON.stringify(sales)); loadSales(); alert("Semua laporan penjualan berhasil dihapus."); }

/* ---------- FINAL STOCK ---------- */
function renderFinalStock(){
  const tbl=document.querySelector("#finalStockTbl tbody");
  tbl.innerHTML="";
  products.forEach((p,i)=>{
    tbl.innerHTML+=`<tr><td>${i+1}</td><td>${p.sku}</td><td>${p.name}</td><td>${p.qty}</td><td>Rp ${p.price.toLocaleString()}</td></tr>`;
  });
}

/* ---------- SCAN: html5-qrcode integration ---------- */
let html5QrcodeScanner = null;
let scanTarget = null;

function openCamera(target) {
  scanTarget = target;
  const camModal = document.getElementById('cameraModal');
  camModal.style.display = 'flex';
  camModal.style.pointerEvents = 'auto';
  camModal.style.zIndex = '9000';

  if (html5QrcodeScanner) return;
  try {
    html5QrcodeScanner = new Html5Qrcode("cameraReader");
    const config = { fps: 10, qrbox: 250 };
    html5QrcodeScanner.start({ facingMode: "environment" }, config, msg => {
      handleScan(msg);
      if (document.getElementById("scanMode")?.value === "single") stopCamera();
    }).catch(err => {
      console.error(err);
      alert("Gagal mengakses kamera: " + err);
    });
  } catch (e) {
    console.error(e);
    alert("Inisialisasi kamera gagal: " + e);
  }
}

function stopCamera() {
  if (html5QrcodeScanner) {
    html5QrcodeScanner.stop().catch(()=>{}).finally(() => {
      html5QrcodeScanner = null;
      document.getElementById("cameraReader").innerHTML = "";
    });
  }
  const camModal = document.getElementById('cameraModal');
  if (camModal) {
    camModal.style.display = "none";
    camModal.style.pointerEvents = "none";
  }
}

function closeCamera() { stopCamera(); }
function stopScan(){ stopCamera(); }

function handleScan(msg) {
  if (scanTarget === "sell" || document.getElementById("autoSell")?.checked) {
    addToCart(msg);
  } else {
    document.getElementById("sku").value = msg;
    alert("Kode Barang terdeteksi: " + msg);
  }
}

function scanSku() { openCamera("sku"); }
function startScan(target) { openCamera(target); }

/* ---------- GUIDE (interaktif) ---------- */
(function(){
  window.guideSteps = window.guideSteps || [
    { selector: "#formProduct", text: "ðŸ§¾ Tambahkan produk baru di sini. Isi kode, nama, harga, dan stok." },
    { selector: "#formRestock", text: "ðŸ“¦ Tambah stok barang yang sudah ada dengan form Restock ini." },
    { selector: "#tbl", text: "ðŸ“‹ Daftar semua produk kamu muncul di tabel ini. Bisa diedit atau dihapus." },
    { selector: "#btnStartScan", text: "ðŸ“¸ Gunakan fitur Scan untuk menambah produk ke keranjang lewat kamera." },
    { selector: "#cart", text: "ðŸ›’ Semua barang yang kamu jual akan muncul di keranjang ini." },
    { selector: "#checkoutBtn", text: "ðŸ’° Setelah selesai, tekan tombol ini untuk menyelesaikan penjualan (setelah bayar)." },
  ];

  let currentStep = 0;
  let highlightBox = null;
  let tooltip = null;

  function createGuideElements(){
    if(!highlightBox){
      highlightBox = document.createElement("div");
      highlightBox.id = "highlightBox";
      highlightBox.style.position = "absolute";
      highlightBox.style.border = "2px solid #0b74da";
      highlightBox.style.borderRadius = "10px";
      highlightBox.style.background = "rgba(11, 116, 218, 0.12)";
      highlightBox.style.zIndex = "100000";
      highlightBox.style.pointerEvents = "none";
      highlightBox.style.transition = "all 0.25s ease";
      document.body.appendChild(highlightBox);
    }

    if(!tooltip){
      tooltip = document.createElement("div");
      tooltip.id = "guideTooltip";
      tooltip.style.position = "absolute";
      tooltip.style.background = "#fff";
      tooltip.style.borderRadius = "8px";
      tooltip.style.boxShadow = "0 6px 20px rgba(0,0,0,0.15)";
      tooltip.style.padding = "12px";
      tooltip.style.maxWidth = "320px";
      tooltip.style.zIndex = "100001";
      tooltip.style.fontSize = "13px";
      document.body.appendChild(tooltip);
    }
  }

  function showStep(i) {
    const steps = window.guideSteps || [];
    if (!steps || steps.length === 0) return endGuide();
    if (i < 0) i = 0;
    if (i >= steps.length) return endGuide();

    currentStep = i;
    const step = steps[i];
    if (!step || !step.selector) return nextGuide();

    const el = document.querySelector(step.selector);
    if (!el) {
      console.warn("Guide: element not found:", step.selector);
      return nextGuide();
    }

    createGuideElements();

    const rect = el.getBoundingClientRect();
    const padding = 8;
    highlightBox.style.top = rect.top + window.scrollY - padding + "px";
    highlightBox.style.left = rect.left + window.scrollX - padding + "px";
    highlightBox.style.width = rect.width + padding * 2 + "px";
    highlightBox.style.height = rect.height + padding * 2 + "px";
    highlightBox.style.display = "block";

    const isLast = i === steps.length - 1;
    tooltip.innerHTML = `
      <div style="margin-bottom:8px">${step.text || ""}</div>
      <div style="text-align:right">
        <button id="guideNextBtn" style="background:#0b74da;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer">
          ${isLast ? "Selesai" : "Lanjut âžœ"}
        </button>
      </div>
    `;

    const tooltipHeight = 130;
    const spaceBelow = window.innerHeight - rect.bottom;
    let tooltipTop;

    if (spaceBelow > tooltipHeight + 20) {
      tooltipTop = rect.bottom + window.scrollY + 12;
    } else if (rect.top > tooltipHeight + 20) {
      tooltipTop = rect.top + window.scrollY - tooltipHeight - 12;
    } else {
      tooltipTop = window.scrollY + window.innerHeight / 2 - tooltipHeight / 2;
    }

    let left = rect.left + window.scrollX;
    if (left + 340 > window.innerWidth + window.scrollX)
      left = window.innerWidth + window.scrollX - 360;
    if (left < 10) left = 10;

    tooltip.style.top = tooltipTop + "px";
    tooltip.style.left = left + "px";
    tooltip.style.display = "block";
    tooltip.style.opacity = 0;
    tooltip.style.transition = "opacity 0.25s ease";
    setTimeout(() => (tooltip.style.opacity = 1), 20);

    try { el.scrollIntoView({ behavior: "smooth", block: "center" }); } catch (e) {}

    document.getElementById("guideNextBtn").onclick = function (e) {
      e.preventDefault();
      nextGuide();
    };
  }

  function nextGuide(){
    currentStep++;
    if(currentStep >= window.guideSteps.length){
      endGuide();
    } else {
      showStep(currentStep);
    }
  }

  function endGuide(){
    if(highlightBox){ highlightBox.remove(); highlightBox = null; }
    if(tooltip){ tooltip.remove(); tooltip = null; }
    const overlay = document.getElementById("guideOverlay");
    if(overlay) overlay.style.display = "none";
    currentStep = 0;
    setTimeout(()=>{ alert("ðŸŽ‰ Tutorial selesai!"); }, 80);
  }

  function startGuide(){
    const overlay = document.getElementById("guideOverlay");
    if(overlay) overlay.style.display = "none";
    currentStep = 0;
    createGuideElements();
    showStep(0);
  }

  function skipGuide(){
    const overlay = document.getElementById("guideOverlay");
    if(overlay) overlay.style.display = "none";
    endGuide();
  }

  window.createGuideElements = createGuideElements;
  window.showStep = showStep;
  window.nextGuide = nextGuide;
  window.endGuide = endGuide;
  window.startGuide = startGuide;
  window.skipGuide = skipGuide;
})();

/* ---------- TABS & INIT ---------- */
function openTab(id){
  document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
  document.querySelectorAll(".tab-content").forEach(c=>c.classList.remove("active"));
  const btn = document.querySelector(`[onclick="openTab('${id}')"]`);
  if(btn) btn.classList.add("active");
  const el = document.getElementById(id);
  if(el) el.classList.add("active");
}

function init(){
  // restore pendingPaidInvoice from localStorage (jika ada)
  pendingPaidInvoice = localStorage.getItem('pendingPaidInvoice') || pendingPaidInvoice;

  // try to populate date displays in sales if missing
  let updated = false;
  sales.forEach(s => {
    if(s.date && !s.dateDisplay){
      let dObj = new Date(s.date);
      if(isNaN(dObj)){
        s.dateDisplay = s.date;
      } else {
        s.dateDisplay = dObj.toLocaleString();
      }
      updated = true;
    }
  });
  if(updated) localStorage.setItem("sales", JSON.stringify(sales));

  render(); renderFinalStock();
  setInterval(renderFinalStock, 5000);
  const guide = document.getElementById("guideOverlay");
  if(guide) guide.style.display = "flex";
}

document.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>
