<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>INDOCART - Pembukuan Final</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
  :root {
    --bg: #f7f9fc;
    --card: #ffffff;
    --accent: #0b74da;
    --accent-dark: #094fa1;
    --muted: #6b7280;
    --shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    --radius: 10px;
    --font: "Poppins", system-ui, sans-serif;
    --font-size-base: 13px;
    --font-size-small: 11px;
    --spacing-sm: 6px;
    --spacing-md: 10px;
    --spacing-lg: 14px;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:var(--font);background:var(--bg);color:#111;font-size:var(--font-size-base);overflow-x:hidden}
  header{background:linear-gradient(90deg,var(--accent),var(--accent-dark));color:#fff;padding:var(--spacing-lg) var(--spacing-md);box-shadow:var(--shadow);position:relative}
  header .muted{color:#fff!important;font-weight:500;text-shadow:0 1px 2px rgba(0,0,0,0.2)}
  .container{max-width:100%;margin:0 auto;padding:var(--spacing-md)}
  .grid{display:grid;grid-template-columns:1fr;gap:var(--spacing-lg)}
  @media(min-width:900px){.grid{grid-template-columns:1fr 360px}}
  .card{background:var(--card);border-radius:var(--radius);padding:var(--spacing-lg);box-shadow:var(--shadow);overflow:hidden}
  .row{display:flex;gap:var(--spacing-md);flex-wrap:wrap;margin-bottom:var(--spacing-lg)}
  .col{flex:1;min-width:100px}
  input[type=text],input[type=number],input[type=date],select{width:100%;padding:var(--spacing-sm);border:1px solid #dee2e6;border-radius:var(--radius);font-size:var(--font-size-base);outline:none;transition:0.2s}
  input:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 2px rgba(11,116,218,0.12)}
  button{background:var(--accent);color:#fff;padding:var(--spacing-sm) var(--spacing-md);border:none;border-radius:var(--radius);font-weight:600;cursor:pointer}
  button.ghost{background:transparent;color:var(--accent);border:1px solid rgba(11,116,218,0.14)}
  button.small{padding:4px 8px;font-size:var(--font-size-small);width:auto}
  .muted{color:var(--muted);font-size:var(--font-size-small)}
  table{width:100%;border-collapse:collapse;font-size:var(--font-size-base)}
  th,td{padding:8px;border-bottom:1px solid #f1f3f5;text-align:left;vertical-align:middle}
  th{background:#f9fbfd;font-weight:600;color:#333}
  .table-wrapper{overflow-x:auto;border-radius:var(--radius);background:var(--card);box-shadow:var(--shadow);padding:8px}
  #cart{min-height:36px;padding:var(--spacing-sm);background:#f1f5fb;border:1px dashed #cce1ff;border-radius:var(--radius);overflow-x:auto}
  .badge{background:#eef6ff;color:var(--accent);padding:6px 10px;border-radius:999px;font-weight:600}
  /* guide start button top-right */
  #startGuideBtn{position:absolute;right:var(--spacing-md);top:calc(var(--spacing-lg) + 6px);background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.12);color:#fff;padding:8px 12px;border-radius:999px;cursor:pointer;font-weight:600}
  #guideOverlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.65);display:flex;justify-content:center;align-items:center;z-index:10000}
  #guideBox{background:#fff;padding:var(--spacing-lg);border-radius:var(--radius);max-width:90%;width:320px;box-shadow:var(--shadow);text-align:center}
  #highlightBox{position:absolute;border:2px solid var(--accent);border-radius:12px;background:rgba(11,116,218,0.08);pointer-events:none;z-index:100001;transition:all 0.22s ease}
  #guideTooltip{position:absolute;background:#fff;border-radius:8px;box-shadow:0 8px 26px rgba(0,0,0,0.18);padding:12px;max-width:340px;z-index:100002;font-size:13px}
  /* small fix for camera modal */
  #cameraModal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);justify-content:center;align-items:center;z-index:9000}
  #paymentModal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.45);display:none;justify-content:center;align-items:center;z-index:11000}
  #paymentModal .box{background:#fff;border-radius:10px;padding:18px;width:92%;max-width:420px;box-shadow:0 8px 30px rgba(0,0,0,0.25)}
  .pm-btn{flex:1;padding:8px 10px;border-radius:8px;border:1px solid #eef5ff;background:#f8fbff;cursor:pointer;text-align:center;font-weight:600;color:#094fa1;margin-right:6px}
  .pm-btn.active{background:var(--accent);color:#fff;border-color:var(--accent)}
  .pay-instr{background:#f5f7fb;padding:8px;border-radius:8px;margin-bottom:10px;font-size:13px;color:#333}
  @media(max-width:480px){#startGuideBtn{top:8px;padding:6px 8px;font-size:12px}}
  </style>
</head>
<body>
  <header>
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
      <h2 style="margin:0;font-size:1.15rem">INDOCART</h2>
      <div style="display:flex;gap:12px;align-items:center">
        <div class="muted">Keranjang: <span id="cartCount">0</span> barang</div>
        <div class="badge" id="shopStatus">Offline</div>
      </div>
    </div>
    <button id="startGuideBtn" onclick="startGuide()">Mulai Panduan</button>
  </header>

  <main class="container">
    <div class="grid">
      <!-- Dashboard -->
      <div class="card">
        <h2 style="margin-top:0">ðŸ“Š Dashboard Laporan</h2>

        <div class="tabs" style="display:flex;gap:8px;margin-bottom:10px">
          <button class="tab-btn active" onclick="openTab('penjualan')">Penjualan</button>
          <button class="tab-btn" onclick="openTab('restock')">Restock</button>
          <button class="tab-btn" onclick="openTab('stok')">Stok Akhir</button>
        </div>

        <div id="penjualan" class="tab-content active">
          <h3>Laporan Penjualan</h3>
          <div class="flex" style="gap:8px;align-items:center;margin-bottom:8px">
            <label class="muted">From <input id="filterFrom" type="date" /></label>
            <label class="muted">To <input id="filterTo" type="date" /></label>
            <button class="small" onclick="loadSales()">Tampilkan</button>
            <button class="small ghost" onclick="exportSales()">Export CSV</button>
            <button class="small ghost" onclick="printSales()">Cetak</button>
            <button class="small ghost" onclick="clearSales()" title="Hapus laporan">Clear</button>
          </div>
          <div class="table-wrapper" style="max-height:200px">
            <table id="salesTbl"><thead><tr><th>No</th><th>Tanggal</th><th>Invoice</th><th>Item</th><th>Total</th></tr></thead><tbody></tbody></table>
          </div>
        </div>

        <div id="restock" class="tab-content">
          <h3>Laporan Restock</h3>
          <div style="margin-bottom:8px">
            <button class="small" onclick="loadRestock()">Tampilkan</button>
            <button class="small ghost" onclick="exportRestock()">Export CSV</button>
          </div>
          <div class="table-wrapper" style="max-height:200px">
            <table id="restockTbl"><thead><tr><th>No</th><th>Tanggal</th><th>SKU</th><th>Nama</th><th>Jumlah</th><th>Stok Akhir</th></tr></thead><tbody></tbody></table>
          </div>
        </div>

        <div id="stok" class="tab-content">
          <h3>Stok Akhir Produk</h3>
          <div class="table-wrapper" style="max-height:200px">
            <table id="finalStockTbl"><thead><tr><th>No</th><th>SKU</th><th>Nama</th><th>Stok</th><th>Harga</th></tr></thead><tbody></tbody></table>
          </div>
        </div>
      </div>

      <!-- Produk -->
      <div class="card">
        <h3 style="margin-top:0">Tambah / Edit Produk</h3>
        <form id="formProduct" onsubmit="submitProduct();return false">
          <div class="row">
            <div class="col">
              <label class="muted">Kode Barang / SKU</label>
              <div style="display:flex;gap:6px">
                <input id="sku" placeholder="Kode Barang" type="text" required pattern="\d*" />
                <button type="button" class="small" onclick="scanSku()" title="Scan">Scan</button>
              </div>
            </div>
            <div class="col">
              <label class="muted">Nama Produk</label>
              <input id="name" placeholder="Nama Produk" type="text" required />
            </div>
          </div>
          <div class="row">
            <div class="col">
              <label class="muted">Harga Jual (Rp)</label>
              <input id="price" placeholder="Harga" type="number" required />
            </div>
            <div class="col">
              <label class="muted">Stok (angka)</label>
              <input id="qty" placeholder="Stok" type="number" required />
            </div>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <button type="submit">Tambah</button>
            <button type="button" class="ghost" onclick="resetForm()">Reset</button>
            <div class="muted" style="margin-left:auto">Jika nama sama, stok akan <strong>dijumlah</strong>.</div>
          </div>
        </form>

        <h3 style="margin-top:18px">Restock</h3>
        <form id="formRestock" onsubmit="restockProduct();return false" style="display:flex;gap:8px;align-items:center">
          <select id="restockName"><option value="">Pilih Produk...</option></select>
          <input id="restockQty" placeholder="Jumlah" type="number" />
          <button type="submit">Tambah Stok</button>
        </form>

        <h3 style="margin-top:18px">Daftar Produk</h3>
        <input id="search" placeholder="Cari produk (Kode/Nama)..." oninput="render()" style="width:100%;padding:8px;border-radius:10px;border:1px solid #e8eef8;margin-bottom:10px" />
        <div class="table-wrapper" style="max-height:300px">
          <table id="tbl"><thead><tr><th>SKU</th><th>Nama</th><th>Stok</th><th>Harga</th><th>Aksi</th></tr></thead><tbody></tbody></table>
        </div>
      </div>

      <!-- Keranjang & Scan -->
      <div class="card">
        <h3 style="margin-top:0">Keranjang (<span id="cartCount2">0</span>)</h3>
        <div id="cart"><i class="muted">Keranjang kosong</i></div>
        <div style="margin-top:10px;display:flex;flex-direction:column;gap:8px">
          <div class="note">Total: <strong id="total">Rp 0</strong></div>

          <div>
            <label><input type="checkbox" id="autoPrint" /> Cetak struk otomatis</label>
            <div class="printer-row" style="margin-top:6px">
              <select id="printerSelect" style="flex:1"><option value="">Pilih printer (label saja)</option><option value="Printer Lokal">Printer Lokal</option><option value="Printer Bluetooth">Printer Bluetooth</option><option value="Printer Jaringan">Printer Jaringan</option></select>
              <button class="small ghost" onclick="savePrinterPreference()">Simpan</button>
            </div>
            <div class="info-small">Cetak otomatis = akan berusaha membuka print saat finalisasi. Pilihan printer disimpan sebagai preferensi UI saja.</div>
          </div>

          <div style="display:flex;gap:8px;margin-top:6px">
            <button id="checkoutBtn" onclick="checkout()" disabled>Bayar</button>
            <button class="ghost" onclick="clearCart()">Kosongkan</button>
          </div>

          <div style="margin-top:12px">
            <h4 style="margin:6px 0 6px 0">Scan Produk</h4>
            <div style="display:flex;gap:8px;align-items:center">
              <button class="small" id="btnStartScan" onclick="startScan('sell')">Mulai Scan Jual</button>
              <button class="small ghost" onclick="stopScan()">Stop Scan</button>
              <div style="margin-left:auto">
                <label class="muted">Mode:
                  <select id="scanMode" style="margin-left:6px">
                    <option value="single">1x auto-stop</option>
                    <option value="continuous">Multi-scan</option>
                  </select>
                </label>
              </div>
            </div>
            <div style="margin-top:8px"><label><input type="checkbox" id="autoSell" /> <span class="muted">Auto-sell on scan</span></label></div>
          </div>
        </div>
      </div>

    </div>
  </main>

  <!-- camera modal -->
  <div id="cameraModal">
    <div style="background:#fff;border-radius:10px;padding:18px;max-width:420px;width:94%;box-shadow:0 8px 30px rgba(0,0,0,0.2)">
      <h3 style="margin:0 0 8px 0">ðŸ“· Scan Barcode</h3>
      <div id="cameraReader" style="width:100%;background:#000;min-height:240px;border-radius:8px;overflow:hidden"></div>
      <div style="display:flex;justify-content:flex-end;margin-top:10px"><button class="ghost small" onclick="closeCamera()">Tutup</button></div>
    </div>
  </div>

  <!-- guide overlay initial -->
  <div id="guideOverlay" style="display:none">
    <div id="guideBox">
      <h3>Selamat Datang di POS Toko</h3>
      <p>Klik "Mulai Panduan" untuk tutorial singkat fitur utama.</p>
      <div style="display:flex;justify-content:center;gap:8px">
        <button onclick="startGuide()" style="min-width:100px">Mulai</button>
        <button class="ghost" onclick="endGuide()">Skip</button>
      </div>
    </div>
  </div>

  <!-- payment modal -->
  <div id="paymentModal">
    <div class="box">
      <h3 style="margin-top:0">Pembayaran</h3>
      <div id="pmTop" class="muted" style="margin-bottom:8px">Pilih metode pembayaran.</div>
      <div id="paymentMethods" style="display:flex;gap:8px;margin-bottom:8px">
        <div class="pm-btn" onclick="selectPaymentMethod('cash', this)" data-method="cash">Tunai</div>
        <div class="pm-btn" onclick="selectPaymentMethod('transfer', this)" data-method="transfer">Transfer</div>
        <div class="pm-btn" onclick="selectPaymentMethod('card', this)" data-method="card">Kartu</div>
        <div class="pm-btn" onclick="selectPaymentMethod('qris', this)" data-method="qris">QRIS</div>
      </div>
      <div id="paymentInfoBox" class="pay-instr">Total: <strong id="payTotal">Rp 0</strong></div>
      <div style="display:flex;gap:8px">
        <button id="confirmPayBtn" onclick="confirmPayment()">Konfirmasi Pembayaran</button>
        <button class="ghost" onclick="closePaymentModal()">Batal</button>
      </div>
      <div id="payDebug" class="muted" style="margin-top:8px"></div>
    </div>
  </div>

  <div id="receiptTemplate" style="display:none"><div id="receiptArea"></div></div>

<script>
/* --------------------------
  IndexedDB wrapper (simple)
   - DB name: indocart_db
   - objectStores: products, sales, restocks, meta
---------------------------*/
const DB_NAME = 'indocart_db_v1';
const DB_VERSION = 1;
let db;

function openDB(){
  return new Promise((resolve, reject) => {
    if(db) return resolve(db);
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onupgradeneeded = (e) => {
      const d = e.target.result;
      if(!d.objectStoreNames.contains('products')) d.createObjectStore('products', { keyPath: 'sku' });
      if(!d.objectStoreNames.contains('sales')) d.createObjectStore('sales', { keyPath: 'invoice' });
      if(!d.objectStoreNames.contains('restocks')) d.createObjectStore('restocks', { keyPath: 'id', autoIncrement: true });
      if(!d.objectStoreNames.contains('meta')) d.createObjectStore('meta', { keyPath: 'key' });
    };
    req.onsuccess = (e) => { db = e.target.result; resolve(db); };
    req.onerror = (e) => reject(e.target.error);
  });
}

function idbPut(store, value){
  return openDB().then(d=>{
    return new Promise((res,rej)=>{
      const tx = d.transaction(store, 'readwrite');
      const s = tx.objectStore(store);
      const r = s.put(value);
      r.onsuccess = ()=>res(r.result);
      r.onerror = ()=>rej(r.error);
    });
  });
}
function idbGetAll(store){
  return openDB().then(d=>{
    return new Promise((res,rej)=>{
      const tx = d.transaction(store,'readonly');
      const s = tx.objectStore(store);
      const r = s.getAll();
      r.onsuccess = ()=>res(r.result);
      r.onerror = ()=>rej(r.error);
    });
  });
}
function idbGet(store, key){
  return openDB().then(d=>{
    return new Promise((res,rej)=>{
      const tx = d.transaction(store,'readonly');
      const s = tx.objectStore(store);
      const r = s.get(key);
      r.onsuccess = ()=>res(r.result);
      r.onerror = ()=>rej(r.error);
    });
  });
}
function idbDelete(store, key){
  return openDB().then(d=>{
    return new Promise((res,rej)=>{
      const tx = d.transaction(store,'readwrite');
      const s = tx.objectStore(store);
      const r = s.delete(key);
      r.onsuccess = ()=>res();
      r.onerror = ()=>rej(r.error);
    });
  });
}

/* ---------- in-memory caches (will reflect IDB) ---------- */
let products = [];
let sales = [];
let restocks = [];
let cart = [];

let pendingPaidInvoice = null;
let selectedPaymentMethod = null;

/* ---------- utils ---------- */
function getLocalDateTime(){
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  const hh = String(d.getHours()).padStart(2,'0');
  const mi = String(d.getMinutes()).padStart(2,'0');
  const ss = String(d.getSeconds()).padStart(2,'0');
  return `${yyyy}-${mm}-${dd} ${hh}:${mi}:${ss}`;
}

/* ---------- MIGRATE from localStorage if any (one-time) ---------- */
async function migrateFromLocalStorage(){
  try{
    const lsProducts = JSON.parse(localStorage.getItem('products')||'[]');
    const lsSales = JSON.parse(localStorage.getItem('sales')||'[]');
    const lsRestocks = JSON.parse(localStorage.getItem('restocks')||'[]');
    const lsPending = localStorage.getItem('pendingPaidInvoice') || null;
    if((lsProducts && lsProducts.length) || (lsSales && lsSales.length) || (lsRestocks && lsRestocks.length)){
      // If DB empty, move data
      const existing = await idbGetAll('products');
      if(existing.length === 0){
        for(const p of lsProducts) await idbPut('products', p);
        for(const r of lsRestocks) await idbPut('restocks', r);
        for(const s of lsSales) await idbPut('sales', s);
        if(lsPending) await idbPut('meta', { key: 'pendingPaidInvoice', value: lsPending });
        console.info('Migrated data from localStorage to IndexedDB');
      }
      // do NOT automatically clear localStorage (safer) - leave to user/dev
    }
  }catch(e){
    console.warn('Migration failed', e);
  }
}

/* ---------- IDB load all ---------- */
async function loadAllFromDB(){
  products = await idbGetAll('products') || [];
  sales = await idbGetAll('sales') || [];
  restocks = await idbGetAll('restocks') || [];
  const metaPending = await idbGet('meta', 'pendingPaidInvoice');
  pendingPaidInvoice = (metaPending && metaPending.value) ? metaPending.value : null;
}

/* ---------- render helpers ---------- */
function render(){
  const tbl = document.querySelector('#tbl tbody');
  const q = document.getElementById('search').value.toLowerCase();
  tbl.innerHTML = '';
  for(const p of products){
    if(p.name.toLowerCase().includes(q) || String(p.sku).includes(q)){
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${p.sku}</td><td>${p.name}</td><td>${p.qty}</td><td>Rp ${Number(p.price).toLocaleString()}</td>
        <td class="actions">
          <button class="small" onclick="editProduct('${p.sku}')">Edit</button>
          <button class="small ghost" onclick="deleteProduct('${p.sku}')">Hapus</button>
        </td>`;
      tbl.appendChild(tr);
    }
  }
  updateRestockDropdown();
  renderFinalStock();
}

/* ---------- Product CRUD (use IDB) ---------- */
async function submitProduct(){
  const sku = document.getElementById('sku').value.trim();
  const name = document.getElementById('name').value.trim();
  const price = parseInt(document.getElementById('price').value);
  const qty = parseInt(document.getElementById('qty').value);
  if(!sku || !name || !price || !qty) return alert('Lengkapi data!');
  const exist = products.find(p=>p.sku===sku);
  if(exist){
    exist.qty = (exist.qty||0) + qty;
    exist.price = price;
    await idbPut('products', exist);
  } else {
    const obj = { sku, name, price, qty };
    products.push(obj);
    await idbPut('products', obj);
  }
  await reloadProducts();
  resetForm();
  alert('Berhasil disimpan!');
}

function resetForm(){
  document.getElementById('sku').value='';
  document.getElementById('name').value='';
  document.getElementById('price').value='';
  document.getElementById('qty').value='';
}

function editProduct(sku){
  const p = products.find(x=>x.sku===sku);
  if(!p) return;
  document.getElementById('sku').value = p.sku;
  document.getElementById('name').value = p.name;
  document.getElementById('price').value = p.price;
  document.getElementById('qty').value = p.qty;
}

async function deleteProduct(sku){
  if(!confirm('Hapus produk ini?')) return;
  await idbDelete('products', sku);
  await reloadProducts();
}

/* ---------- restock ---------- */
async function restockProduct(){
  const sku = document.getElementById('restockName').value;
  const qty = parseInt(document.getElementById('restockQty').value);
  if(!sku || !qty) return alert('Pilih produk & jumlah!');
  const p = products.find(x=>x.sku===sku);
  if(!p) return alert('Produk tidak ditemukan');
  p.qty = (p.qty||0) + qty;
  await idbPut('products', p);
  const rec = { date: getLocalDateTime(), sku: p.sku, name: p.name, qty, stockAfter: p.qty };
  await idbPut('restocks', rec);
  await reloadProducts();
  document.getElementById('restockQty').value='';
}

/* ---------- CART & checkout ---------- */
function addToCart(sku){
  const p = products.find(x=>x.sku===sku);
  if(!p) return alert('Produk tidak ditemukan');
  const item = cart.find(c=>c.sku===sku);
  if(item){
    if(item.qty >= p.qty) return alert('Stok tidak cukup');
    item.qty++;
  } else {
    cart.push({ sku:p.sku, name:p.name, price:p.price, qty:1 });
  }
  renderCart();
}

function renderCart(){
  const el = document.getElementById('cart');
  const c1 = document.getElementById('cartCount');
  const c2 = document.getElementById('cartCount2');
  const checkoutBtn = document.getElementById('checkoutBtn');
  if(cart.length === 0){
    el.innerHTML = '<i class="muted">Keranjang kosong</i>';
    c1.textContent = '0'; c2.textContent = '0';
    checkoutBtn.disabled = true;
    document.getElementById('total').textContent = 'Rp 0';
    return;
  }
  let html = "<table style='width:100%'>";
  let total = 0;
  cart.forEach(c=>{
    total += c.price * c.qty;
    html += `<tr><td style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${c.name} <span style="color:#6b7280">x${c.qty}</span></td><td style="text-align:right">Rp ${(c.price*c.qty).toLocaleString()}</td><td style="text-align:center"><button class="small ghost" onclick="removeFromCart('${c.sku}')">-</button></td></tr>`;
  });
  html += '</table>';
  el.innerHTML = html;
  c1.textContent = cart.length; c2.textContent = cart.length;
  checkoutBtn.disabled = false;
  document.getElementById('total').textContent = 'Rp ' + total.toLocaleString();
  document.getElementById('checkoutBtn').textContent = pendingPaidInvoice ? 'Selesaikan Penjualan' : 'Bayar';
}

function removeFromCart(sku){ cart = cart.filter(c=>c.sku!==sku); renderCart(); }
function clearCart(){ cart = []; pendingPaidInvoice = null; idbPut('meta', { key:'pendingPaidInvoice', value: null }).catch(()=>{}); renderCart(); }

/* ---------- printer pref UI (label only) ---------- */
function loadPrinterPreference(){
  idbGet('meta','preferredPrinter').then(m=>{
    if(m && m.value){
      const sel = document.getElementById('printerSelect');
      sel.value = m.value;
    }
  });
}
function savePrinterPreference(){
  const sel = document.getElementById('printerSelect');
  const val = sel.value || '';
  idbPut('meta', { key:'preferredPrinter', value: val });
  alert(val ? 'Preferensi printer disimpan: ' + val : 'Preferensi printer dikosongkan');
}

/* ---------- payment flow ---------- */
function checkout(){
  if(pendingPaidInvoice){
    finishSale(pendingPaidInvoice);
    return;
  }
  if(cart.length === 0) return alert('Keranjang kosong');
  openPaymentModal();
}

function openPaymentModal(){
  selectedPaymentMethod = null;
  document.querySelectorAll('.pm-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('payDebug').textContent = '';
  const total = cart.reduce((s,i)=>s + i.price*i.qty, 0);
  document.getElementById('payTotal').textContent = 'Rp ' + total.toLocaleString();
  document.getElementById('paymentModal').style.display = 'flex';
}

function closePaymentModal(){ document.getElementById('paymentModal').style.display = 'none'; selectedPaymentMethod = null; }
function selectPaymentMethod(method, el){
  selectedPaymentMethod = method;
  document.querySelectorAll('.pm-btn').forEach(b=>b.classList.remove('active'));
  if(el) el.classList.add('active');
  let info = '';
  if(method==='cash') info='Tunai';
  if(method==='transfer') info='Transfer Bank';
  if(method==='card') info='Kartu';
  if(method==='qris') info='QRIS';
  document.getElementById('paymentInfoBox').innerHTML = `<div class="pay-instr">${info}</div><div>Total: <strong id="payTotal">Rp ${cart.reduce((s,i)=>s+i.price*i.qty,0).toLocaleString()}</strong></div>`;
}

function confirmPayment(){
  if(!selectedPaymentMethod) return alert('Pilih metode pembayaran dulu');
  const btn = document.getElementById('confirmPayBtn');
  btn.disabled = true; btn.textContent = 'Memproses...';
  setTimeout(async ()=>{
    const invoice = 'INV' + Date.now();
    const now = new Date();
    const date = now.toISOString();
    const dateDisplay = now.toLocaleString();
    const total = cart.reduce((s,i)=>s + i.price*i.qty, 0);
    const tx = { invoice, date, dateDisplay, items: JSON.parse(JSON.stringify(cart)), total, method:selectedPaymentMethod, status:'paid', finalized:false };
    await idbPut('sales', tx);
    sales.push(tx);
    pendingPaidInvoice = invoice;
    await idbPut('meta', { key:'pendingPaidInvoice', value: invoice });
    btn.disabled = false; btn.textContent = 'Konfirmasi Pembayaran';
    closePaymentModal();
    renderCart();
    alert('Pembayaran dicatat. Invoice: ' + invoice + '. Tekan "Selesaikan Penjualan" untuk finalisasi & cetak.');
  }, 700);
}

/* finishSale: commit stok, mark sale completed, then prompt print (always asks) */
async function finishSale(invoice){
  const tx = (await idbGet('sales', invoice));
  if(!tx) return alert('Transaksi tidak ditemukan');
  if(tx.finalized){
    alert('Transaksi sudah diselesaikan: ' + invoice);
    pendingPaidInvoice = null;
    await idbPut('meta', { key:'pendingPaidInvoice', value: null });
    renderCart(); await reloadProducts(); renderFinalStock();
    return;
  }
  // reduce stock
  for(const it of tx.items){
    const p = products.find(x=>x.sku===it.sku);
    if(p){
      p.qty = Math.max(0, (p.qty||0) - it.qty);
      await idbPut('products', p);
    }
  }
  tx.status = 'completed';
  tx.finalized = true;
  tx.completedAt = getLocalDateTime();
  await idbPut('sales', tx);

  // auto-print behavior:
  const autoChecked = document.getElementById('autoPrint').checked;
  const preferred = (await idbGet('meta','preferredPrinter'))?.value || '';
  // NOTE: browsers don't allow selecting physical printer from script. We will always ASK to print here.
  // If autoChecked and preferred empty => warn user but still offer print.
  if(autoChecked && !preferred){
    alert('Cetak otomatis aktif tetapi tidak ada preferensi printer disimpan. Dialog print akan muncul, pilih printer yang terhubung.');
  }

  const doPrint = confirm('Penjualan selesai. Mau cetak struk sekarang?');
  if(doPrint) printReceipt(tx);

  // clear pending and cart
  pendingPaidInvoice = null;
  await idbPut('meta', { key:'pendingPaidInvoice', value: null });
  cart = [];
  await reloadProducts();
  renderCart();
  renderFinalStock();
  alert('Penjualan selesai. Invoice: ' + invoice);
}

/* ---------- print receipt ---------- */
function printReceipt(t){
  let html = `<div style="font-family:Arial,Helvetica,sans-serif;font-size:12px;padding:8px">`;
  html += `<h3 style="margin:4px 0">Struk Pembelian</h3>`;
  html += `<div>Invoice: ${t.invoice}</div>`;
  html += `<div>Tanggal: ${t.dateDisplay || t.date || getLocalDateTime()}</div>`;
  html += `<div>Metode: ${t.method || '-'}</div>`;
  html += `<hr/>`;
  html += `<table style="width:100%;border-collapse:collapse;font-size:12px">`;
  html += `<tr><th align="left">Nama</th><th>Qty</th><th align="right">Subtotal</th></tr>`;
  for(const i of t.items){
    html += `<tr><td>${i.name}</td><td style="text-align:center">${i.qty}</td><td style="text-align:right">Rp ${(i.price*i.qty).toLocaleString()}</td></tr>`;
  }
  html += `</table><hr/>`;
  html += `<h4 style="text-align:right;margin:6px 0">Total: Rp ${t.total.toLocaleString()}</h4>`;
  html += `</div>`;

  const w = window.open('','_blank','width=400,height=600');
  if(!w) { alert('Popup diblokir. Izinkan popup atau cetak manual dari daftar penjualan.'); return; }
  w.document.write(html);
  w.document.close();
  w.focus();
  try{
    w.print();
    setTimeout(()=>{ try{ w.close(); }catch(e){} }, 1000);
  }catch(e){
    try{ w.close(); }catch(e){}
    console.error(e);
  }
}

/* ---------- scan camera (html5-qrcode used if available) ---------- */
let html5QrcodeScanner = null;
let scanTarget = null;

function openCamera(target){
  scanTarget = target;
  const camModal = document.getElementById('cameraModal');
  camModal.style.display = 'flex';
  if(window.Html5Qrcode){
    if(html5QrcodeScanner) return;
    html5QrcodeScanner = new Html5Qrcode('cameraReader');
    const config = { fps: 10, qrbox: 250 };
    html5QrcodeScanner.start({ facingMode: "environment" }, config, msg=>{
      handleScan(msg);
      if(document.getElementById('scanMode')?.value === 'single') stopCamera();
    }).catch(err=>{
      console.error(err);
      alert('Gagal akses kamera: ' + err);
    });
  } else {
    // fallback: just show camera modal and allow manual input
    document.getElementById('cameraReader').innerHTML = '<div style="padding:18px;color:#fff">Camera library tidak ditemukan. Masukkan kode secara manual di field SKU.</div>';
  }
}

function stopCamera(){
  if(html5QrcodeScanner){
    html5QrcodeScanner.stop().catch(()=>{}).finally(()=>{ html5QrcodeScanner = null; document.getElementById('cameraReader').innerHTML = ''; });
  }
  document.getElementById('cameraModal').style.display = 'none';
}
function closeCamera(){ stopCamera(); }
function handleScan(msg){
  if(scanTarget === 'sell' || document.getElementById('autoSell')?.checked){
    addToCart(msg);
  } else {
    document.getElementById('sku').value = msg;
    alert('Kode terdeteksi: ' + msg);
  }
}
function scanSku(){ openCamera('sku'); }
function startScan(target){ openCamera(target); }
function stopScan(){ stopCamera(); }

/* ---------- REPORTS & CSV ---------- */
function loadSales(){
  const from = document.getElementById('filterFrom').value;
  const to = document.getElementById('filterTo').value;
  const tbody = document.querySelector('#salesTbl tbody');
  tbody.innerHTML = '';
  let counter = 1;
  for(const s of sales){
    const dObj = new Date(s.date || s.dateDisplay);
    let valid = true;
    if(from && dObj < new Date(from)) valid = false;
    if(to && dObj > new Date(to)) valid = false;
    if(valid){
      const items = (s.items||[]).map(x=>x.name+' x'+x.qty).join(', ');
      const dTxt = s.dateDisplay || (dObj && !isNaN(dObj) ? dObj.toLocaleString() : s.date);
      const tr = `<tr><td>${counter}</td><td>${dTxt}</td><td>${s.invoice}</td><td>${items}</td><td>Rp ${Number(s.total).toLocaleString()}</td></tr>`;
      tbody.innerHTML += tr;
      counter++;
    }
  }
}
async function loadRestock(){
  const tbody = document.querySelector('#restockTbl tbody');
  tbody.innerHTML = '';
  restocks = await idbGetAll('restocks') || restocks;
  restocks.forEach((r,i)=>{
    const d = r.date || '';
    tbody.innerHTML += `<tr><td>${i+1}</td><td>${d}</td><td>${r.sku}</td><td>${r.name}</td><td>${r.qty}</td><td>${r.stockAfter}</td></tr>`;
  });
}
function exportSales(){
  if(!sales || sales.length === 0) return alert('Tidak ada data penjualan');
  let csv = 'No;Tanggal;Invoice;Item;Total\n';
  let c = 1;
  for(const s of sales){
    const d = s.dateDisplay || s.date || '';
    const items = (s.items||[]).map(x=>`${x.name} x${x.qty}`).join(' | ');
    csv += `${c};"${d}";"${s.invoice}";"${items}";"${s.total}"\n`;
    c++;
  }
  downloadCSV(csv, 'laporan_penjualan.csv');
}
function downloadCSV(content, filename){
  const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = filename;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}
function printSales(){ window.print(); }
function exportRestock(){ alert('Export restock belum diimplementasikan (bisa ditambahkan jika perlu)'); }
function clearSales(){
  if(!confirm('Hapus semua laporan penjualan?')) return;
  // delete all sales in IDB
  idbGetAll('sales').then(list=>{
    list.forEach(s=> idbDelete('sales', s.invoice));
  }).then(async ()=>{
    sales = [];
    await idbPut('meta', { key:'pendingPaidInvoice', value:null });
    loadSales();
    alert('Semua laporan penjualan dihapus.');
  });
}

/* ---------- final stock render ---------- */
function renderFinalStock(){
  const tbody = document.querySelector('#finalStockTbl tbody');
  tbody.innerHTML = '';
  let i=1;
  for(const p of products){
    tbody.innerHTML += `<tr><td>${i++}</td><td>${p.sku}</td><td>${p.name}</td><td>${p.qty}</td><td>Rp ${Number(p.price).toLocaleString()}</td></tr>`;
  }
}

/* ---------- utility reloads ---------- */
async function reloadProducts(){
  products = await idbGetAll('products') || [];
  sales = await idbGetAll('sales') || [];
  restocks = await idbGetAll('restocks') || [];
  render();
}

/* ---------- GUIDE (robust & positioned) ---------- */
window.guideSteps = [
  { selector: '#formProduct', text: 'ðŸ§¾ Tambah produk baru di sini. Isi SKU, nama, harga & stok.' },
  { selector: '#formRestock', text: 'ðŸ“¦ Restock produk yang ada.' },
  { selector: '#tbl', text: 'ðŸ“‹ Daftar produk. Edit atau hapus dari sini.' },
  { selector: '#btnStartScan', text: 'ðŸ“¸ Mulai scan untuk menambah ke keranjang.' },
  { selector: '#cart', text: 'ðŸ›’ Keranjang akan menampilkan item yang terpilih.' },
  { selector: '#checkoutBtn', text: 'ðŸ’° Bayar -> konfirmasi -> Selesaikan Penjualan.' }
];
let guideState = { cur:0, highlight:null, tooltip:null };

function createGuideElements(){
  if(!guideState.highlight){
    const el = document.createElement('div'); el.id='highlightBox';
    document.body.appendChild(el); guideState.highlight = el;
  }
  if(!guideState.tooltip){
    const t = document.createElement('div'); t.id='guideTooltip';
    document.body.appendChild(t); guideState.tooltip = t;
  }
}

function showStep(i){
  const steps = window.guideSteps || [];
  if(!steps || steps.length===0) return endGuide();
  if(i<0) i=0;
  if(i>=steps.length) return endGuide();
  guideState.cur = i;
  const step = steps[i];
  const el = document.querySelector(step.selector);
  createGuideElements();
  if(!el){ console.warn('Guide element not found', step.selector); nextGuide(); return; }
  const rect = el.getBoundingClientRect();
  const padding = 8;
  const top = rect.top + window.scrollY - padding;
  const left = rect.left + window.scrollX - padding;
  guideState.highlight.style.top = top + 'px';
  guideState.highlight.style.left = left + 'px';
  guideState.highlight.style.width = (rect.width + padding*2) + 'px';
  guideState.highlight.style.height = (rect.height + padding*2) + 'px';
  guideState.highlight.style.display = 'block';

  const isLast = (i === steps.length -1);
  guideState.tooltip.innerHTML = `<div style="margin-bottom:8px">${step.text || ''}</div>
    <div style="text-align:right"><button id="guideNextBtn" style="background:var(--accent);color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer">${isLast ? 'Selesai' : 'Lanjut âžœ'}</button></div>`;

  // position tooltip intelligently
  const tooltipH = 120;
  const spaceBelow = window.innerHeight - rect.bottom;
  let tooltipTop;
  if(spaceBelow > tooltipH + 24){
    tooltipTop = rect.bottom + window.scrollY + 10;
  } else if(rect.top > tooltipH + 24){
    tooltipTop = rect.top + window.scrollY - tooltipH - 10;
  } else {
    tooltipTop = window.scrollY + (window.innerHeight/2) - (tooltipH/2);
  }
  let leftPos = left;
  if(leftPos + 360 > window.innerWidth + window.scrollX) leftPos = window.innerWidth + window.scrollX - 380;
  if(leftPos < 10) leftPos = 10;
  guideState.tooltip.style.top = tooltipTop + 'px';
  guideState.tooltip.style.left = leftPos + 'px';
  guideState.tooltip.style.display = 'block';
  guideState.tooltip.style.opacity = 0;
  setTimeout(()=> guideState.tooltip.style.opacity = 1, 20);

  try{ el.scrollIntoView({ behavior:'smooth', block:'center' }); }catch(e){}
  document.getElementById('guideNextBtn').onclick = (ev)=>{ ev.preventDefault(); nextGuide(); };
}

function nextGuide(){ showStep(guideState.cur + 1); }

function endGuide(){
  if(guideState.highlight){ guideState.highlight.remove(); guideState.highlight = null; }
  if(guideState.tooltip){ guideState.tooltip.remove(); guideState.tooltip = null; }
  document.getElementById('guideOverlay').style.display = 'none';
  guideState.cur = 0;
  setTimeout(()=>{ /* gentle */ }, 80);
}

function startGuide(){
  document.getElementById('guideOverlay').style.display = 'none';
  guideState.cur = 0;
  createGuideElements();
  showStep(0);
}

/* expose for top button */
window.startGuide = startGuide;
window.endGuide = endGuide;

/* ---------- small helpers at init ---------- */
async function init(){
  await openDB();
  await migrateFromLocalStorage();
  await loadAllFromDB();
  await reloadProducts();
  loadPrinterPreference();
  renderCart();
  renderFinalStock();
  // show guide overlay once
  document.getElementById('guideOverlay').style.display = 'flex';
  // ensure camera modal hidden
  document.getElementById('cameraModal').style.display = 'none';
  // attach some listeners
  document.querySelectorAll('.tab-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{ document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active');});
  });
  // restore pendingPaidInvoice
  const p = await idbGet('meta','pendingPaidInvoice');
  pendingPaidInvoice = (p && p.value) ? p.value : null;
  renderCart();
}

init();
</script>

<!-- optional html5-qrcode (only if online) -->
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</body>
</html>
