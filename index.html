<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>POS Sembako (Kode Barang & Barcode)</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#f6f8fb; --card:#ffffff; --accent:#0b74da; --muted:#6b7280; --shadow:0 6px 20px rgba(11,116,218,0.08);
}
*{box-sizing:border-box;font-family:"Poppins",system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
body{background:var(--bg);margin:0;color:#111}
header{background:linear-gradient(90deg,var(--accent),#0b5fcc);color:#fff;padding:14px 16px;box-shadow:var(--shadow)}
.container{max-width:1100px;margin:18px auto;padding:16px}
h2,h3{margin:6px 0}
.grid{display:grid;grid-template-columns:1fr 360px;gap:18px}
@media(max-width:900px){ .grid{grid-template-columns:1fr} }
.card{background:var(--card);border-radius:12px;padding:14px;box-shadow:var(--shadow);}
form .row{display:flex;gap:8px;margin-bottom:8px}
form .row .col{flex:1}
input[type="text"], input[type="number"], input[type="date"], select{
  width:100%;padding:10px;border:1px solid #e6e9ef;border-radius:8px;outline:none;font-size:14px;
}
input:focus, select:focus{box-shadow:0 0 0 3px rgba(11,116,218,0.08);border-color:var(--accent)}
button{background:var(--accent);color:#fff;padding:8px 10px;border:none;border-radius:8px;cursor:pointer;font-weight:600}
button.ghost{background:transparent;color:var(--accent);border:1px solid rgba(11,116,218,0.12)}
button.small{padding:6px 8px;font-size:13px;border-radius:6px}
button:disabled{opacity:.6;cursor:not-allowed}
.muted{color:var(--muted);font-size:13px}
table{width:100%;border-collapse:collapse;margin-top:10px;font-size:14px}
th,td{padding:8px;border-bottom:1px solid #f0f0f3;text-align:left}
th{font-weight:600;color:#333}
.actions button{margin-right:6px}
#cart{min-height:36px;padding:8px;background:#fafbfd;border:1px dashed #e6eefc;border-radius:8px}
#reader{width:100%;max-width:360px;height:auto;border-radius:8px;overflow:hidden;background:#000}
.tabs{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap;}
.tab-btn{padding:8px 12px;border-radius:8px;background:#f1f5f9;border:none;cursor:pointer;font-weight:600;}
.tab-btn.active{background:var(--accent);color:#fff;}
.flex{display:flex;gap:8px;align-items:center}
.stack{display:flex;flex-direction:column;gap:8px}
.right{text-align:right}
.badge{background:#eef6ff;color:var(--accent);padding:6px 8px;border-radius:999px;font-weight:600}
.note{font-size:13px;color:var(--muted)}
#guideOverlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:flex;justify-content:center;align-items:center;z-index:999;display:none}
#guideBox{background:#fff;padding:20px;border-radius:12px;max-width:400px;text-align:center;box-shadow:0 0 20px rgba(0,0,0,0.2);}
#guideBox button{margin:10px 5px;}
</style>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>
<body>
<header>
  <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
    <h2 style="margin:0">POS Toko Sembako</h2>
    <div style="display:flex;gap:12px;align-items:center">
      <div class="muted">Keranjang: <span id="cartCount">0</span> barang</div>
      <div class="badge" id="shopStatus">Offline</div>
    </div>
  </div>
</header>

<main class="container">
  <div class="grid">
    <div class="card">
      <section>
        <h3>Tambah / Edit Produk</h3>
        <form id="formProduct" onsubmit="submitProduct();return false" style="margin-bottom:6px">
          <div class="row">
            <div class="col">
              <label class="muted">Kode Barang / SKU</label>
              <div style="display:flex;gap:8px">
                <input id="sku" placeholder="Kode Barang" type="text" required pattern="\d*" />
                <button type="button" class="small" onclick="scanSku()" title="Scan Kode Barang">Scan</button>
              </div>
            </div>
            <div class="col">
              <label class="muted">Nama Produk</label>
              <input id="name" placeholder="Nama Produk" type="text" required />
            </div>
          </div>
          <div class="row">
            <div class="col">
              <label class="muted">Harga Jual (Rp)</label>
              <input id="price" placeholder="Harga Jual (Rp)" type="number" required />
            </div>
            <div class="col">
              <label class="muted">Stok (angka)</label>
              <input id="qty" placeholder="Stok (angka)" type="number" required />
            </div>
          </div>
          <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
            <button type="submit" id="formSubmitBtn">Tambah</button>
            <button type="button" class="ghost" onclick="resetForm()">Reset</button>
            <div class="muted" style="margin-left:auto">Jika nama sudah ada, stok akan <strong>dijumlahkan</strong>.</div>
          </div>
        </form>

        <h3 style="margin-top:16px">Restock Produk</h3>
        <form id="formRestock" onsubmit="restockProduct();return false" class="flex" style="gap:8px;align-items:center">
          <select id="restockName" required>
            <option value="">Pilih Produk...</option>
          </select>
          <input id="restockQty" placeholder="Jumlah Restock" type="number" required />
          <button type="submit">Tambah Stok</button>
        </form>

        <h3 style="margin-top:16px">Daftar Produk</h3>
        <input id="search" placeholder="Cari produk (Kode/Nama)..." oninput="render()" style="margin-bottom:10px;width:100%;padding:8px;border-radius:8px;border:1px solid #e8eef8" />
        <div style="overflow:auto;max-height:360px">
          <table id="tbl">
            <thead><tr><th>SKU</th><th>Nama</th><th>Stok</th><th>Harga</th><th>Aksi</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
    </div>

    <div style="display:flex;flex-direction:column;gap:18px">
      <div class="card">
        <h3>Keranjang <small class="muted">(<span id="cartCount2">0</span>)</small></h3>
        <div id="cart"><i class="muted">Keranjang kosong</i></div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
          <div class="note">Total: <strong id="total">Rp 0</strong></div>
          <div>
            <label><input type="checkbox" id="autoPrint" checked /> Cetak struk otomatis</label>
            <button id="checkoutBtn" onclick="checkout()" disabled>Selesaikan Penjualan</button>
            <button class="ghost" onclick="clearCart()">Kosongkan</button>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>Scan Produk</h3>
        <div class="flex" style="margin-bottom:8px">
          <button id="btnStartScan" onclick="startScan('sell')" class="small">Mulai Scan Jual</button>
          <button id="btnStopScan" onclick="stopScan()" class="small ghost">Stop Scan</button>
          <label class="muted" style="margin-left:auto">Mode:
            <select id="scanMode" style="margin-left:6px">
              <option value="single">1x auto-stop</option>
              <option value="continuous">Multi-scan</option>
            </select>
          </label>
        </div>
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
          <label><input type="checkbox" id="autoSell" /> <span class="muted">Auto-sell on scan</span></label>
        </div>
        <div id="reader" style="min-height:160px"></div>
        <div class="muted note" style="margin-top:8px">Gunakan kamera ponsel. Pilih mode single jika ingin berhenti setelah 1 scan.</div>
      </div>

      <div class="card">
        <h2>ðŸ“Š Dashboard Laporan</h2>
        <div class="tabs">
          <button class="tab-btn active" onclick="openTab('penjualan')">Laporan Penjualan</button>
          <button class="tab-btn" onclick="openTab('restock')">Laporan Restock</button>
          <button class="tab-btn" onclick="openTab('stok')">Laporan Stok Akhir</button>
        </div>

        <div id="penjualan" class="tab-content active">
          <h3>Laporan Penjualan</h3>
          <div class="flex" style="gap:8px;flex-wrap:wrap">
            <label class="muted">From <input id="filterFrom" type="date" /></label>
            <label class="muted">To <input id="filterTo" type="date" /></label>
            <button onclick="loadSales()" class="small">Tampilkan</button>
            <button onclick="exportSales()" class="small ghost">Export CSV</button>
            <button onclick="printSales()" class="small ghost">Cetak</button>
          </div>
          <div style="overflow:auto;max-height:160px;margin-top:8px">
            <table id="salesTbl"><thead><tr><th>No</th><th>Tanggal</th><th>Invoice</th><th>Item</th><th>Total</th></tr></thead><tbody></tbody></table>
          </div>
        </div>

        <div id="restock" class="tab-content">
          <h3>Laporan Restock (Barang Masuk)</h3>
          <div class="flex" style="gap:8px;flex-wrap:wrap">
            <button onclick="loadRestock()" class="small">Tampilkan</button>
            <button onclick="exportRestock()" class="small ghost">Export CSV</button>
            <button onclick="printRestock()" class="small ghost">Cetak</button>
          </div>
          <div style="overflow:auto;max-height:160px;margin-top:8px">
            <table id="restockTbl"><thead><tr><th>No</th><th>Tanggal</th><th>SKU</th><th>Nama</th><th>Jumlah</th><th>Stok Akhir</th></tr></thead><tbody></tbody></table>
          </div>
        </div>

        <div id="stok" class="tab-content">
          <h3>Stok Akhir Produk</h3>
          <div style="overflow:auto;max-height:180px">
            <table id="finalStockTbl"><thead><tr><th>No</th><th>SKU</th><th>Nama</th><th>Stok</th><th>Harga</th></tr></thead><tbody></tbody></table>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<div id="guideOverlay">
  <div id="guideBox">
    <h3>Selamat Datang di POS Toko Sembako</h3>
    <p>Klik mulai untuk tutorial singkat semua fitur, atau skip jika sudah hafal.</p>
    <button onclick="startGuide()">Mulai</button>
    <button onclick="skipGuide()">Skip</button>
  </div>
</div>

<script>
let products = JSON.parse(localStorage.getItem('products')||'[]')
let sales = JSON.parse(localStorage.getItem('sales')||'[]')
let restocks = JSON.parse(localStorage.getItem('restocks')||'[]')
let cart = []

function render(){
  const tbl=document.querySelector("#tbl tbody")
  const search=document.querySelector("#search").value.toLowerCase()
  tbl.innerHTML=""
  products.forEach((p,i)=>{
    if(p.name.toLowerCase().includes(search)||p.sku.includes(search)){
      const tr=document.createElement("tr")
      tr.innerHTML=`
        <td>${p.sku}</td>
        <td>${p.name}</td>
        <td>${p.qty}</td>
        <td>Rp ${p.price.toLocaleString()}</td>
        <td class="actions">
          <button class="small" onclick="editProduct('${p.sku}')">Edit</button>
          <button class="small ghost" onclick="deleteProduct('${p.sku}')">Hapus</button>
        </td>`
      tbl.appendChild(tr)
    }
  })
  updateRestockDropdown()
}

function submitProduct(){
  const sku=document.getElementById("sku").value.trim()
  const name=document.getElementById("name").value.trim()
  const price=parseInt(document.getElementById("price").value)
  const qty=parseInt(document.getElementById("qty").value)
  if(!sku || !name || !price || !qty) return alert("Lengkapi data!")
  const exist=products.find(p=>p.sku===sku)
  if(exist){
    exist.qty += qty
    exist.price = price
  }else{
    products.push({sku,name,price,qty})
  }
  localStorage.setItem("products",JSON.stringify(products))
  render(); resetForm()
}

function resetForm(){
  document.getElementById("sku").value=""
  document.getElementById("name").value=""
  document.getElementById("price").value=""
  document.getElementById("qty").value=""
  document.getElementById("formSubmitBtn").textContent="Tambah"
}

function editProduct(sku){
  const p=products.find(x=>x.sku===sku)
  if(!p) return
  document.getElementById("sku").value=p.sku
  document.getElementById("name").value=p.name
  document.getElementById("price").value=p.price
  document.getElementById("qty").value=p.qty
  document.getElementById("formSubmitBtn").textContent="Update"
}

function deleteProduct(sku){
  if(!confirm("Hapus produk ini?")) return
  products=products.filter(p=>p.sku!==sku)
  localStorage.setItem("products",JSON.stringify(products))
  render()
}

function updateRestockDropdown(){
  const sel=document.getElementById("restockName")
  sel.innerHTML='<option value="">Pilih Produk...</option>'
  products.forEach(p=>{
    const opt=document.createElement("option")
    opt.value=p.sku; opt.textContent=p.name
    sel.appendChild(opt)
  })
}

function restockProduct(){
  const sku=document.getElementById("restockName").value
  const qty=parseInt(document.getElementById("restockQty").value)
  if(!sku||!qty) return alert("Pilih produk & jumlah!")
  const p=products.find(x=>x.sku===sku)
  if(!p) return alert("Produk tidak ditemukan")

  p.qty+=qty
  localStorage.setItem("products",JSON.stringify(products))

  restocks.push({
    date:new Date().toLocaleString(), // pakai lokal
    sku:p.sku,
    name:p.name,
    qty,
    stockAfter:p.qty
  })
  localStorage.setItem("restocks",JSON.stringify(restocks))

  render(); document.getElementById("restockQty").value=""
}

// CART & CHECKOUT
function addToCart(sku){
  const p=products.find(x=>x.sku===sku)
  if(!p) return alert("Produk tidak ditemukan")
  const cartItem=cart.find(c=>c.sku===sku)
  if(cartItem){
    if(cartItem.qty>=p.qty) return alert("Stok tidak cukup")
    cartItem.qty+=1
  }else{
    cart.push({sku:p.sku,name:p.name,price:p.price,qty:1})
  }
  renderCart()
}

function renderCart(){
  const el=document.getElementById("cart")
  const count=document.getElementById("cartCount")
  const count2=document.getElementById("cartCount2")
  const checkoutBtn=document.getElementById("checkoutBtn")
  if(cart.length===0){
    el.innerHTML='<i class="muted">Keranjang kosong</i>';count.textContent="0";count2.textContent="0"; checkoutBtn.disabled=true;document.getElementById("total").textContent="Rp 0"; return
  }
  let html="<table style='width:100%'>", total=0
  cart.forEach((c,i)=>{
    total+=c.price*c.qty
    html+=`<tr>
      <td>${c.name} x${c.qty}</td>
      <td class="right">Rp ${(c.price*c.qty).toLocaleString()}</td>
      <td class="actions"><button class="small" onclick="removeFromCart('${c.sku}')">-</button></td>
    </tr>`
  })
  html+="</table>"
  el.innerHTML=html
  count.textContent=cart.length
  count2.textContent=cart.length
  checkoutBtn.disabled=false
  document.getElementById("total").textContent="Rp "+total.toLocaleString()
}

function removeFromCart(sku){cart=cart.filter(c=>c.sku!==sku); renderCart()}
function clearCart(){cart=[]; renderCart()}

function checkout(){
  if(cart.length===0) return alert("Keranjang kosong")
  const invoice="INV"+Date.now()
  const date=new Date().toLocaleString() // pakai lokal

  let total=0
  cart.forEach(c=>{
    total+=c.price*c.qty
    const p=products.find(x=>x.sku===c.sku)
    if(p) p.qty-=c.qty
  })

  const transaction={invoice,date,items:[...cart],total}
  sales.push(transaction)
  localStorage.setItem("sales",JSON.stringify(sales))
  localStorage.setItem("products",JSON.stringify(products))

  if(document.getElementById("autoPrint").checked) printReceipt(transaction)

  cart=[]
  renderCart(); render(); renderFinalStock()
  alert("Transaksi berhasil! Invoice: "+invoice)
}

function printReceipt(t){
  let html=`<h2>Struk Pembelian</h2><p>Invoice: ${t.invoice}</p><p>Tanggal: ${new Date(t.date).toLocaleString()}</p><table style="width:100%;border-collapse:collapse;">`
  html+=`<tr><th>Nama</th><th>Qty</th><th>Subtotal</th></tr>`
  t.items.forEach(i=>{
    html+=`<tr><td>${i.name}</td><td>${i.qty}</td><td>Rp ${(i.price*i.qty).toLocaleString()}</td></tr>`
  })
  html+=`</table><h3>Total: Rp ${t.total.toLocaleString()}</h3>`
  const w=window.open("","Struk","width=400,height=600")
  w.document.write(html)
  w.document.close()
  w.print()
}

// SCAN
let html5QrcodeScanner=null, scanTarget=null
function startScan(target){
  scanTarget=target
  if(html5QrcodeScanner) return
  const reader=document.getElementById("reader")
  html5QrcodeScanner=new Html5Qrcode("reader")
  const config={fps:10, qrbox:250}
  html5QrcodeScanner.start({facingMode:"environment"}, config, qrCodeMessage=>{
    handleScan(qrCodeMessage)
    if(document.getElementById("scanMode").value==="single" && document.getElementById("autoSell").checked) stopScan()
  })
}
function stopScan(){if(html5QrcodeScanner){html5QrcodeScanner.stop();html5QrcodeScanner=null}}
function handleScan(msg){
  if(scanTarget==="sell" || document.getElementById("autoSell").checked){
    addToCart(msg)
  }else{
    document.getElementById("sku").value=msg
    alert("Kode Barang terdeteksi: "+msg)
  }
}
function scanSku(){startScan('sku')}

// TABS
function openTab(id){
  document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"))
  document.querySelectorAll(".tab-content").forEach(c=>c.classList.remove("active"))
  document.querySelector(`[onclick="openTab('${id}')"]`).classList.add("active")
  document.getElementById(id).classList.add("active")
}

// REPORTS
function loadSales(){
  const from=document.getElementById("filterFrom").value
  const to=document.getElementById("filterTo").value
  const tbl=document.querySelector("#salesTbl tbody")
  tbl.innerHTML=""

  sales.forEach((s,i)=>{
    const dObj=new Date(s.date)
    const d=dObj.toLocaleDateString() // tampilkan lokal

    let valid=true
    if(from && dObj < new Date(from)) valid=false
    if(to && dObj > new Date(to)) valid=false

    if(valid){
      tbl.innerHTML+=`
        <tr>
          <td>${i+1}</td>
          <td>${d}</td>
          <td>${s.invoice}</td>
          <td>${s.items.map(x=>x.name+" x"+x.qty).join(", ")}</td>
          <td>Rp ${s.total.toLocaleString()}</td>
        </tr>`
    }
  })
}

function loadRestock(){
  const tbl=document.querySelector("#restockTbl tbody")
  tbl.innerHTML=""

  restocks.forEach((r,i)=>{
    const d=new Date(r.date).toLocaleDateString() // tampilkan lokal
    tbl.innerHTML+=`
      <tr>
        <td>${i+1}</td>
        <td>${d}</td>
        <td>${r.sku}</td>
        <td>${r.name}</td>
        <td>${r.qty}</td>
        <td>${r.stockAfter}</td>
      </tr>`
  })
}

function exportSales(){
  if(sales.length === 0) return alert("Tidak ada data penjualan");

  let csv = "No,Tanggal,Invoice,Item,Total\n";
  sales.forEach((s, i) => {
    const d = new Date(s.date).toISOString().slice(0,10);
    const items = s.items.map(x => `${x.name} x${x.qty}`).join(" | ");
    csv += `${i+1},${d},${s.invoice},"${items}",${s.total}\n`;
  });

  downloadCSV(csv, "laporan_penjualan.csv");
}
function printSales(){window.print()}
function exportRestock(){
  if(restocks.length === 0) return alert("Tidak ada data restock");

  let csv = "No,Tanggal,SKU,Nama,Jumlah,StokAkhir\n";
  restocks.forEach((r, i) => {
    const d = new Date(r.date).toISOString().slice(0,10);
    csv += `${i+1},${d},${r.sku},${r.name},${r.qty},${r.stockAfter}\n`;
  });

  downloadCSV(csv, "laporan_restock.csv");
}
function printRestock(){window.print()}

function downloadCSV(content, filename){
  const blob = new Blob([content], { type: "text/csv;charset=utf-8;" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = filename;
  link.style.display = "none";
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

// final stock
function renderFinalStock(){
  const tbl=document.querySelector("#finalStockTbl tbody")
  tbl.innerHTML=""
  products.forEach((p,i)=>{
    tbl.innerHTML+=`<tr><td>${i+1}</td><td>${p.sku}</td><td>${p.name}</td><td>${p.qty}</td><td>Rp ${p.price.toLocaleString()}</td></tr>`
  })
}

// GUIDE
function startGuide(){alert("Guide: 1. Tambah produk, 2. Restock, 3. Scan, 4. Keranjang, 5. Checkout & cetak"); skipGuide()}
function skipGuide(){document.getElementById("guideOverlay").style.display="none"}

// init
render(); renderFinalStock(); setInterval(renderFinalStock,5000)
document.getElementById("guideOverlay").style.display="flex"
</script>
</body>
</html>
