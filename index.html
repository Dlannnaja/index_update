<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>POS Sembako Mobile-Friendly</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  
  <style>
  :root {
    --bg: #f7f9fc;
    --card: #ffffff;
    --accent: #0b74da;
    --accent-dark: #094fa1;
    --muted: #6b7280;
    --shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    --radius: 10px;
    --font: "Poppins", system-ui, sans-serif;

    /* Ukuran font dan spasi diperhalus */
    --font-size-base: 13px;
    --font-size-small: 11px;
    --spacing-sm: 6px;
    --spacing-md: 10px;
    --spacing-lg: 14px;
  }

  *, *::before, *::after {
    box-sizing: border-box;
  }

  body {
    margin: 0;
    font-family: var(--font);
    background-color: var(--bg);
    color: #111;
    overflow-x: hidden;
    font-size: var(--font-size-base);
  }

  header {
    background: linear-gradient(90deg, var(--accent), var(--accent-dark));
    color: #fff;
    padding: var(--spacing-lg) var(--spacing-md);
    box-shadow: var(--shadow);
  }

  .container {
    max-width: 100%;
    margin: 0 auto;
    padding: var(--spacing-md);
  }

  h2 {
    margin: var(--spacing-md) 0;
    font-size: 1.4rem; /* dikit kecil */
  }
  h3 {
    margin: var(--spacing-md) 0;
    font-size: 1.2rem;
  }

  .grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--spacing-lg);
  }

  @media (min-width: 900px) {
    .grid {
      grid-template-columns: 1fr 360px;
    }
  }

  .card {
    background: var(--card);
    border-radius: var(--radius);
    padding: var(--spacing-lg);
    box-shadow: var(--shadow);
    overflow: hidden;
  }

  .row {
    display: flex;
    gap: var(--spacing-md);
    flex-wrap: wrap;
    margin-bottom: var(--spacing-lg);
  }

  .col {
    flex: 1;
    min-width: 100px; /* dikit lebih kecil supaya muat */
  }

  input[type="text"],
  input[type="number"],
  input[type="date"],
  select {
    width: 100%;
    padding: var(--spacing-sm);
    border: 1px solid #dee2e6;
    border-radius: var(--radius);
    font-size: var(--font-size-base);
    outline: none;
    transition: 0.2s ease;
  }

  input:focus,
  select:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 2px rgba(11, 116, 218, 0.15);
  }

  button {
    background: var(--accent);
    color: #fff;
    padding: var(--spacing-sm) var(--spacing-md);
    border: none;
    border-radius: var(--radius);
    font-weight: 600;
    font-size: var(--font-size-base);
    cursor: pointer;
    transition: background 0.2s ease;
    width: 100%;
    box-sizing: border-box;
  }

  button:hover {
    background: var(--accent-dark);
  }

  button.ghost {
    background: transparent;
    color: var(--accent);
    border: 1px solid rgba(11, 116, 218, 0.2);
  }

  button.small {
    padding: var(--spacing-sm) var(--spacing-md);
    font-size: var(--font-size-small);
  }

  button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .muted {
    color: var(--muted);
    font-size: var(--font-size-small);
  }

  /* ----- default table style (kept) ----- */
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: var(--font-size-base);
    min-width: 100%;
  }

  th, td {
    padding: var(--spacing-sm);
    border-bottom: 1px solid #f1f3f5;
    text-align: left;
    vertical-align: top;
    word-break: break-word;
  }

  th {
    font-weight: 600;
    color: #333;
    background: #f9fbfd;
    font-size: var(--font-size-base);
  }

  .actions button {
    margin-right: var(--spacing-sm);
    width: auto;
  }

  #cart {
    min-height: 36px;
    padding: var(--spacing-sm);
    background: #f1f5fb;
    border: 1px dashed #cce1ff;
    border-radius: var(--radius);
    overflow-x: auto;
  }

  #reader {
    width: 100%;
    max-width: 100%;
    border-radius: var(--radius);
    overflow: hidden;
    background: #000;
    min-height: 200px;
  }

  .tabs {
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-lg);
  }

  .tab-btn {
    padding: var(--spacing-sm) var(--spacing-md);
    background: #f1f5f9;
    border: none;
    border-radius: var(--radius);
    font-weight: 600;
    font-size: var(--font-size-base);
    cursor: pointer;
    flex: 1;
    text-align: center;
  }

  .tab-btn.active {
    background: var(--accent);
    color: #fff;
  }

  .flex {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
    flex-wrap: wrap;
  }

  .stack {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-md);
  }

  .right {
    text-align: right;
    width: 100%;
  }

  .badge {
    background: #eef6ff;
    color: var(--accent);
    padding: var(--spacing-sm) var(--spacing-md);
    border-radius: 999px;
    font-weight: 600;
    font-size: var(--font-size-small);
  }

  .note, .info-small {
    font-size: var(--font-size-small);
    color: var(--muted);
  }

  .printer-row {
    display: flex;
    gap: var(--spacing-md);
    align-items: center;
    margin-top: var(--spacing-sm);
    flex-wrap: wrap;
  }

  .tab-content {
    display: none;
  }

  .tab-content.active {
    display: block;
  }

  #guideOverlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.65);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 999;
  }

  #guideBox {
    background: #fff;
    padding: var(--spacing-lg);
    border-radius: var(--radius);
    max-width: 90%;
    width: 300px;
    box-shadow: var(--shadow);
    text-align: center;
  }

  #guideBox button {
    margin: var(--spacing-sm) var(--spacing-md);
    width: 110px;
    font-size: var(--font-size-small);
  }

  /* ---------- NEW: responsive table wrapper for mobile (Android) ---------- */
  .table-wrapper {
    overflow-x: auto;
    width: 100%;
    -webkit-overflow-scrolling: touch;
  }

  /* Prefer tabel tetap rapi: minimal total width agar kolom tidak terlalu sempit di desktop.
     Untuk mobile, media query menonaktifkan min-width supaya tabel mengikuti lebar layar. */
  .table-wrapper table {
    min-width: 640px;
  }

  @media (max-width: 600px) {
    .table-wrapper table {
      min-width: unset;
    }
    th, td {
      font-size: 12px;
      padding: 6px 8px;
    }
    .actions button {
      padding: 4px 8px;
      font-size: 11px;
    }
  }

  @media (min-width: 600px) {
    body {
      font-size: 14px;
    }
    button {
      width: auto;
    }
  }

  @media (min-width: 900px) {
    body {
      font-size: 15px;
    }
  }
</style>

  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>

<body>
  <header>
    <div style="display:flex;justify-content:space-between;align-items:center;gap:var(--spacing-md);flex-wrap:wrap">
      <h2 style="margin:0;font-size:1.25rem">POS Toko Sembako</h2>
      <div style="display:flex;gap:var(--spacing-md);align-items:center">
        <div class="muted">Keranjang: <span id="cartCount">0</span> barang</div>
        <div class="badge" id="shopStatus">Offline</div>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="grid">

      <!-- Dashboard Laporan -->
      <div class="card">
        <h2 style="font-size:1.5rem; margin-bottom: var(--spacing-md)">ðŸ“Š Dashboard Laporan</h2>
        <div class="tabs">
          <button class="tab-btn active" onclick="openTab('penjualan')">Penjualan</button>
          <button class="tab-btn" onclick="openTab('restock')">Restock</button>
          <button class="tab-btn" onclick="openTab('stok')">Stok Akhir</button>
        </div>

        <div id="penjualan" class="tab-content active">
          <h3>Laporan Penjualan</h3>
          <div class="flex">
            <label class="muted">From <input id="filterFrom" type="date" /></label>
            <label class="muted">To <input id="filterTo" type="date" /></label>
            <button onclick="loadSales()" class="small">Tampilkan</button>
            <button onclick="exportSales()" class="small ghost">Export CSV</button>
            <button onclick="printSales()" class="small ghost">Cetak</button>
            <button onclick="clearSales()" class="small ghost" title="Hapus laporan hari ini">Clear Laporan</button>
          </div>

          <!-- table-wrapper ditambahkan di sini -->
          <div class="table-wrapper" style="max-height:200px; margin-top: var(--spacing-sm)">
            <table id="salesTbl">
              <thead><tr><th>No</th><th>Tanggal</th><th>Invoice</th><th>Item</th><th>Total</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div id="restock" class="tab-content">
          <h3>Laporan Restock (Barang Masuk)</h3>
          <div class="flex">
            <button onclick="loadRestock()" class="small">Tampilkan</button>
            <button onclick="exportRestock()" class="small ghost">Export CSV</button>
            <button onclick="printRestock()" class="small ghost">Cetak</button>
          </div>

          <!-- table-wrapper ditambahkan di sini -->
          <div class="table-wrapper" style="max-height:200px; margin-top: var(--spacing-sm)">
            <table id="restockTbl">
              <thead><tr><th>No</th><th>Tanggal</th><th>SKU</th><th>Nama</th><th>Jumlah</th><th>Stok Akhir</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div id="stok" class="tab-content">
          <h3>Stok Akhir Produk</h3>

          <!-- table-wrapper ditambahkan di sini -->
          <div class="table-wrapper" style="max-height:200px; margin-top: var(--spacing-sm)">
            <table id="finalStockTbl">
              <thead><tr><th>No</th><th>SKU</th><th>Nama</th><th>Stok</th><th>Harga</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Tambah / Edit Produk -->
      <div class="card">
        <section>
          <h3>Tambah / Edit Produk</h3>
          <form id="formProduct" onsubmit="submitProduct();return false" style="margin-bottom: var(--spacing-lg)">
            <div class="row">
              <div class="col">
                <label class="muted">Kode Barang / SKU</label>
                <div style="display:flex;gap:var(--spacing-sm)">
                  <input id="sku" placeholder="Kode Barang" type="text" required pattern="\d*" />
                  <button type="button" class="small" onclick="scanSku()" title="Scan Kode Barang">Scan</button>
                </div>
              </div>
              <div class="col">
                <label class="muted">Nama Produk</label>
                <input id="name" placeholder="Nama Produk" type="text" required />
              </div>
            </div>
            <div class="row">
              <div class="col">
                <label class="muted">Harga Jual (Rp)</label>
                <input id="price" placeholder="Harga Jual (Rp)" type="number" required />
              </div>
              <div class="col">
                <label class="muted">Stok (angka)</label>
                <input id="qty" placeholder="Stok (angka)" type="number" required />
              </div>
            </div>
            <div style="display:flex;gap:var(--spacing-sm);flex-wrap:wrap;align-items:center">
              <button type="submit" id="formSubmitBtn">Tambah</button>
              <button type="button" class="ghost" onclick="resetForm()">Reset</button>
              <div class="muted" style="margin-left: auto; font-size: var(--font-size-small)">
                Jika nama sudah ada, stok akan <strong>dijumlahkan</strong>.
              </div>
            </div>
          </form>

          <h3>Restock Produk</h3>
          <form id="formRestock" onsubmit="restockProduct();return false" class="flex" style="gap:var(--spacing-sm); flex-wrap:wrap; align-items:center">
            <select id="restockName" required>
              <option value="">Pilih Produk...</option>
            </select>
            <input id="restockQty" placeholder="Jumlah Restock" type="number" required />
            <button type="submit">Tambah Stok</button>
          </form>

          <h3>Daftar Produk</h3>
          <input id="search" placeholder="Cari produk (Kode/Nama)..." oninput="render()"
                 style="margin-bottom: var(--spacing-lg); width: 100%; padding: var(--spacing-sm);
                        border-radius: var(--radius); border:1px solid #e8eef8" />
          <div class="table-wrapper" style="max-height: 300px;">
            <table id="tbl">
              <thead><tr><th>SKU</th><th>Nama</th><th>Stok</th><th>Harga</th><th>Aksi</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </section>
      </div>

      <!-- Sisi Kanan: Keranjang dan Scan Produk -->
      <div class="card">
        <h3>Keranjang (<span id="cartCount2">0</span>)</h3>
        <div id="cart"><i class="muted">Keranjang kosong</i></div>
        <div class="flex" style="margin-top: var(--spacing-md); flex-direction: column; gap: var(--spacing-sm)">
          <div class="note">Total: <strong id="total">Rp 0</strong></div>
          <div style="width: 100%">
            <label><input type="checkbox" id="autoPrint" /> Cetak struk otomatis</label>
            <div class="printer-row">
              <select id="printerSelect">
                <option value="">Pilih printer (belum tersimpan)</option>
                <option value="Printer Lokal">Printer Lokal</option>
                <option value="Printer Bluetooth">Printer Bluetooth</option>
                <option value="Printer Jaringan">Printer Jaringan</option>
              </select>
              <button class="small ghost" onclick="savePrinterPreference()">Simpan</button>
            </div>
            <div class="info-small">Jika auto print aktif: pastikan pilih & simpan printer. Jika tidak, proses cetak akan diblokir dan muncul peringatan.</div>
          </div>
          <div style="width: 100%; margin-top: var(--spacing-md)">
            <button id="checkoutBtn" onclick="checkout()" disabled>Selesaikan Penjualan</button>
            <button class="ghost" onclick="clearCart()">Kosongkan</button>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>Scan Produk</h3>
        <div class="flex" style="gap: var(--spacing-sm); flex-wrap: wrap; margin-bottom: var(--spacing-sm)">
          <button id="btnStartScan" onclick="startScan('sell')" class="small">Mulai Scan Jual</button>
          <button id="btnStopScan" onclick="stopScan()" class="small ghost">Stop Scan</button>
          <label class="muted" style="margin-left: auto">Mode:
            <select id="scanMode" style="margin-left: var(--spacing-sm)">
              <option value="single">1x auto-stop</option>
              <option value="continuous">Multi-scan</option>
            </select>
          </label>
        </div>
        <div style="display:flex; gap: var(--spacing-sm); align-items:center; margin-bottom: var(--spacing-sm)">
          <label><input type="checkbox" id="autoSell" /> <span class="muted">Auto-sell on scan</span></label>
        </div>
        <div id="reader"></div>
        <div class="muted note" style="margin-top: var(--spacing-sm)">Gunakan kamera ponsel. Pilih mode single jika ingin berhenti setelah 1 scan.</div>
      </div>
      
    </div>
  </main>

  <div id="guideOverlay">
    <div id="guideBox">
      <h3>Selamat Datang di POS Toko Sembako</h3>
      <p>Klik mulai untuk tutorial singkat semua fitur, atau skip jika sudah hafal.</p>
      <button onclick="startGuide()">Mulai</button>
      <button onclick="skipGuide()">Skip</button>
    </div>
  </div>

  <!-- receipt area template (hidden) -->
  <div id="receiptTemplate" style="display:none">
    <div id="receiptArea"></div>
  </div>
<script>
/* ---------- data ---------- */
let products = JSON.parse(localStorage.getItem('products')||'[]')
let sales = JSON.parse(localStorage.getItem('sales')||'[]')
let restocks = JSON.parse(localStorage.getItem('restocks')||'[]')
let cart = []

/* ---------- utility: reliable local datetime string ---------- */
function getLocalDateTime(){
  const d=new Date();
  const yyyy=d.getFullYear();
  const mm=String(d.getMonth()+1).padStart(2,"0");
  const dd=String(d.getDate()).padStart(2,"0");
  const hh=String(d.getHours()).padStart(2,"0");
  const mi=String(d.getMinutes()).padStart(2,"0");
  const ss=String(d.getSeconds()).padStart(2,"0");
  // format yang mudah di-parse kembali: "YYYY-MM-DD HH:mm:ss"
  return `${yyyy}-${mm}-${dd} ${hh}:${mi}:${ss}`;
}

function parseStoredDate(dStr){
  // dStr diharapkan format "YYYY-MM-DD HH:mm:ss"
  if(!dStr) return null;
  let iso = dStr;
  if(dStr.indexOf(' ') !== -1 && dStr.indexOf('T') === -1){
    iso = dStr.replace(' ', 'T');
  }
  // beberapa fallback: jika masih invalid, coba Date.parse direct
  const d = new Date(iso);
  if(isNaN(d.getTime())){
    // try replace slashes with hyphen
    const alt = dStr.replace(/\//g,'-').replace(' ', 'T');
    const d2 = new Date(alt);
    if(isNaN(d2.getTime())) return null;
    return d2;
  }
  return d;
}

/* ---------- render product list ---------- */
function render(){
  const tbl=document.querySelector("#tbl tbody")
  const search=document.querySelector("#search").value.toLowerCase()
  tbl.innerHTML=""
  products.forEach((p,i)=>{
    if(p.name.toLowerCase().includes(search)||p.sku.includes(search)){
      const tr=document.createElement("tr")
      tr.innerHTML=`
        <td>${p.sku}</td>
        <td>${p.name}</td>
        <td>${p.qty}</td>
        <td>Rp ${p.price.toLocaleString()}</td>
        <td class="actions">
          <button class="small" onclick="editProduct('${p.sku}')">Edit</button>
          <button class="small ghost" onclick="deleteProduct('${p.sku}')">Hapus</button>
        </td>`
      tbl.appendChild(tr)
    }
  })
  updateRestockDropdown()
}

/* ---------- product CRUD ---------- */
function submitProduct(){
  const sku=document.getElementById("sku").value.trim()
  const name=document.getElementById("name").value.trim()
  const price=parseInt(document.getElementById("price").value)
  const qty=parseInt(document.getElementById("qty").value)
  if(!sku || !name || !price || !qty) return alert("Lengkapi data!")
  const exist=products.find(p=>p.sku===sku)
  if(exist){
    exist.qty += qty
    exist.price = price
  }else{
    products.push({sku,name,price,qty})
  }
  localStorage.setItem("products",JSON.stringify(products))
  render(); resetForm()
}

function resetForm(){
  document.getElementById("sku").value=""
  document.getElementById("name").value=""
  document.getElementById("price").value=""
  document.getElementById("qty").value=""
  document.getElementById("formSubmitBtn").textContent="Tambah"
}

function editProduct(sku){
  const p=products.find(x=>x.sku===sku)
  if(!p) return
  document.getElementById("sku").value=p.sku
  document.getElementById("name").value=p.name
  document.getElementById("price").value=p.price
  document.getElementById("qty").value=p.qty
  document.getElementById("formSubmitBtn").textContent="Update"
}

function deleteProduct(sku){
  if(!confirm("Hapus produk ini?")) return
  products=products.filter(p=>p.sku!==sku)
  localStorage.setItem("products",JSON.stringify(products))
  render()
}

function updateRestockDropdown(){
  const sel=document.getElementById("restockName")
  if(!sel) return
  sel.innerHTML='<option value="">Pilih Produk...</option>'
  products.forEach(p=>{
    const opt=document.createElement("option")
    opt.value=p.sku; opt.textContent=p.name
    sel.appendChild(opt)
  })
}

/* ---------- restock (simpan dengan format dapat diparse) ---------- */
function restockProduct(){
  const sku=document.getElementById("restockName").value
  const qty=parseInt(document.getElementById("restockQty").value)
  if(!sku||!qty) return alert("Pilih produk & jumlah!")
  const p=products.find(x=>x.sku===sku)
  if(!p) return alert("Produk tidak ditemukan")

  p.qty+=qty
  localStorage.setItem("products",JSON.stringify(products))

  restocks.push({
    date:getLocalDateTime(), // simpan format "YYYY-MM-DD HH:mm:ss"
    sku:p.sku,
    name:p.name,
    qty,
    stockAfter:p.qty
  })
  localStorage.setItem("restocks",JSON.stringify(restocks))

  render(); document.getElementById("restockQty").value=""
}

/* ---------- CART & CHECKOUT ---------- */
function addToCart(sku){
  const p=products.find(x=>x.sku===sku)
  if(!p) return alert("Produk tidak ditemukan")
  const cartItem=cart.find(c=>c.sku===sku)
  if(cartItem){
    if(cartItem.qty>=p.qty) return alert("Stok tidak cukup")
    cartItem.qty+=1
  }else{
    cart.push({sku:p.sku,name:p.name,price:p.price,qty:1})
  }
  renderCart()
}

function renderCart(){
  const el=document.getElementById("cart")
  const count=document.getElementById("cartCount")
  const count2=document.getElementById("cartCount2")
  const checkoutBtn=document.getElementById("checkoutBtn")
  if(cart.length===0){
    el.innerHTML='<i class="muted">Keranjang kosong</i>';count.textContent="0";count2.textContent="0"; checkoutBtn.disabled=true;document.getElementById("total").textContent="Rp 0"; return
  }
  let html="<table style='width:100%'>", total=0
  cart.forEach((c,i)=>{
    total+=c.price*c.qty
    html+=`<tr>
      <td>${c.name} x${c.qty}</td>
      <td class="right">Rp ${(c.price*c.qty).toLocaleString()}</td>
      <td class="actions"><button class="small" onclick="removeFromCart('${c.sku}')">-</button></td>
    </tr>`
  })
  html+="</table>"
  el.innerHTML=html
  count.textContent=cart.length
  count2.textContent=cart.length
  checkoutBtn.disabled=false
  document.getElementById("total").textContent="Rp "+total.toLocaleString()
}

function removeFromCart(sku){cart=cart.filter(c=>c.sku!==sku); renderCart()}
function clearCart(){cart=[]; renderCart()}

/* ---------- printer preference helpers ---------- */
function loadPrinterPreference(){
  const p = localStorage.getItem('preferredPrinter') || ''
  const sel = document.getElementById('printerSelect')
  if(sel) sel.value = p
}
function savePrinterPreference(){
  const sel = document.getElementById('printerSelect')
  if(!sel) return
  localStorage.setItem('preferredPrinter', sel.value)
  alert(sel.value ? 'Preferensi printer disimpan: ' + sel.value : 'Preferensi printer dikosongkan')
}

/* ---------- checkout with robust date + printer check ---------- */
function checkout(){
  if(cart.length===0) return alert("Keranjang kosong")
  const invoice="INV"+Date.now()

  const now = new Date()
  const date = now.toISOString()                // untuk filter & simpan aman
  const dateDisplay = now.toLocaleString()      // untuk tampilan laporan

  let total=0
  cart.forEach(c=>{
    total+=c.price*c.qty
    const p=products.find(x=>x.sku===c.sku)
    if(p) p.qty-=c.qty
  })

  const transaction={invoice,date,dateDisplay,items:[...cart],total}
  sales.push(transaction)
  localStorage.setItem("sales",JSON.stringify(sales))
  localStorage.setItem("products",JSON.stringify(products))

  // cek auto print & preferensi printer
  const auto = document.getElementById("autoPrint").checked
  const preferred = localStorage.getItem('preferredPrinter') || ''
  if(auto){
    if(!preferred){
      alert("Cetak otomatis aktif tetapi tidak ada printer yang dipilih. Silahkan pilih & simpan printer terlebih dahulu.")
    }else{
      try{
        printReceipt(transaction)
      }catch(e){
        console.error(e)
        alert("Terjadi kesalahan saat mencoba mencetak. Silahkan hubungkan printer terlebih dahulu.")
      }
    }
  }

  cart=[]
  renderCart(); render(); renderFinalStock()
  alert("Transaksi berhasil! Invoice: "+invoice)
}

/* ---------- print receipt (opens print dialog) ---------- */
function printReceipt(t){
  // buat konten struk
  let html = `<div style="font-family:Arial,Helvetica,sans-serif;font-size:12px;padding:8px">`
  html += `<h3 style="margin:4px 0">Struk Pembelian</h3>`
  html += `<div>Invoice: ${t.invoice}</div>`
  html += `<div>Tanggal: ${t.date}</div>`
  html += `<hr/>`
  html += `<table style="width:100%;border-collapse:collapse;font-size:12px">`
  html += `<tr><th align="left">Nama</th><th>Qty</th><th align="right">Subtotal</th></tr>`
  t.items.forEach(i=>{
    html += `<tr><td>${i.name}</td><td style="text-align:center">${i.qty}</td><td style="text-align:right">Rp ${(i.price*i.qty).toLocaleString()}</td></tr>`
  })
  html += `</table><hr/>`
  html += `<h4 style="text-align:right;margin:6px 0">Total: Rp ${t.total.toLocaleString()}</h4>`
  html += `</div>`

  const w = window.open("","_blank","width=400,height=600")
  if(!w) {
    throw new Error("Popup blocked")
  }
  w.document.write(html)
  w.document.close()
  // fokus & print
  w.focus()
  // window.print usually doesn't throw, but wrap in try/catch anyway
  try{
    w.print()
    // don't auto-close â€” some printers need selection; close after small timeout
    setTimeout(()=>{ try{ w.close() }catch(e){} }, 1200)
  }catch(e){
    try{ w.close() }catch(_) {}
    throw e
  }
}

/* ---------- SCAN ---------- */
let html5QrcodeScanner=null, scanTarget=null
function startScan(target){
  scanTarget=target
  if(html5QrcodeScanner) return
  const reader=document.getElementById("reader")
  html5QrcodeScanner=new Html5Qrcode("reader")
  const config={fps:10, qrbox:250}
  html5QrcodeScanner.start({facingMode:"environment"}, config, qrCodeMessage=>{
    handleScan(qrCodeMessage)
    if(document.getElementById("scanMode").value==="single" && document.getElementById("autoSell").checked) stopScan()
  }).catch(err=>{
    console.error(err)
    alert("Gagal mengakses kamera: " + err)
  })
}
function stopScan(){if(html5QrcodeScanner){html5QrcodeScanner.stop().catch(()=>{});html5QrcodeScanner=null}}
function handleScan(msg){
  if(scanTarget==="sell" || document.getElementById("autoSell").checked){
    addToCart(msg)
  }else{
    document.getElementById("sku").value=msg
    alert("Kode Barang terdeteksi: "+msg)
  }
}
function scanSku(){startScan('sku')}

/* ---------- TABS ---------- */
function openTab(id){
  document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"))
  document.querySelectorAll(".tab-content").forEach(c=>c.classList.remove("active"))
  document.querySelector(`[onclick="openTab('${id}')"]`).classList.add("active")
  document.getElementById(id).classList.add("active")
}

/* ---------- REPORTS with robust parsing & date filter ---------- */
function loadSales(){
  const from=document.getElementById("filterFrom").value
  const to=document.getElementById("filterTo").value
  const tbl=document.querySelector("#salesTbl tbody")
  tbl.innerHTML=""

  let counter = 1
  sales.forEach((s)=>{
    const dObj = new Date(s.date)                         // selalu ISO
    const d = s.dateDisplay || dObj.toLocaleString()      // tampilan lokal

    let valid=true
    if(from && dObj < new Date(from)) valid=false
    if(to && dObj > new Date(to)) valid=false

    if(valid){
      tbl.innerHTML+=`
        <tr>
          <td>${counter}</td>
          <td>${d}</td>
          <td>${s.invoice}</td>
          <td>${s.items.map(x=>x.name+" x"+x.qty).join(", ")}</td>
          <td>Rp ${s.total.toLocaleString()}</td>
        </tr>`
      counter++
    }
  })
}

function loadRestock(){
  const tbl=document.querySelector("#restockTbl tbody")
  tbl.innerHTML=""

  restocks.forEach((r,i)=>{
    const dObj = parseStoredDate(r.date)
    const dDisplay = dObj ? dObj.toLocaleDateString('id-ID') : 'Invalid Date'
    tbl.innerHTML+=`
      <tr>
        <td>${i+1}</td>
        <td>${dDisplay}</td>
        <td>${r.sku}</td>
        <td>${r.name}</td>
        <td>${r.qty}</td>
        <td>${r.stockAfter}</td>
      </tr>`
  })
}

/* ---------- CSV export (safely parse date) ---------- */
// helper untuk ambil tanggal CSV
function getCsvDateFromRecord(rec){
  let dObj = null;

  if(rec && rec.date){
    dObj = parseStoredDate(rec.date);
  }
  if((!dObj || isNaN(dObj)) && rec && rec.dateDisplay){
    dObj = parseStoredDate(rec.dateDisplay);
  }

  if(dObj && !isNaN(dObj)){
    // format lengkap: YYYY-MM-DD HH:mm:ss
    const yyyy = dObj.getFullYear();
    const mm = String(dObj.getMonth()+1).padStart(2,"0");
    const dd = String(dObj.getDate()).padStart(2,"0");
    const hh = String(dObj.getHours()).padStart(2,"0");
    const mi = String(dObj.getMinutes()).padStart(2,"0");
    const ss = String(dObj.getSeconds()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd} ${hh}:${mi}:${ss}`;
  }

  return rec.dateDisplay || "";
}

function exportSales(){
  if(sales.length === 0) return alert("Tidak ada data penjualan");

  // pakai titik koma (;) biar aman di Excel / Google Sheets Indonesia
  let csv = "No;Tanggal;Invoice;Item;Total\n";
  let counter = 1;

  sales.forEach((s) => {
    const d = getCsvDateFromRecord(s); // ambil tanggal yang aman
    const items = s.items.map(x => `${x.name} x${x.qty}`).join(" | ");

    // bungkus kolom teks dengan "..." supaya tidak pecah
    csv += `${counter};"${d}";"${s.invoice}";"${items}";"${s.total}"\n`;
    counter++;
  });

  downloadCSV(csv, "laporan_penjualan.csv");
}
function printRestock(){ window.print() }

function downloadCSV(content, filename){
  const blob = new Blob([content], { type: "text/csv;charset=utf-8;" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = filename;
  link.style.display = "none";
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

  function clearSales(){
  if(!confirm("Hapus semua laporan penjualan?")) return;

  // kosongkan seluruh data sales, termasuk data lama dengan format tanggal berbeda
  sales = [];

  // simpan ke localStorage
  localStorage.setItem("sales", JSON.stringify(sales));

  // refresh tabel penjualan
  loadSales();

  alert("Semua laporan penjualan berhasil dihapus.");
}



/* ---------- final stock ---------- */
function renderFinalStock(){
  const tbl=document.querySelector("#finalStockTbl tbody")
  tbl.innerHTML=""
  products.forEach((p,i)=>{
    tbl.innerHTML+=`<tr><td>${i+1}</td><td>${p.sku}</td><td>${p.name}</td><td>${p.qty}</td><td>Rp ${p.price.toLocaleString()}</td></tr>`
  })
}

/* ---------- GUIDE ---------- */
function startGuide(){alert("Guide: 1. Tambah produk, 2. Restock, 3. Scan, 4. Keranjang, 5. Checkout & cetak"); skipGuide()}
function skipGuide(){document.getElementById("guideOverlay").style.display="none"}

/* ---------- INIT ---------- */
/* ---------- INIT ---------- */
function init(){
  // ensure autoPrint is NOT checked on load (safety)
  const autoPrintEl = document.getElementById('autoPrint')
  if(autoPrintEl) autoPrintEl.checked = false

  // load saved printer preference
  loadPrinterPreference()

  // ðŸ”„ migrasi data sales lama biar selalu ada dateDisplay
  let updated = false
  sales.forEach(s => {
    if(s.date && !s.dateDisplay){
      let dObj = new Date(s.date)

      // kalau hasilnya Invalid Date, coba parse manual format lama: DD-MM-YYYY HH:mm:ss
      if(isNaN(dObj)){
        const parts = s.date.split(" ")
        if(parts.length === 2){
          const [d,m,y] = parts[0].split("-")  // DD-MM-YYYY
          const [hh,mm,ss] = parts[1].split(":")
          if(d && m && y){
            dObj = new Date(y, parseInt(m)-1, d, hh||0, mm||0, ss||0)
          }
        }
      }

      // kalau sukses diparse, buat dateDisplay
      if(dObj && !isNaN(dObj)){
        s.dateDisplay = dObj.toLocaleString()
        updated = true
      } else {
        // fallback kalau tetap gagal â†’ pakai string aslinya
        s.dateDisplay = s.date
        updated = true
      }
    }
  })
  if(updated){
    localStorage.setItem("sales", JSON.stringify(sales))
  }

  render(); renderFinalStock(); setInterval(renderFinalStock,5000)
  document.getElementById("guideOverlay").style.display="flex"
}

init()
</script>
</body>
</html>
