<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>INDOCART</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  
  <style>
  :root {
    --bg: #f7f9fc;
    --card: #ffffff;
    --accent: #0b74da;
    --accent-dark: #094fa1;
    --muted: #6b7280;
    --shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    --radius: 10px;
    --font: "Poppins", system-ui, sans-serif;

    /* Ukuran font dan spasi diperhalus */
    --font-size-base: 13px;
    --font-size-small: 11px;
    --spacing-sm: 6px;
    --spacing-md: 10px;
    --spacing-lg: 14px;
  }

  *, *::before, *::after {
    box-sizing: border-box;
  }

  body {
    margin: 0;
    font-family: var(--font);
    background-color: var(--bg);
    color: #111;
    overflow-x: hidden;
    font-size: var(--font-size-base);
  }

  header {
    background: linear-gradient(90deg, var(--accent), var(--accent-dark));
    color: #fff;
    padding: var(--spacing-lg) var(--spacing-md);
    box-shadow: var(--shadow);
  }
    /* --- Keranjang di header --- */
  header .muted {
    color: #ffffff !important;     /* ubah warna jadi putih terang */
    font-weight: 500;              /* sedikit tebal biar jelas */
    text-shadow: 0 1px 2px rgba(0,0,0,0.2); /* efek lembut biar gak silau */
  }
  header #cartCount {
    color: #ffffff;                /* pastikan angka keranjang putih juga */
    font-weight: 600;
  }
    
  .container {
    max-width: 100%;
    margin: 0 auto;
    padding: var(--spacing-md);
  }

  h2 {
    margin: var(--spacing-md) 0;
    font-size: 1.4rem; /* dikit kecil */
  }
  h3 {
    margin: var(--spacing-md) 0;
    font-size: 1.2rem;
  }

  .grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--spacing-lg);
  }

  @media (min-width: 900px) {
    .grid {
      grid-template-columns: 1fr 360px;
    }
  }

  .card {
    background: var(--card);
    border-radius: var(--radius);
    padding: var(--spacing-lg);
    box-shadow: var(--shadow);
    overflow: hidden;
  }

  .row {
    display: flex;
    gap: var(--spacing-md);
    flex-wrap: wrap;
    margin-bottom: var(--spacing-lg);
  }

  .col {
    flex: 1;
    min-width: 100px; /* dikit lebih kecil supaya muat */
  }

  input[type="text"],
  input[type="number"],
  input[type="date"],
  select,
  input[type="month"] {
    width: 100%;
    padding: var(--spacing-sm);
    border: 1px solid #dee2e6;
    border-radius: var(--radius);
    font-size: var(--font-size-base);
    outline: none;
    transition: 0.2s ease;
  }

  input:focus,
  select:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 2px rgba(11, 116, 218, 0.15);
  }

  button {
    background: var(--accent);
    color: #fff;
    padding: var(--spacing-sm) var(--spacing-md);
    border: none;
    border-radius: var(--radius);
    font-weight: 600;
    font-size: var(--font-size-base);
    cursor: pointer;
    transition: background 0.2s ease;
    width: 100%;
    box-sizing: border-box;
  }

  button:hover {
    background: var(--accent-dark);
  }

  button.ghost {
    background: transparent;
    color: var(--accent);
    border: 1px solid rgba(11, 116, 218, 0.2);
  }

  button.small {
    padding: var(--spacing-sm) var(--spacing-md);
    font-size: var(--font-size-small);
  }

  button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .muted {
    color: var(--muted);
    font-size: var(--font-size-small);
  }

  /* ----- default table style (kept) ----- */
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: var(--font-size-base);
    min-width: 100%;
  }
    /* === Laporan Penjualan === */
#salesTbl {
  width: 100%;
  border-collapse: collapse;
  table-layout: fixed;
  min-width: 700px;
}

#salesTbl th, #salesTbl td {
  padding: 10px;
  border-bottom: 1px solid #f1f3f5;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

#salesTbl th:nth-child(1), #salesTbl td:nth-child(1) { width: 6%; text-align: center; } /* No */
#salesTbl th:nth-child(2), #salesTbl td:nth-child(2) { width: 25%; } /* Tanggal */
#salesTbl th:nth-child(3), #salesTbl td:nth-child(3) { width: 20%; } /* Invoice */
#salesTbl th:nth-child(4), #salesTbl td:nth-child(4) { width: 35%; } /* Item */
#salesTbl th:nth-child(5), #salesTbl td:nth-child(5) { width: 14%; text-align: right; } /* Total */


/* === Laporan Restock === */
#restockTbl {
  width: 100%;
  border-collapse: collapse;
  table-layout: fixed;
  min-width: 700px;
}

#restockTbl th, #restockTbl td {
  padding: 10px;
  border-bottom: 1px solid #f1f3f5;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

#restockTbl th:nth-child(1), #restockTbl td:nth-child(1) { width: 6%; text-align: center; } /* No */
#restockTbl th:nth-child(2), #restockTbl td:nth-child(2) { width: 18%; } /* Tanggal */
#restockTbl th:nth-child(3), #restockTbl td:nth-child(3) { width: 15%; } /* SKU */
#restockTbl th:nth-child(4), #restockTbl td:nth-child(4) { width: 30%; } /* Nama */
#restockTbl th:nth-child(5), #restockTbl td:nth-child(5) { width: 15%; text-align: center; } /* Jumlah */
#restockTbl th:nth-child(6), #restockTbl td:nth-child(6) { width: 16%; text-align: right; } /* Stok Akhir */


/* === Laporan Stok Akhir === */
#finalStockTbl {
  width: 100%;
  border-collapse: collapse;
  table-layout: fixed;
  min-width: 650px;
}

#finalStockTbl th, #finalStockTbl td {
  padding: 10px;
  border-bottom: 1px solid #f1f3f5;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

#finalStockTbl th:nth-child(1), #finalStockTbl td:nth-child(1) { width: 6%; text-align: center; } /* No */
#finalStockTbl th:nth-child(2), #finalStockTbl td:nth-child(2) { width: 18%; } /* SKU */
#finalStockTbl th:nth-child(3), #finalStockTbl td:nth-child(3) { width: 36%; } /* Nama */
#finalStockTbl th:nth-child(4), #finalStockTbl td:nth-child(4) { width: 20%; text-align: center; } /* Stok */
#finalStockTbl th:nth-child(5), #finalStockTbl td:nth-child(5) { width: 20%; text-align: right; } /* Harga */

/* --- Style seragam agar sama seperti tabel produk --- */
#salesTbl th, #restockTbl th, #finalStockTbl th {
  background: #f9fbfd;
  color: #333;
  font-weight: 600;
}

#salesTbl tbody tr:nth-child(even),
#restockTbl tbody tr:nth-child(even),
#finalStockTbl tbody tr:nth-child(even) {
  background: #fcfdff;
}


  th, td {
    padding: var(--spacing-sm);
    border-bottom: 1px solid #f1f3f5;
    text-align: left;
    vertical-align: top;
    word-break: break-word;
  }

  th {
    font-weight: 600;
    color: #333;
    background: #f9fbfd;
    font-size: var(--font-size-base);
  }

  .actions button {
    margin-right: var(--spacing-sm);
    width: auto;
  }

  #cart {
    min-height: 36px;
    padding: var(--spacing-sm);
    background: #f1f5fb;
    border: 1px dashed #cce1ff;
    border-radius: var(--radius);
    overflow-x: auto;
  }
    #cart table {
    width: 100%;
    border-collapse: collapse;
    table-layout: fixed; /* Biar kolom ga pecah */
    word-wrap: break-word;
  }

    #cart td {
    vertical-align: middle;
    white-space: nowrap; /* Biar nama produk tetap 1 baris */
    overflow: hidden;
    text-overflow: ellipsis;
  }

    #cart td:first-child {
    width: 65%;
  }

    #cart td:nth-child(2) {
    text-align: right;
    width: 25%;
  }

    #cart td:nth-child(3) {
    text-align: center;
    width: 10%;
  }
    /* Rapi di semua perangkat */
    .table-wrapper {
    overflow-x: auto;
    width: 100%;
    -webkit-overflow-scrolling: touch;
  }
    #tbl {
    width: 100%;
    border-collapse: collapse;
    table-layout: auto; /* biar kolom menyesuaikan konten */
    min-width: 600px;   /* biar ga rusak di layar kecil */
  }
    #tbl th, #tbl td {
    white-space: nowrap;
    text-overflow: ellipsis;
    overflow: hidden;
    padding: 8px;
    border-bottom: 1px solid #f1f3f5;
    text-align: left;
    vertical-align: middle;
  }

  #reader {
    width: 100%;
    max-width: 100%;
    border-radius: var(--radius);
    overflow: hidden;
    background: #000;
    min-height: 200px;
  }

  .tabs {
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-lg);
  }

  .tab-btn {
    padding: var(--spacing-sm) var(--spacing-md);
    background: #f1f5f9;
    border: none;
    border-radius: var(--radius);
    font-weight: 600;
    font-size: var(--font-size-base);
    cursor: pointer;
    flex: 1;
    text-align: center;
  }

  .tab-btn.active {
    background: var(--accent);
    color: #fff;
  }

  .flex {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
    flex-wrap: wrap;
  }

  .stack {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-md);
  }

  .right {
    text-align: right;
    width: 100%;
  }

  .badge {
    background: #eef6ff;
    color: var(--accent);
    padding: var(--spacing-sm) var(--spacing-md);
    border-radius: 999px;
    font-weight: 600;
    font-size: var(--font-size-small);
  }

  .note, .info-small {
    font-size: var(--font-size-small);
    color: var(--muted);
  }

  .printer-row {
    display: flex;
    gap: var(--spacing-md);
    align-items: center;
    margin-top: var(--spacing-sm);
    flex-wrap: wrap;
  }

  .tab-content {
    display: none;
  }

  .tab-content.active {
    display: block;
  }

  #guideOverlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.65);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000;
  }

  #guideBox {
    background: #fff;
    padding: var(--spacing-lg);
    border-radius: var(--radius);
    max-width: 90%;
    width: 300px;
    box-shadow: var(--shadow);
    text-align: center;
  }

  #guideBox button {
    margin: var(--spacing-sm) var(--spacing-md);
    width: 110px;
    font-size: var(--font-size-small);
  }

  #guideOverlay {
    pointer-events: auto;
  }
  #cameraModal[style*="display:none"] {
    pointer-events: none !important;
  }

  #cameraModal[style*="display:none"] {
    pointer-events: none !important;
  }

  /* Payment modal */
  #paymentModal {
    position: fixed;
    top:0; left:0; right:0; bottom:0;
    background: rgba(0,0,0,0.45);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 11000;
  }
  #paymentModal .box {
    background: #fff;
    border-radius: 10px;
    padding: 18px;
    width: 92%;
    max-width: 420px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.25);
  }
  #paymentMethods { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px; }
  .pm-btn { flex:1; padding:8px 10px; border-radius:8px; border:1px solid #eef5ff; background:#f8fbff; cursor:pointer; text-align:center; font-weight:600; color:#094fa1; }
  .pm-btn.active { background:#0b74da; color:#fff; border-color:#0b74da; }

  /* small instruction box */
  .pay-instr { background:#f5f7fb; padding:8px; border-radius:8px; margin-bottom:10px; font-size:13px; color:#333; }

  .table-wrapper {
    width: 100%;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    margin-top: var(--spacing-sm);
    border-radius: var(--radius);
    background: var(--card);
    box-shadow: var(--shadow);
  }

  /* camera alert inside camera modal */
  .camera-alert {
    background: #fff;
    padding: 12px;
    border-radius: 8px;
    color: #111;
    box-shadow: 0 6px 20px rgba(0,0,0,0.2);
    max-width: 360px;
    margin: 6px auto 0;
    text-align: center;
  }
  .camera-alert .msg { margin-bottom: 12px; color: #b91c1c; font-weight:600; }

  /* receipt preview modal */
  #receiptPreviewModal {
    position: fixed;
    inset: 0;
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 12000;
    background: rgba(0,0,0,0.45);
  }
  #receiptPreviewModal .box {
    background:#fff;
    border-radius:10px;
    padding:16px;
    max-width:420px;
    width:92%;
    box-shadow: 0 8px 28px rgba(0,0,0,0.22);
  }
  #receiptPreviewModal .items { max-height:300px; overflow:auto; margin-bottom:10px; }

  /* simple toast for feedback */
  #appToast { position: fixed; right: 16px; bottom: 24px; max-width: calc(100% - 40px); background: linear-gradient(90deg,#0b74da,#094fa1); color:#fff; padding:10px 14px; border-radius:10px; box-shadow:0 10px 30px rgba(11,116,218,0.18); font-weight:600; z-index:13000; opacity:0; transform:translateY(12px); transition: opacity 260ms ease, transform 260ms cubic-bezier(.22,.9,.35,1); pointer-events:auto; }
  #appToast.show { opacity:1; transform:translateY(0); }

  /* responsive additions appended below (mobile-first responsive rules) */
  :root{
    --spacing-xs: 6px;
    --spacing-sm-r: 8px;
    --spacing-md-r: 12px;
    --spacing-lg-r: 16px;
    --spacing-xl: 20px;
    --radius-r: 8px;
    --shadow-md: 0 6px 18px rgba(0,0,0,0.08);
    --font-size-xxs: clamp(11px, 1.8vw, 12px);
    --font-size-xs: clamp(12px, 2.2vw, 13px);
    --font-size-sm-r: clamp(13px, 2.6vw, 14px);
    --font-size-base-r: clamp(14px, 2.8vw, 16px);
    --font-size-lg-r: clamp(16px, 3.2vw, 18px);
    --font-size-xl-r: clamp(18px, 3.6vw, 22px);
    --btn-padding-vertical: 8px;
    --btn-padding-horizontal: 12px;
    --guide-tooltip-width: 320px;
    --guide-tooltip-pad: 12px;
  }

  html,body{
    font-size: var(--font-size-base-r);
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
  }

  h2 { font-size: var(--font-size-xl-r); margin: 12px 0; }
  h3 { font-size: var(--font-size-lg-r); margin: 10px 0; }

  .container{
    padding: var(--spacing-md-r);
  }

  .card {
    border-radius: var(--radius-r);
    padding: var(--spacing-md-r);
    box-shadow: var(--shadow-md);
  }

  button {
    padding: var(--btn-padding-vertical) var(--btn-padding-horizontal);
    font-size: var(--font-size-sm-r);
    border-radius: calc(var(--radius-r) * 1);
    width: 100%;
    box-sizing: border-box;
  }

  button.small { padding: 6px 10px; font-size: var(--font-size-xs); }

  .table-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; border-radius: var(--radius-r); background: transparent; }

  @media (min-width: 600px) {
    :root{
      --spacing-sm-r: 8px;
      --spacing-md-r: 12px;
      --spacing-lg-r: 16px;
      --font-size-base-r: clamp(15px, 1.6vw, 16px);
      --guide-tooltip-width: 320px;
    }
    .grid { grid-template-columns: 1fr 360px; }
    button { width: auto; min-width: 120px; }
    button.small { min-width: 88px; }
    #cameraModal, #paymentModal { align-items: center; }
  }

  @media (min-width: 900px) {
    :root{
      --spacing-md-r: 14px;
      --spacing-lg-r: 18px;
      --font-size-base-r: 16px;
      --font-size-lg-r: 18px;
      --font-size-xl-r: 20px;
      --guide-tooltip-width: 340px;
    }
    .grid { grid-template-columns: 1fr 360px; gap: 18px; }
    body { font-size: var(--font-size-base-r); }
    table { font-size: var(--font-size-base-r); min-width: 600px; }
    button { font-size: var(--font-size-base-r); padding: 10px 14px; }
    #checkoutBtn { width: 100%; }
  }

  @media (min-width: 1200px) {
    :root{
      --spacing-lg-r: 20px;
      --font-size-base-r: 16px;
      --font-size-lg-r: 20px;
      --font-size-xl-r: 22px;
      --guide-tooltip-width: 360px;
    }
    .grid{ grid-template-columns: 1fr 360px; gap: 22px; }
    button { padding: 10px 16px; }
    #salesTbl, #restockTbl, #finalStockTbl { min-width: 700px; }
  }

  /* guide tooltip styling (transition rules replaced/added below) */
  #guideTooltip{
    position: absolute;
    z-index: 100001;
    box-shadow: 0 12px 30px rgba(0,0,0,0.12);
    border-radius: 8px;
    background: #fff;
    padding: var(--guide-tooltip-pad);
    max-width: var(--guide-tooltip-width);
    word-wrap: break-word;
    pointer-events: auto;
    opacity: 0;
    transform: translateY(6px);
    transition: opacity 220ms cubic-bezier(.22,.9,.35,1), transform 220ms cubic-bezier(.22,.9,.35,1);
  }

  @media (max-width: 420px){
    #guideTooltip{ max-width: calc(100vw - 24px); padding: 10px; font-size: var(--font-size-xs); }
  }

  #highlightBox { pointer-events: none; transition: top 260ms cubic-bezier(.22,.9,.35,1), left 260ms cubic-bezier(.22,.9,.35,1), width 260ms cubic-bezier(.22,.9,.35,1), height 260ms cubic-bezier(.22,.9,.35,1); will-change: top,left,width,height; }

  /* Accessibility touch tweaks */
  button, .tab-btn, .pm-btn { touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
  @media print { #guideOverlay, #cameraModal, #paymentModal, #guideTooltip { display: none !important; } }
    
  /* === Floating Button Panduan (Fixed Width Safe for Mobile) === */
  #startGuideBtn {
    position: fixed;
    bottom: 16px;
    left: 16px;
    background: linear-gradient(135deg, #0b74da, #094fa1);
    color: #fff;
    border: none;
    border-radius: 40px;
    padding: 9px 14px;
    font-weight: 600;
    font-size: 13px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
    cursor: pointer;
    z-index: 99999;
    opacity: 0.9;
    transition: all 0.25s ease;
    white-space: nowrap;
    max-width: 90vw;           /* biar gak lebih dari 90% lebar layar */
    overflow: hidden;          /* sembunyikan isi kalau kepanjangan */
    text-overflow: ellipsis;   /* tambahkan "..." jika terlalu panjang */
  }
  #startGuideBtn:hover {
    opacity: 1;
    transform: translateY(-2px);
  }
  
  /* ðŸ“± HP kecil (â‰¤600px) */
  @media (max-width: 600px) {
    #startGuideBtn {
      font-size: 11.5px;
      padding: 7px 10px;
      bottom: 12px;
      left: 12px;
      border-radius: 30px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.2);
      max-width: 88vw; /* tambah ruang aman di kanan */
    }
  }
  
  /* ðŸ’Š Tablet (600â€“900px) */
  @media (min-width: 601px) and (max-width: 900px) {
    #startGuideBtn {
      font-size: 12.5px;
      padding: 8px 12px;
      bottom: 14px;
      left: 14px;
      max-width: 85vw;
    }
  }
  
  /* ðŸ’» Desktop (â‰¥901px) */
  @media (min-width: 901px) {
    #startGuideBtn {
      font-size: 14px;
      padding: 10px 18px;
      bottom: 22px;
      left: 22px;
      max-width: none;
    }
  }


  </style>

  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>

<body>
  <header>
    <div style="display:flex;justify-content:space-between;align-items:center;gap:var(--spacing-md);flex-wrap:wrap">
      <h2 style="margin:0;font-size:1.25rem">INDOCART</h2>
      <div style="display:flex;gap:var(--spacing-md);align-items:center">
        <div class="muted">Keranjang: <span id="cartCount">0</span> barang</div>
        <div class="badge" id="shopStatus">Offline</div>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="grid">

      <!-- Dashboard Laporan -->
      <div class="card">
        <h2 style="font-size:1.5rem; margin-bottom: var(--spacing-md)">ðŸ“Š Dashboard Laporan</h2>
        <div class="tabs">
          <button class="tab-btn active" onclick="openTab('penjualan')">Penjualan</button>
          <button class="tab-btn" onclick="openTab('restock')">Restock</button>
          <button class="tab-btn" onclick="openTab('stok')">Stok Akhir</button>
        </div>

        <div id="penjualan" class="tab-content active">
          <h3>Laporan Penjualan</h3>
          <div class="flex">
            <label class="muted">From <input id="filterFrom" type="date" /></label>
            <label class="muted">To <input id="filterTo" type="date" /></label>
            <button onclick="loadSales(); renderSalesTable()" class="small">Tampilkan</button>
            <button onclick="exportSales()" class="small ghost">Export CSV</button>
            <button onclick="printSales()" class="small ghost">Cetak</button>
            <button onclick="clearSales()" class="small ghost" title="Hapus laporan hari ini">Clear Laporan</button>
            <button onclick="clearSalesByRange()" class="small ghost" title="Hapus laporan berdasarkan rentang tanggal">Clear Range</button>
          </div>

          <!-- table-wrapper ditambahkan di sini -->
          <div class="table-wrapper" style="max-height:200px; margin-top: var(--spacing-sm)">
            <table id="salesTbl">
              <thead><tr><th>No</th><th>Tanggal</th><th>Invoice</th><th>Item</th><th>Total</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div id="restock" class="tab-content">
          <h3>Laporan Restock (Barang Masuk)</h3>
          <div class="flex" style="gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px">
            <button onclick="loadRestock()" class="small">Tampilkan</button>
            <button onclick="exportRestock()" class="small ghost">Export CSV Semua</button>
            <button onclick="printRestock()" class="small ghost">Cetak</button>
            <button onclick="clearRestocks()" class="small ghost">Clear Restock</button>
          </div>

          <!-- export per bulan / range -->
          <div class="flex" style="gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px">
            <label class="muted">Bulan: <input id="restockMonth" type="month" /></label>
            <button class="small ghost" onclick="exportRestockByMonth()">Download Bulanan</button>

            <label class="muted">Dari <input id="restockExportFrom" type="date" /></label>
            <label class="muted">Sampai <input id="restockExportTo" type="date" /></label>
            <button class="small ghost" onclick="exportRestockByRange()">Download Rentang</button>
          </div>

          <!-- table-wrapper ditambahkan di sini -->
          <div class="table-wrapper" style="max-height:240px; margin-top: var(--spacing-sm)">
            <table id="restockTbl">
              <thead><tr><th>No</th><th>Tanggal</th><th>SKU</th><th>Nama</th><th>Jumlah</th><th>Stok Akhir</th></tr></thead>
              <tbody id="restockTableBody"></tbody>
            </table>
          </div>
        </div>

        <div id="stok" class="tab-content">
          <h3>Stok Akhir Produk</h3>

          <!-- table-wrapper ditambahkan di sini -->
          <div class="table-wrapper" style="max-height:200px; margin-top: var(--spacing-sm)">
            <table id="finalStockTbl">
              <thead><tr><th>No</th><th>SKU</th><th>Nama</th><th>Stok</th><th>Harga</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Tambah / Edit Produk -->
      <div class="card">
        <section>
          <h3>Tambah Produk</h3>
          <form id="formProduct" onsubmit="submitProduct();return false" style="margin-bottom: var(--spacing-lg)">
            <div class="row">
              <div class="col">
                <label class="muted">Kode Barang / SKU</label>
                <div style="display:flex;gap:var(--spacing-sm)">
                  <input id="sku" placeholder="Kode Barang" type="text" required />
                  <button type="button" class="small" onclick="scanSku()" title="Scan Kode Barang">Scan</button>
                </div>
              </div>
              <div class="col">
                <label class="muted">Nama Produk</label>
                <input id="name" placeholder="Nama Produk" type="text" required />
              </div>
            </div>
            <div class="row">
              <div class="col">
                <label class="muted">Harga Jual (Rp)</label>
                <input id="price" placeholder="Harga Jual (Rp)" type="number" required />
              </div>
              <div class="col">
                <label class="muted">Stok (angka)</label>
                <input id="qty" placeholder="Stok (angka)" type="number" required />
              </div>
            </div>
            <div style="display:flex;gap:var(--spacing-sm);flex-wrap:wrap;align-items:center">
              <button type="submit" id="formSubmitBtn">Tambah</button>
              <button type="button" class="ghost" onclick="resetForm()">Reset</button>
              <div class="muted" style="margin-left: auto; font-size: var(--font-size-small)">
                Jika nama sudah ada, stok akan <strong>dijumlahkan</strong>.
              </div>
            </div>
          </form>

          <h3>Restock Produk</h3>
          <form id="formRestock" onsubmit="return restockProduct(event)" class="flex" style="gap:var(--spacing-sm); flex-wrap:wrap; align-items:center">
            <select id="restockName" required>
              <option value="">Pilih Produk...</option>
            </select>
            <input id="restockQty" placeholder="Jumlah Restock" type="number" required />
            <button type="submit">Tambah Stok</button>
          </form>

          <h3>Daftar Produk</h3>
          <input id="search" placeholder="Cari produk (Kode/Nama)..." oninput="render()" autocomplete="off"
                 style="margin-bottom: var(--spacing-lg); width: 100%; padding: var(--spacing-sm);
                        border-radius: var(--radius); border:1px solid #e8eef8" />
          <div class="table-wrapper" style="max-height: 300px;">
            <table id="tbl">
              <thead><tr><th>SKU</th><th>Nama</th><th>Stok</th><th>Harga</th><th>Aksi</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </section>
      </div>

      <!-- Sisi Kanan: Keranjang dan Scan Produk -->
      <div class="card">
        <h3>Keranjang (<span id="cartCount2">0</span>)</h3>
        <div id="cart"><i class="muted">Keranjang kosong</i></div>
        <div class="flex" style="margin-top: var(--spacing-md); flex-direction: column; gap: var(--spacing-sm)">
         
        <div class="note">Total: <strong id="total">Rp 0</strong></div>

        <!-- DISCOUNT CONTROLS (side-by-side) -->
          <div style="display:flex;gap:10px;margin-top:8px;align-items:center;">
          <div style="flex:1;min-width:140px">
            <label class="muted">Diskon total belanja (%)</label>
              <input type="number" id="discountTotalPercent" min="0" max="100" placeholder="10" oninput="applyDiscount()" />
          </div>
          </div>
          <div style="width: 100%">
            <label><input type="checkbox" id="autoPrint" /> Cetak struk otomatis</label>
            <div class="printer-row">
              <select id="printerSelect">
                <option value="">Pilih printer (belum tersimpan)</option>
                <option value="Printer Lokal">Printer Lokal</option>
                <option value="Printer Bluetooth">Printer Bluetooth</option>
                <option value="Printer Jaringan">Printer Jaringan</option>
              </select>
              <button class="small ghost" onclick="savePrinterPreference()">Simpan</button>
            </div>
            <div class="info-small">Jika auto print aktif: pastikan pilih & simpan printer. Jika tidak, proses cetak akan diblokir dan muncul peringatan.</div>
          </div>
          <div style="width: 100%; margin-top: var(--spacing-md)">
            <!-- tetap pakai id checkoutBtn supaya minimal perubahan -->
            <button id="checkoutBtn" onclick="checkout()" disabled>Bayar</button>
            <button class="ghost" onclick="clearCart()">Kosongkan</button>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>Scan Produk</h3>
        <div class="flex" style="gap: var(--spacing-sm); flex-wrap: wrap; margin-bottom: var(--spacing-sm)">
          <button id="btnStartScan" onclick="startScan('sell')" class="small">Mulai Scan Jual</button>
          <button id="btnStopScan" onclick="stopScan()" class="small ghost">Stop Scan</button>
          <label class="muted" style="margin-left: auto">Mode:
            <select id="scanMode" style="margin-left: var(--spacing-sm)">
              <option value="single">1x auto-stop</option>
              <option value="continuous">Multi-scan</option>
            </select>
          </label>
        </div>
        <div style="display:flex; gap:var(--spacing-sm); align-items:center; margin-bottom: var(--spacing-sm)">
          <label><input type="checkbox" id="autoSell" /> <span class="muted">Auto-sell on scan</span></label>
        </div>
        <div class="muted note" style="margin-top: var(--spacing-sm)">Gunakan kamera ponsel. Pilih mode single jika ingin berhenti setelah 1 scan.</div>
      </div>
      
    </div>
  </main>

  <div id="cameraModal" style="
  display:none;
  position:fixed;
  top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,0.6);
  justify-content:center;
  align-items:center;
  z-index:9000;
">
  <div style="
    background:#fff;
    border-radius:10px;
    padding:20px;
    max-width:400px;
    width:90%;
    box-shadow:0 4px 12px rgba(0,0,0,0.2);
  ">
    <h3 style="margin-top:0;margin-bottom:10px">ðŸ“· Scan Barcode</h3>
    <div id="cameraReader" style="width:100%;background:#000;min-height:250px;border-radius:8px;overflow:hidden"></div>

    <!-- camera alert area (hidden by default) -->
    <div id="cameraAlert" class="camera-alert" style="display:none">
      <div class="msg" id="cameraAlertMsg">Pesan</div>
      <div>
        <button class="ghost small" onclick="closeCameraAlert()">Close</button>
      </div>
    </div>

    <div style="display:flex;justify-content:end;margin-top:10px;gap:10px">
      <button class="ghost small" onclick="closeCamera()">Tutup</button>
    </div>
  </div>
</div>
<!-- Guide popup lama di-nonaktifkan -->
<!--
  <div id="guideOverlay">
    <div id="guideBox">
      <h3>Selamat Datang di POS Toko Sembako</h3>
      <p>Klik mulai untuk tutorial singkat semua fitur, atau skip jika sudah hafal.</p>
      <button onclick="startGuide()">Mulai</button>
      <button onclick="skipGuide()">Skip</button>
    </div>
  </div>
  -->
  <!-- Tombol Floating "Mulai Panduan" -->
<button id="startGuideBtn" onclick="startGuide()" title="Mulai Panduan"
  style="
    position: fixed;
    bottom: 20px;
    left: 20px;
    background: #0b74da;
    color: #fff;
    border: none;
    border-radius: 50px;
    padding: 10px 16px;
    font-weight: 600;
    font-size: 13px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    cursor: pointer;
    z-index: 99999;
    opacity: 0.9;
  "
  onmouseover="this.style.opacity=1"
  onmouseout="this.style.opacity=0.9"
>ðŸ“˜ Mulai Panduan</button>


  <!-- payment modal -->
  <div id="paymentModal">
    <div class="box">
      <h3 style="margin-top:0">Pembayaran</h3>
      <div id="pmTop" style="margin-bottom:8px" class="muted">Pilih metode pembayaran untuk menyelesaikan transaksi.</div>

      <div id="paymentMethods">
        <div class="pm-btn" data-method="cash" onclick="selectPaymentMethod('cash', this)">Tunai</div>
        <div class="pm-btn" data-method="transfer" onclick="selectPaymentMethod('transfer', this)">Transfer Bank</div>
        <div class="pm-btn" data-method="card" onclick="selectPaymentMethod('card', this)">Kartu (EDC)</div>
        <div class="pm-btn" data-method="qris" onclick="selectPaymentMethod('qris', this)">QRIS / e-Wallet</div>
      </div>

      <div id="paymentInfoBox" class="pay-instr">Total: <strong id="payTotal">Rp 0</strong></div>

      <div style="display:flex;gap:8px">
        <button onclick="confirmPayment()" id="confirmPayBtn">Konfirmasi Pembayaran</button>
        <button class="ghost" onclick="closePaymentModal()">Batal</button>
      </div>

      <div id="payDebug" style="margin-top:10px" class="muted"></div>
    </div>
  </div>

  <!-- receipt preview modal (shown after confirmPayment) -->
  <div id="receiptPreviewModal">
    <div class="box">
      <h3 style="margin:0 0 8px 0">Struk Pembayaran</h3>
      <div id="receiptPreviewContent" class="items"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
        <button onclick="printPendingReceipt()" id="printPreviewBtn">Cetak</button>
        <button class="ghost" onclick="closeReceiptPreview()">Tutup</button>
        <button onclick="finalizePendingSale()" id="finalizeBtn" style="background:#0b8b3e">Selesaikan Penjualan</button>
      </div>
    </div>
  </div>

  <!-- receipt area template (hidden) -->
  <div id="receiptTemplate" style="display:none">
    <div id="receiptArea"></div>
  </div>

  <!-- toast -->
  <div id="appToast" style="display:none"></div>

<script>
/* ---------- data ---------- */
let products = JSON.parse(localStorage.getItem('products')||'[]')
let sales = JSON.parse(localStorage.getItem('sales')||'[]')
let restocks = JSON.parse(localStorage.getItem('restocks')||'[]')
let cart = []
// ====== DISCOUNT VARIABLES & HELPERS ======
let discountTotalPercent = 0;     // percentage applied to subtotal after per-product discounts

function formatRupiahNumber(n){
  if(!n) return "Rp 0";
  return "Rp " + n.toLocaleString();
}
function parseRupiahString(s){
  if(!s) return 0;
  return parseInt((s+"").replace(/[^\d]/g,'')) || 0;
}

function applyDiscount(){
  const pctEl = document.getElementById("discountTotalPercent");
  discountTotalPercent = pctEl ? (parseFloat(pctEl.value) || 0) : 0;
  // re-render cart to show updated totals
  renderCart();
}

// compute subtotal, discounts and final total
function computeCartTotals(){
  let subtotalBefore = 0;
  let perProductDiscountTotal = 0;

  cart.forEach(c => {
    const itemSubtotal = c.price * c.qty;
    subtotalBefore += itemSubtotal;
    // Hitung diskon berdasarkan properti 'discount' masing-masing item
    const itemDiscountTotal = Math.min(itemSubtotal, c.discount * c.qty);
    perProductDiscountTotal += itemDiscountTotal;
  });

  const afterPerProduct = subtotalBefore - perProductDiscountTotal;
  const percentDiscountAmount = Math.round((discountTotalPercent / 100) * afterPerProduct);
  let finalTotal = afterPerProduct - percentDiscountAmount;
  if (finalTotal < 0) finalTotal = 0;

  return {
    subtotalBefore,
    perProductDiscountTotal,
    afterPerProduct,
    percentDiscountAmount,
    finalTotal
  };
}
// ====== END DISCOUNT HELPERS ======


// pendingPaidInvoice stored during session so user can finalize after paying
let pendingPaidInvoice = localStorage.getItem('pendingPaidInvoice') || null
let selectedPaymentMethod = null

/* ---------- utility: reliable local datetime string ---------- */
function getLocalDateTime(){
  const d=new Date();
  const yyyy=d.getFullYear();
  const mm=String(d.getMonth()+1).padStart(2,"0");
  const dd=String(d.getDate()).padStart(2,"0");
  const hh=String(d.getHours()).padStart(2,"0");
  const mi=String(d.getMinutes()).padStart(2,"0");
  const ss=String(d.getSeconds()).padStart(2,"0");
  // format yang mudah di-parse kembali: "YYYY-MM-DD HH:mm:ss"
  return `${yyyy}-${mm}-${dd} ${hh}:${mi}:${ss}`;
}

/* ---------- toast ---------- */
function showToast(msg) {
  const toast = document.createElement("div");
  toast.className = "toast";
  toast.innerText = msg;

  Object.assign(toast.style, {
    position: "fixed",
    top: "25px",
    left: "50%",
    transform: "translateX(-50%)",
    background: "rgba(0, 123, 255, 0.95)",
    color: "#fff",
    padding: "10px 18px",
    borderRadius: "8px",
    fontSize: "14px",
    fontWeight: "600",
    zIndex: 99999,
    boxShadow: "0 4px 14px rgba(0,0,0,0.25)",
    opacity: 0,
    transition: "opacity 0.4s ease, transform 0.4s ease"
  });

  document.body.appendChild(toast);
  setTimeout(() => {
    toast.style.opacity = "1";
    toast.style.transform = "translateX(-50%) translateY(0)";
  }, 50);

  setTimeout(() => {
    toast.style.opacity = "0";
    toast.style.transform = "translateX(-50%) translateY(-10px)";
    setTimeout(() => toast.remove(), 500);
  }, 2500);
}

  function showSalesAlert(message) {
  // Kita gunakan showToast yang sudah ada agar notifikasinya konsisten
  showToast(message);
}


/* ---------- render product list (dengan notif jika kosong) ---------- */
function render(){
  const tbl=document.querySelector("#tbl tbody")
  const searchVal=document.querySelector("#search").value.toLowerCase().trim()
  tbl.innerHTML=""
  let matched = 0
  products.forEach((p,i)=>{
    if(p.name.toLowerCase().includes(searchVal)||p.sku.includes(searchVal)){
      matched++
      const tr=document.createElement("tr")
      tr.innerHTML=`
        <td>${p.sku}</td>
        <td>${p.name}</td>
        <td>${p.qty}</td>
        <td>Rp ${p.price.toLocaleString()}</td>
        <td class="actions">
          <button class="small" onclick="editProduct('${p.sku}')">Edit</button>
          <button class="small ghost" onclick="deleteProduct('${p.sku}')">Hapus</button>
        </td>`
      tbl.appendChild(tr)
    }
  })
  if(matched === 0){
    const tr=document.createElement("tr")
    tr.innerHTML = `<td colspan="5" class="muted" style="text-align:center;padding:14px">Tidak ada produk yang sesuai</td>`
    tbl.appendChild(tr)
  }
  updateRestockDropdown()
}

/* ---------- product CRUD ---------- */
function submitProduct(){
  const sku = document.getElementById("sku").value.trim()
  const name = document.getElementById("name").value.trim()
  const price = parseInt(document.getElementById("price").value)
  const qty = parseInt(document.getElementById("qty").value)
  if(!sku || !name || !price || !qty) return alert("Lengkapi data!")
  
  const exist = products.find(p => p.sku === sku)
  if(exist){
    exist.qty += qty
    exist.price = price
  } else {
    products.push({sku, name, price, qty})
  }

  localStorage.setItem("products", JSON.stringify(products))
  render()
  resetForm()
  showToast("Berhasil ditambahkan!")
}

function resetForm(){
  document.getElementById("sku").value=""
  document.getElementById("name").value=""
  document.getElementById("price").value=""
  document.getElementById("qty").value=""
  document.getElementById("formSubmitBtn").textContent="Tambah"
}

function editProduct(sku){
  const p=products.find(x=>x.sku===sku)
  if(!p) return
  document.getElementById("sku").value=p.sku
  document.getElementById("name").value=p.name
  document.getElementById("price").value=p.price
  document.getElementById("qty").value=p.qty
  document.getElementById("formSubmitBtn").textContent="Update"
}

function deleteProduct(sku){
  if(!confirm("Hapus produk ini?")) return
  products=products.filter(p=>p.sku!==sku)
  localStorage.setItem("products",JSON.stringify(products))
  render()
}

function updateRestockDropdown(){
  const sel=document.getElementById("restockName")
  if(!sel) return
  sel.innerHTML='<option value="">Pilih Produk...</option>'
  products.forEach(p=>{
    const opt=document.createElement('option')
    opt.value=p.sku; opt.textContent=p.name
    sel.appendChild(opt)
  })
}

function renderSalesTable(){
  const tbody = document.querySelector("#salesTbl tbody");
  tbody.innerHTML = "";
  const allSales = JSON.parse(localStorage.getItem('sales') || '[]');
  if(!allSales.length){
    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:10px" class="muted">Belum ada data penjualan.</td></tr>';
    return;
  }
  allSales.slice().reverse().forEach((s, idx)=>{
    // build item summary string
    const itemNames = s.items.map(it=>`${it.name} x${it.qty}`).join(", ");
    const before = s.totalsBreakdown ? s.totalsBreakdown.subtotalBefore : s.items.reduce((a,i)=>a + i.price*i.qty,0);
    const perProd = s.totalsBreakdown ? s.totalsBreakdown.perProductDiscountTotal : 0;
    const pct = s.totalsBreakdown ? s.totalsBreakdown.percentDiscountAmount : 0;
    const finalT = s.totalsBreakdown ? s.totalsBreakdown.finalTotal : s.total;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${idx+1}</td>
      <td>${s.dateDisplay || s.date}</td>
      <td>${s.invoice}</td>
      <td style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${itemNames}</td>
      <td style="text-align:right">Rp ${before.toLocaleString()}</td>
      <td style="text-align:right;color:#16a34a">-Rp ${perProd.toLocaleString()}</td>
      <td style="text-align:right;color:#16a34a">-Rp ${pct.toLocaleString()}</td>
      <td style="text-align:right;font-weight:700">Rp ${finalT.toLocaleString()}</td>`;
    tbody.appendChild(tr);
  });
}
  
/* ---------- restock ---------- */
function restockProduct(event) {
  if (event) event.preventDefault();

  const sku = document.getElementById("restockName").value;
  const qtyInput = document.getElementById("restockQty");
  const qty = parseInt(qtyInput.value);

  if (!sku || !qty || qty <= 0) {
    showRestockAlert("âš ï¸ Pilih produk dan isi jumlah yang benar!");
    return false;
  }

  const p = products.find(x => x.sku === sku);
  if (!p) {
    showRestockAlert("âŒ Produk tidak ditemukan!");
    return false;
  }

  p.qty += qty;
  localStorage.setItem("products", JSON.stringify(products));

  let restocks = JSON.parse(localStorage.getItem("restocks")) || [];
  const restockData = {
    date: getLocalDateTime(),
    sku: p.sku,
    name: p.name,
    qty,
    stockAfter: p.qty
  };
  restocks.push(restockData);
  localStorage.setItem("restocks", JSON.stringify(restocks));

  render();
  loadRestock();
  qtyInput.value = "";

  showRestockAlert(`âœ… Anda berhasil menambahkan stok "${p.name}". Periksa kembali di daftar produk.`);

  return false;
}

/* === Fungsi Notifikasi Khusus Restock === */
function showRestockAlert(message) {
  // Hapus notifikasi lama jika masih ada
  const existing = document.getElementById("restockToast");
  if (existing) existing.remove();

  const toast = document.createElement("div");
  toast.id = "restockToast";
  toast.textContent = message;

  Object.assign(toast.style, {
    position: "fixed",
    top: "25px",
    left: "50%",
    transform: "translateX(-50%)",
    background: "linear-gradient(135deg, #0b74da, #094fa1)",
    color: "#fff",
    padding: "12px 20px",
    borderRadius: "10px",
    fontSize: "14px",
    fontWeight: "600",
    zIndex: 999999,
    boxShadow: "0 6px 18px rgba(0,0,0,0.35)",
    opacity: 0,
    transition: "opacity 0.3s ease, transform 0.3s ease"
  });

  document.body.appendChild(toast);

  // Animasi muncul
  setTimeout(() => {
    toast.style.opacity = "1";
    toast.style.transform = "translateX(-50%) translateY(0)";
  }, 50);

  // Animasi hilang
  setTimeout(() => {
    toast.style.opacity = "0";
    toast.style.transform = "translateX(-50%) translateY(-10px)";
    setTimeout(() => toast.remove(), 400);
  }, 3000);
}
  
/* ---------- CART & CHECKOUT ---------- */
function addToCart(sku){
  const p = products.find(x => x.sku === sku);
  if (!p) return alert("Produk tidak ditemukan");
  if (p.qty <= 0) return alert("Produk telah habis, isi stok dahulu");

  if (pendingPaidInvoice) {
    pendingPaidInvoice = null;
    localStorage.removeItem('pendingPaidInvoice');
    showToast("Transaksi sebelumnya dibatalkan. Memulai transaksi baru.");
  }

  const cartItem = cart.find(c => c.sku === sku);
  if (cartItem) {
    if (cartItem.qty >= p.qty) return alert("Stok tidak cukup");
    cartItem.qty += 1;
  } else {
    // Tambahkan properti 'discount: 0' saat produk baru ditambahkan
    cart.push({ sku: p.sku, name: p.name, price: p.price, qty: 1, discount: 0 });
  }
  renderCart();
}
  function updateItemDiscount(sku, discountValue) {
  const item = cart.find(c => c.sku === sku);
  if (item) {
    // Pastikan nilai diskon tidak negatif
    const discount = Math.max(0, parseInt(discountValue) || 0);
    item.discount = discount;
    renderCart(); // Render ulang keranjang untuk memperbarui total
  }
}
function renderCart(){
  const el = document.getElementById("cart");
  const count = document.getElementById("cartCount");
  const count2 = document.getElementById("cartCount2");
  const checkoutBtn = document.getElementById("checkoutBtn");
  if (cart.length === 0) {
    el.innerHTML = '<i class="muted">Keranjang kosong</i>';
    count.textContent = "0"; count2.textContent = "0";
    checkoutBtn.disabled = true;
    document.getElementById("total").textContent = "Rp 0";
    return;
  }

  let html = "<table style='width:100%'>";
  const totals = computeCartTotals();

  cart.forEach((c) => {
    const originalSubtotal = c.price * c.qty;
    const itemDiscountTotal = c.discount * c.qty;
    const finalSubtotal = originalSubtotal - itemDiscountTotal;

    html += `
    <tr>
      <td style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
        ${c.name} <span style="color:#6b7280;">x${c.qty}</span>
      </td>
      <td style="text-align:right;">Rp ${finalSubtotal.toLocaleString()}</td>
      <td style="text-align:center;">
        <button class="small ghost" onclick="removeFromCart('${c.sku}')">-</button>
      </td>
    </tr>
    <tr>
      <td colspan="3" style="padding: 0; font-size: 11px;">
        <div style="display:flex; align-items:center; gap:4px;">
          <span class="muted">Promo:</span>
          <input type="number" 
                 value="${c.discount}" 
                 onchange="updateItemDiscount('${c.sku}', this.value)"
                 style="width:80px; padding:2px; font-size:11px; text-align:right;"
                 placeholder="0">
          <span class="muted">/unit</span>
        </div>
      </td>
    </tr>`;
  });

  html += "</table>";

  // Tampilkan total diskon per produk
  if (totals.perProductDiscountTotal > 0) {
    html += `<div style="margin-top:6px;color:#16a34a;font-weight:600">Total potongan promo: -${formatRupiahNumber(totals.perProductDiscountTotal)}</div>`;
  }
  // Tampilkan total diskon persen
  if (totals.percentDiscountAmount > 0) {
    html += `<div style="margin-top:4px;color:#16a34a;font-weight:600">Potongan diskon total: -${formatRupiahNumber(totals.percentDiscountAmount)} (${discountTotalPercent}%)</div>`;
  }

  el.innerHTML = html;
  count.textContent = cart.length;
  count2.textContent = cart.length;
  checkoutBtn.disabled = false;
  document.getElementById("total").textContent = "Rp " + totals.finalTotal.toLocaleString();

  if (pendingPaidInvoice) {
    document.getElementById("checkoutBtn").textContent = "Selesaikan Penjualan";
  } else {
    document.getElementById("checkoutBtn").textContent = "Bayar";
  }
}

function removeFromCart(sku){cart=cart.filter(c=>c.sku!==sku); renderCart()}
function clearCart(){ 
  cart=[]; 
  pendingPaidInvoice = null; 
  localStorage.removeItem('pendingPaidInvoice');
  renderCart()
}

/* ---------- printer preference ---------- */
function loadPrinterPreference(){
  const p = localStorage.getItem('preferredPrinter') || ''
  const sel = document.getElementById('printerSelect')
  if(sel) sel.value = p
}
function savePrinterPreference(){
  const sel = document.getElementById('printerSelect')
  if(!sel) return
  localStorage.setItem('preferredPrinter', sel.value)
  showToast(sel.value ? 'Preferensi printer disimpan: ' + sel.value : 'Preferensi printer dikosongkan')
}

/* Fungsi bantu untuk ubah tanggal dari localStorage */
function parseStoredDate(dateString) {
  if (!dateString) return new Date();
  // Jika sudah format ISO
  if (dateString.includes("T")) return new Date(dateString);
  // Jika format manual
  const parts = dateString.split(/[-/ :]/);
  return new Date(parts[0], parts[1] - 1, parts[2] || 1);
}

/* ---------- Restock load/export ---------- */
/* Perbaiki loadRestock agar aman tanpa error */
function loadRestock() {
  const restocks = JSON.parse(localStorage.getItem("restocks")) || [];
  const tbody = document.getElementById("restockTableBody");
  if (!tbody) return;

  tbody.innerHTML = "";

  // --- AWAL LOGIKA NOTIFIKASI BARU ---

  // 1. Cek apakah sama sekali belum ada data restock
  if (restocks.length === 0) {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="6" style="text-align:center;padding:10px" class="muted">Belum ada data restock.</td>`;
    tbody.appendChild(tr);
    showRestockAlert("ðŸ“­ Belum ada data restock sama sekali.");
    return;
  }

  // 2. Jika ada data, cek apakah ada yang masuk hari ini
  // Format tanggal di restocks adalah "YYYY-MM-DD HH:mm:ss", kita ambil bagian tanggalnya saja
  const today = new Date().toISOString().split('T')[0]; 
  const hasTodayRestock = restocks.some(r => r.date && r.date.startsWith(today));

  // Tampilkan data di tabel
  restocks.slice().reverse().forEach((r, i) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${i + 1}</td>
      <td>${r.date || "-"}</td>
      <td>${r.sku || "-"}</td>
      <td>${r.name || "-"}</td>
      <td>${r.qty || 0}</td>
      <td>${r.stockAfter || 0}</td>
    `;
    tbody.appendChild(tr);
  });

  // 3. Tampilkan notifikasi berdasarkan hasil pengecekan
  if (hasTodayRestock) {
    showRestockAlert("âœ… Laporan restok ditampilkan.");
  } else {
    showRestockAlert("ðŸ“­ Belum ada restock barang hari ini.");
  }
  // --- AKHIR LOGIKA NOTIFIKASI BARU ---
}
  
  /* ======== TOMBOL TAMPILKAN ======== */
function exportRestock() {
  const restocks = JSON.parse(localStorage.getItem("restocks")) || [];
  if (!restocks.length) {
    showRestockAlert("âš ï¸ Belum ada data restock untuk diekspor.");
    return;
  }

  let csv = "Tanggal,SKU,Nama,Jumlah,Stok Akhir\n";
  restocks.forEach(r => {
    csv += `${r.date},${r.sku},${r.name},${r.qty},${r.stockAfter}\n`;
  });

  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.href = url;
  link.download = "laporan_restock.csv";
  link.click();
  URL.revokeObjectURL(url);
  showRestockAlert("âœ… File CSV restock berhasil diunduh.");
}
  function exportRestockCSV() {
  const restocks = JSON.parse(localStorage.getItem("restocks")) || [];
  if (!restocks.length) {
    showRestockAlert("âš ï¸ Belum ada data restock untuk diekspor.");
    return;
  }

  let csv = "Tanggal,SKU,Nama,Jumlah,Stok Akhir\n";
  restocks.forEach(r => {
    csv += `${r.date},${r.sku},${r.name},${r.qty},${r.stockAfter}\n`;
  });

  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.href = url;
  link.download = "laporan_restock.csv";
  link.click();
  URL.revokeObjectURL(url);
  showRestockAlert("âœ… File CSV restock berhasil diunduh.");
}

  /* ======== EXPORT RESTOCK BULANAN ======== */
function exportRestockByMonth() {
  const monthInput = document.getElementById("restockMonth");
  if (!monthInput || !monthInput.value) {
    showRestockAlert("âš ï¸ Pilih bulan terlebih dahulu!");
    return;
  }

  const selectedMonth = monthInput.value; // contoh: "2025-10"
  const restocks = JSON.parse(localStorage.getItem("restocks")) || [];

  // Filter berdasarkan bulan (format tanggal di restocks pakai getLocalDateTime)
  const filtered = restocks.filter(r => r.date && r.date.startsWith(selectedMonth));

  if (!filtered.length) {
    showRestockAlert("ðŸ“­ Tidak ada data restock pada bulan tersebut.");
    return;
  }

  let csv = "Tanggal,SKU,Nama,Jumlah,Stok Akhir\n";
  filtered.forEach(r => {
    csv += `${r.date},${r.sku},${r.name},${r.qty},${r.stockAfter}\n`;
  });

  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.href = url;
  link.download = `laporan_restock_${selectedMonth}.csv`;
  link.click();
  URL.revokeObjectURL(url);

  showRestockAlert(`âœ… File CSV bulan ${selectedMonth} berhasil diunduh.`);
}

/* ======== TOMBOL CETAK ======== */
function printRestock() {
  const table = document.getElementById("restockTbl");
  if (!table) {
    showRestockAlert("âš ï¸ Tabel laporan restock tidak ditemukan!");
    return;
  }

  const printWindow = window.open("", "_blank");
  printWindow.document.write(`
    <html>
    <head>
      <title>Laporan Restock</title>
      <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #333; padding: 6px 8px; text-align: left; }
        th { background: #f2f2f2; }
        h2 { text-align: center; }
      </style>
    </head>
    <body>
      <h2>Laporan Restock (Barang Masuk)</h2>
      ${table.outerHTML}
    </body>
    </html>
  `);
  printWindow.document.close();
  printWindow.print();
}

// tombol "Clear Restock"
function clearRestocks() {
  if (!confirm("Yakin ingin menghapus semua data restock (barang masuk)?")) return;
  localStorage.removeItem("restocks");
  loadRestock();
  showRestockAlert("ðŸ—‘ï¸ Semua data restock berhasil dihapus.");
}

// tombol "Download Bulanan"
function exportRestockByRange() {
  const fromInput = document.getElementById("restockExportFrom");
  const toInput = document.getElementById("restockExportTo");

  if (!fromInput.value || !toInput.value) {
    showRestockAlert("âš ï¸ Lengkapi tanggal 'Dari' dan 'Sampai' terlebih dahulu!");
    return;
  }

  const start = new Date(fromInput.value);
  const end = new Date(toInput.value);
  if (start > end) {
    showRestockAlert("âš ï¸ Rentang tanggal tidak valid!");
    return;
  }

  const restocks = JSON.parse(localStorage.getItem("restocks")) || [];

  // Filter berdasarkan rentang tanggal
  const filtered = restocks.filter(r => {
    if (!r.date) return false;
    const d = new Date(r.date);
    return d >= start && d <= end;
  });

  if (!filtered.length) {
    showRestockAlert("ðŸ“­ Tidak ada data restock di rentang tanggal tersebut.");
    return;
  }

  let csv = "Tanggal,SKU,Nama,Jumlah,Stok Akhir\n";
  filtered.forEach(r => {
    csv += `${r.date},${r.sku},${r.name},${r.qty},${r.stockAfter}\n`;
  });

  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.href = url;
  link.download = `laporan_restock_${fromInput.value}_sd_${toInput.value}.csv`;
  link.click();
  URL.revokeObjectURL(url);

  showRestockAlert("âœ… File CSV berdasarkan rentang tanggal berhasil diunduh.");
}
/* ---------- PAYMENT FLOW (updated per request) ---------- */

/* open payment modal */
function checkout(){
  // if there is a pending paid invoice, prompt to finalize
  if(pendingPaidInvoice){
    // open receipt preview so user can finalize
    openReceiptPreview(pendingPaidInvoice);
    return;
  }

  if(cart.length === 0) return alert("Keranjang kosong")
  // open payment modal
  selectedPaymentMethod = null
  document.querySelectorAll('.pm-btn').forEach(b=>b.classList.remove('active'))
  document.getElementById('payDebug').textContent = ''
  const totals = computeCartTotals();
  document.getElementById('payTotal').textContent = "Rp " + totals.finalTotal.toLocaleString()
  document.getElementById('paymentModal').style.display = 'flex'
}

/* close payment modal */
function closePaymentModal(){
  document.getElementById('paymentModal').style.display = 'none'
  selectedPaymentMethod = null
}

/* select payment method */
function selectPaymentMethod(method, el){
  selectedPaymentMethod = method
  document.querySelectorAll('.pm-btn').forEach(b=>b.classList.remove('active'))
  if(el) el.classList.add('active')
  let info = ''
  if(method === 'cash') info = 'Pembayaran tunai: Terima uang tunai dari pelanggan dan kembalikan jika perlu.'
  if(method === 'transfer') info = 'Transfer bank: Tunjukkan nomor VA / rekening ke pembeli. Konfirmasi manual atau otomatis melalui gateway.'
  if(method === 'card') info = 'Kartu/EDC: Lakukan pembayaran melalui mesin EDC (fisik).'
  if(method === 'qris') info = 'QRIS / e-wallet: Tampilkan QR untuk dipindai pembeli. Setelah terbayar, konfirmasi.'
  const totals = computeCartTotals();
  document.getElementById('paymentInfoBox').innerHTML = `<div class="pay-instr">${info}</div><div>Total: <strong id="payTotal">Rp ${totals.finalTotal.toLocaleString()}</strong></div>`
}

/* confirm payment: immediately reduce stock, create pending transaction, show receipt preview (print allowed), but DO NOT finalize sale yet */
function confirmPayment(){
  if(!selectedPaymentMethod) return alert("Pilih metode pembayaran terlebih dahulu")
  if(cart.length === 0) return alert("Keranjang kosong")

  // disable button briefly
  const btn = document.getElementById('confirmPayBtn')
  btn.disabled = true
  btn.textContent = "Memproses..."
  setTimeout(()=> {
    // create invoice and transaction
    const invoice = 'INV' + Date.now()
    const now = new Date()
    const date = now.toISOString()
    const dateDisplay = now.toLocaleString()
    const totals = computeCartTotals();
    const total = totals.finalTotal;

    const transaction = {
      invoice,
      date,
      dateDisplay,
      items: JSON.parse(JSON.stringify(cart)), // snapshot of items
      total,
      // --- PERBAIKAN: Hapus diskonPerProductRp, gunakan data dari item ---
      discountTotalPercent: discountTotalPercent,
      totalsBreakdown: {
        subtotalBefore: totals.subtotalBefore,
        perProductDiscountTotal: totals.perProductDiscountTotal,
        percentDiscountAmount: totals.percentDiscountAmount,
        finalTotal: totals.finalTotal
      },
      method: selectedPaymentMethod,
      status: 'paid',      // already paid
      finalized: false,
      completedAt: null
    }

    // 1) reduce stock immediately (per request)
    transaction.items.forEach(it => {
      const p = products.find(x=>x.sku===it.sku)
      if(p){
        p.qty = Math.max(0, p.qty - it.qty)
      }
    })

    // 2) save products & sales (save as pending sale in sales list)
    sales.push(transaction)
    localStorage.setItem('sales', JSON.stringify(sales))
    localStorage.setItem('products', JSON.stringify(products))

    // 3) mark pendingPaidInvoice so UI shows "Selesaikan Penjualan"
    pendingPaidInvoice = invoice
    localStorage.setItem('pendingPaidInvoice', invoice)

    // 4) close payment modal and show receipt preview modal with transaction details
    btn.disabled = false
    btn.textContent = "Konfirmasi Pembayaran"
    closePaymentModal()
    renderCart(); renderFinalStock(); loadRestock()

    // open preview
    openReceiptPreview(invoice)

    showToast("Pembayaran tercatat. Cetak struk atau selesaikan penjualan untuk memasukkan laporan.")
  }, 700)
}

/* open receipt preview modal for given invoice */
function openReceiptPreview(invoice){
  const tx = sales.find(s=>s.invoice===invoice)
  if(!tx) return alert("Transaksi tidak ditemukan")
  const modal = document.getElementById('receiptPreviewModal')
  const content = document.getElementById('receiptPreviewContent')

  // build items with original price struck and discounted price
  let itemsHtml = `<table style="width:100%;margin-top:8px;border-collapse:collapse">
      <thead><tr><th style="text-align:left">Nama</th><th style="text-align:center">Qty</th><th style="text-align:right">Harga Normal</th></tr></thead>
      <tbody>`
  tx.items.forEach(i=>{
    const normal = i.price * i.qty;
    // --- PERBAIKAN: Gunakan diskon dari item (i.discount) ---
    const perItemDiscount = Math.min(normal, (i.discount || 0) * i.qty);
    const afterPerItem = normal - perItemDiscount;
    itemsHtml += `<tr><td>${i.name}</td><td style="text-align:center">${i.qty}</td><td style="text-align:right"><del>Rp ${normal.toLocaleString()}</del><br/>Rp ${afterPerItem.toLocaleString()}${perItemDiscount>0?` <small style=\"color:#16a34a\">(-${formatRupiahNumber(perItemDiscount)})</small>`:''}</td></tr>`;
  })
  itemsHtml += `</tbody></table>`;

  let summaryHtml = `<div style="text-align:right;margin-top:8px;font-weight:600">Subtotal sebelum diskon: Rp ${tx.totalsBreakdown.subtotalBefore.toLocaleString()}</div>`;
  if(tx.totalsBreakdown.perProductDiscountTotal > 0){
    summaryHtml += `<div style="text-align:right;color:#16a34a">Potongan per produk: -${formatRupiahNumber(tx.totalsBreakdown.perProductDiscountTotal)}</div>`;
  }
  if(tx.totalsBreakdown.percentDiscountAmount > 0){
    summaryHtml += `<div style="text-align:right;color:#16a34a">Diskon total belanja (${tx.discountTotalPercent}%): -${formatRupiahNumber(tx.totalsBreakdown.percentDiscountAmount)}</div>`;
  }
  summaryHtml += `<div style="text-align:right;margin-top:6px;font-size:1.1rem">Total akhir: Rp ${tx.totalsBreakdown.finalTotal.toLocaleString()}</div>`;

  content.innerHTML = `<div class="muted">Invoice: <strong>${tx.invoice}</strong></div>
    <div class="muted">Tanggal: ${tx.dateDisplay || tx.date}</div>
    ${itemsHtml}
    ${summaryHtml}
    <div style="margin-top:6px" class="muted">Metode: ${tx.method || '-'}</div>
  `
  document.getElementById('receiptPreviewModal').style.display = 'flex'
}

/* close receipt preview */
function closeReceiptPreview(){
  document.getElementById('receiptPreviewModal').style.display = 'none'
}

/* print pending receipt (does NOT finalize sale) */
function printPendingReceipt(){
  if(!pendingPaidInvoice) return alert("Tidak ada struk yang bisa dicetak.")
  const tx = sales.find(s=>s.invoice===pendingPaidInvoice)
  if(!tx) return alert("Transaksi tidak ditemukan")
  try{
    printReceipt(tx)
    showToast("Dialog cetak terbuka.")
  }catch(e){
    alert("Gagal membuka dialog cetak: " + e)
  }
}

/* finalizePendingSale: mark sale as finalized and add to daily report. This does NOT change stock (already reduced on confirm). */
function finalizePendingSale(){
  if(!pendingPaidInvoice) return alert("Tidak ada transaksi untuk diselesaikan.")
  const idx = sales.findIndex(s => s.invoice === pendingPaidInvoice)
  if(idx === -1) return alert("Transaksi tidak ditemukan")
  const tx = sales[idx]
  if(tx.finalized){
    showToast("Transaksi sudah diselesaikan.")
    document.getElementById('receiptPreviewModal').style.display = 'none'
    pendingPaidInvoice = null
    localStorage.removeItem('pendingPaidInvoice')
    renderCart(); render(); renderFinalStock();
    return
  }

  tx.finalized = true
  tx.status = 'completed'
  tx.completedAt = getLocalDateTime()
  sales[idx] = tx
  localStorage.setItem('sales', JSON.stringify(sales))

  // clear pending, clear cart (sale has been finalized)
  pendingPaidInvoice = null
  localStorage.removeItem('pendingPaidInvoice')
  cart = []

  // ðŸ”¥ Tambahkan render() di sini
  renderCart(); render(); renderFinalStock(); loadRestock()

  document.getElementById('receiptPreviewModal').style.display = 'none'
  showToast("Penjualan diselesaikan.")
}


/* finishSale kept for backward compat (calls finalizePendingSale) */
function finishSale(invoice){
  // Mark finalized if exists
  const idx = sales.findIndex(s => s.invoice === invoice)
  if(idx === -1) return alert("Transaksi tidak ditemukan")
  const tx = sales[idx]
  if(tx.finalized){
    showToast("Transaksi sudah diselesaikan.")
    return
  }
  // finalize
  tx.finalized = true
  tx.status = 'completed'
  tx.completedAt = getLocalDateTime()
  sales[idx] = tx
  localStorage.setItem('sales', JSON.stringify(sales))

  // clear pending
  pendingPaidInvoice = null
  localStorage.removeItem('pendingPaidInvoice')
  cart = []
  renderCart(); renderFinalStock(); loadRestock()
  showToast("Penjualan selesai.")
}

/* ---------- print receipt (opens print dialog) ---------- */

function printReceipt(t){
  let html = `<div style="font-family:Arial,Helvetica,sans-serif;font-size:12px;padding:8px">`
  html += `<h3 style="margin:4px 0">Struk Pembelian</h3>`
  html += `<div>Invoice: ${t.invoice}</div>`
  html += `<div>Tanggal: ${t.dateDisplay || t.date || getLocalDateTime()}</div>`
  html += `<div>Metode: ${t.method || '-'}</div>`
  html += `<hr/>`
  html += `<table style="width:100%;border-collapse:collapse;font-size:12px">`
  html += `<tr><th align="left">Nama</th><th>Qty</th><th align="right">Harga</th></tr>`
  t.items.forEach(i=>{
    const normal = i.price * i.qty;
    // --- PERBAIKAN: Gunakan diskon dari item (i.discount) ---
    const perItemDiscount = Math.min(normal, (i.discount || 0) * i.qty);
    const afterPerItem = normal - perItemDiscount;
    html += `<tr><td>${i.name}</td><td style="text-align:center">${i.qty}</td><td style="text-align:right"><del>Rp ${normal.toLocaleString()}</del><br/>Rp ${afterPerItem.toLocaleString()}${perItemDiscount>0?` (-${formatRupiahNumber(perItemDiscount)})`:''}</td></tr>`
  })
  html += `</table><hr/>`
  // summary
  html += `<div style="text-align:right">Subtotal sebelum diskon: Rp ${t.totalsBreakdown.subtotalBefore.toLocaleString()}</div>`
  if(t.totalsBreakdown.perProductDiscountTotal > 0){
    html += `<div style="text-align:right;color:#16a34a">Potongan per produk: -${formatRupiahNumber(t.totalsBreakdown.perProductDiscountTotal)}</div>`
  }
  if(t.totalsBreakdown.percentDiscountAmount > 0){
    html += `<div style="text-align:right;color:#16a34a">Diskon total belanja (${t.discountTotalPercent}%): -${formatRupiahNumber(t.totalsBreakdown.percentDiscountAmount)}</div>`
  }
  html += `<h4 style="text-align:right;margin:6px 0">Total akhir: Rp ${t.totalsBreakdown.finalTotal.toLocaleString()}</h4>`
  html += `</div>`

  const w = window.open("","_blank","width=400,height=600")
  if(!w) {
    throw new Error("Popup blocked")
  }
  w.document.write(html)
  w.document.close()
  w.focus()
  try{
    w.print()
    setTimeout(()=>{ try{ w.close() }catch(e){} }, 1200)
  }catch(e){
    try{ w.close() }catch(_) {}
    throw e
  }
}

  function printSales() {
  const table = document.getElementById("salesTbl");
  if (!table) {
    showSalesAlert("âš ï¸ Tabel laporan penjualan tidak ditemukan.");
    return;
  }

  // buat jendela print baru khusus tabel penjualan
  const printWindow = window.open("", "_blank");
  printWindow.document.write(`
    <html>
      <head>
        <title>Laporan Penjualan</title>
        <style>
          body { font-family: Arial, sans-serif; margin: 20px; }
          table { border-collapse: collapse; width: 100%; }
          th, td { border: 1px solid #444; padding: 8px 10px; text-align: left; }
          th { background: #f2f2f2; }
          h2 { text-align: center; margin-bottom: 20px; }
          @media print {
            body { margin: 0; }
          }
        </style>
      </head>
      <body>
        <h2>Laporan Penjualan</h2>
        ${table.outerHTML}
      </body>
    </html>
  `);
  printWindow.document.close();
  printWindow.focus();
  printWindow.print();
}
  function clearSales() {
  // konfirmasi sebelum hapus
  if (!confirm("Yakin ingin menghapus semua data laporan penjualan?")) return;

  // hapus semua data penjualan dari localStorage
  localStorage.removeItem("sales");

  // bersihkan tabel di halaman
  const tbody = document.querySelector("#salesTbl tbody");
  if (tbody) tbody.innerHTML = "";

  // tampilkan notifikasi sukses
  showSalesAlert("ðŸ—‘ï¸ Semua data laporan penjualan berhasil dihapus.");

  // refresh tampilan
  loadSales(); renderSalesTable();
}
  function clearSalesByRange() {
  const fromEl = document.getElementById("filterFrom");
  const toEl = document.getElementById("filterTo");

  // validasi input tanggal
  if (!fromEl.value || !toEl.value) {
    showSalesAlert("âš ï¸ Lengkapi tanggal From & To terlebih dahulu!");
    return;
  }

  const start = new Date(fromEl.value);
  const end = new Date(toEl.value);
  if (start > end) {
    showSalesAlert("âš ï¸ Rentang tanggal tidak valid!");
    return;
  }

  const sales = JSON.parse(localStorage.getItem("sales")) || [];
  if (!sales.length) {
    showSalesAlert("ðŸ“­ Tidak ada data penjualan untuk dihapus.");
    return;
  }

  // filter hanya data di luar rentang (biar yang di range kehapus)
  const kept = sales.filter(s => {
    const d = new Date(s.date || s.dateDisplay || "");
    return !(d >= new Date(start.setHours(0,0,0,0)) && d <= new Date(end.setHours(23,59,59,999)));
  });

  // simpan ulang data yang tersisa
  localStorage.setItem("sales", JSON.stringify(kept));

  // refresh tabel
  loadSales(); renderSalesTable();

  // notifikasi sukses
  showSalesAlert("ðŸ—‘ï¸ Data laporan penjualan dalam rentang tanggal berhasil dihapus.");
}

/* ---------- SCAN and GUIDE etc (unchanged) ---------- */
/* ---------- SCAN (dengan handling stok 0 & not found) ---------- */
let html5QrcodeScanner = null;
let scanTarget = null;

function openCamera(target) {
  // ensure scanTarget is set so handleScan can behave differently
  scanTarget = target;
  const camModal = document.getElementById('cameraModal');
  camModal.style.display = 'flex';
  camModal.style.pointerEvents = 'auto';
  camModal.style.zIndex = '9000';
  hideCameraAlert()

  if (html5QrcodeScanner) return;
  html5QrcodeScanner = new Html5Qrcode("cameraReader");
  const config = { fps: 10, qrbox: 250 };

  html5QrcodeScanner.start({ facingMode: "environment" }, config, msg => {
    handleScan(msg);
    // for sale scanning, we stop inside handleScan when mode=single
  }).catch(err => {
    console.error(err);
    alert("Gagal mengakses kamera: " + err);
  });
}

function stopCamera() {
  if (html5QrcodeScanner) {
    html5QrcodeScanner.stop().catch(()=>{}).finally(() => {
      html5QrcodeScanner = null;
      document.getElementById("cameraReader").innerHTML = "";
    });
  }
  const camModal = document.getElementById('cameraModal');
  if (camModal) {
    camModal.style.display = "none";
    camModal.style.pointerEvents = "none";
  }
  hideCameraAlert()
}

function closeCamera() { stopCamera(); }

function showCameraAlert(message){
  try{ if(html5QrcodeScanner) { html5QrcodeScanner.stop().catch(()=>{}); html5QrcodeScanner=null; } }catch(e){}
  const alertEl = document.getElementById('cameraAlert')
  const msgEl = document.getElementById('cameraAlertMsg')
  if(msgEl) msgEl.textContent = message
  if(alertEl) alertEl.style.display = 'block'
}

function hideCameraAlert(){
  const alertEl = document.getElementById('cameraAlert')
  if(alertEl) alertEl.style.display = 'none'
}

function closeCameraAlert(){
  hideCameraAlert()
  closeCamera()
}

/* ---------- REPLACED handleScan: mode-aware (sku/restock/sell) ---------- */
function handleScan(msg) {
  const sku = String(msg).trim();

  // Mode: filling SKU for Add Product form
  if (scanTarget === 'sku') {
    const skuInput = document.getElementById('sku');
    if (skuInput) {
      skuInput.value = sku;
      // focus next field so user can continue entering product data
      const nameInput = document.getElementById('name');
      if (nameInput) nameInput.focus();
      showToast('SKU dipindai: ' + sku, 1400);
    }
    // close camera after filling SKU
    stopCamera();
    return;
  }

  // Mode: restock selection (optional)
  if (scanTarget === 'restock') {
    const p = products.find(x => x.sku === sku);
    if (!p) {
      showCameraAlert("Produk tidak ditemukan di daftar. Tambahkan produk terlebih dahulu.");
      return;
    }
    const sel = document.getElementById('restockName');
    if (sel) {
      // add option if not present
      if (!Array.from(sel.options).some(o => o.value === sku)) {
        const opt = document.createElement('option');
        opt.value = sku;
        opt.textContent = p.name;
        sel.appendChild(opt);
      }
      sel.value = sku;
      const qtyEl = document.getElementById('restockQty');
      if (qtyEl) qtyEl.focus();
      showToast('Produk dipilih untuk restock: ' + p.name, 1400);
    }
    stopCamera();
    return;
  }

  // Default: sale-scan behavior (add to cart)
  const p = products.find(x => x.sku === sku);
  if (!p) {
    showCameraAlert("Produk tidak ditemukan di daftar. Tambahkan produk terlebih dahulu.");
    return;
  }
  if (p.qty <= 0) {
    showCameraAlert("Produk telah habis, isi stok dahulu");
    return;
  }

  addToCart(sku);

  if (document.getElementById("scanMode")?.value === "single") {
    stopCamera();
  }
}

function scanSku() { openCamera("sku"); }
function startScan(target) { openCamera(target); }

  /* ============================================================
   ðŸ”¹ SUPPORT ALAT SCANNER BARCODE (USB / Bluetooth / External)
   ============================================================ */

let scannerBuffer = "";
let scannerTimer = null;

// Deteksi input dari alat scanner (emulasi keyboard)
document.addEventListener("keydown", function (e) {
  const active = document.activeElement;
  const activeTag = active ? active.tagName.toLowerCase() : "";

  // Jika mengetik manual di input atau textarea, abaikan
  if (activeTag === "input" || activeTag === "textarea") return;

  // Jika scanner mengirim "Enter", artinya scan selesai
  if (e.key === "Enter") {
    //const scannedCode = scannerBuffer.trim();
    let scannedCode = scannerBuffer.trim();
    // buang karakter aneh dari hasil scanner (Shift, ctrl code, dsb)
    scannedCode = scannedCode.replace(/shift|ctrl|alt|\(|\)|[^\w\-]/gi, "");
    scannerBuffer = "";
    if (!scannedCode) return;

    // Cek apakah sedang di mode tambah produk (input SKU)
    const skuInput = document.getElementById("sku");
    if (skuInput && document.hasFocus && skuInput === document.activeElement) {
      skuInput.value = scannedCode;
      showToast(`ðŸ“¦ SKU diisi: ${scannedCode}`);
      return;
    }

    // Kalau tidak, berarti sedang mode penjualan â†’ cari produk
    const product = products.find(p => p.sku === scannedCode);
    if (product) {
      addToCart(product.sku);
      showToast(`âœ… ${product.name} ditambahkan ke keranjang`);
    } else {
      showToast(`âš ï¸ Produk dengan kode "${scannedCode}" tidak ditemukan`);
    }
    return;
  }

  // Gabungkan karakter hasil scan ke buffer (scanner cepat <300ms)
  if (scannerTimer) clearTimeout(scannerTimer);
  scannerBuffer += e.key;
  scannerTimer = setTimeout(() => (scannerBuffer = ""), 300);
});

  function scanSku() {
  try {
    openCamera("sku");
  } catch (err) {
    showToast("ðŸ“· Kamera tidak tersedia, gunakan alat scanner fisik.");
  }
}


/* === GUIDE INTERAKTIF (IIFE) simplified reference (kept as before) === */
(function(){
  window.guideSteps = window.guideSteps || [
    { selector: "#formProduct", text: "ðŸ§¾ Tambahkan produk baru di sini. Isi kode, nama, harga, dan stok." },
    { selector: "#formRestock", text: "ðŸ“¦ Tambah stok barang yang sudah ada dengan form Restock ini." },
    { selector: "#tbl", text: "ðŸ“‹ Daftar semua produk kamu muncul di tabel ini. Bisa diedit atau dihapus." },
    { selector: "#btnStartScan", text: "ðŸ“¸ Gunakan fitur Scan untuk menambah produk ke keranjang lewat kamera." },
    { selector: "#cart", text: "ðŸ›’ Semua barang yang kamu jual akan muncul di keranjang ini." },
    { selector: "#checkoutBtn", text: "ðŸ’° Setelah selesai, tekan tombol ini untuk menyelesaikan penjualan (setelah bayar)." },
  ];

  let currentStep = 0;
  let highlightBox = null;
  let tooltip = null;
  let resizeHandler = null;
  window.guideActive = false;

  function createGuideElements(){
    if(!highlightBox){
      highlightBox = document.createElement("div");
      highlightBox.id = "highlightBox";
      highlightBox.style.position = "absolute";
      highlightBox.style.border = "2px solid #0b74da";
      highlightBox.style.borderRadius = "10px";
      highlightBox.style.background = "rgba(11, 116, 218, 0.12)";
      highlightBox.style.zIndex = "100000";
      highlightBox.style.pointerEvents = "none";
      highlightBox.style.transition = "top 260ms cubic-bezier(.22,.9,.35,1), left 260ms cubic-bezier(.22,.9,.35,1), width 260ms cubic-bezier(.22,.9,.35,1), height 260ms cubic-bezier(.22,.9,.35,1)";
      document.body.appendChild(highlightBox);
    }

    if(!tooltip){
      tooltip = document.createElement("div");
      tooltip.id = "guideTooltip";
      tooltip.style.position = "absolute";
      tooltip.style.background = "#fff";
      tooltip.style.borderRadius = "8px";
      tooltip.style.boxShadow = "0 6px 20px rgba(0,0,0,0.15)";
      tooltip.style.padding = "12px";
      tooltip.style.maxWidth = "320px";
      tooltip.style.zIndex = "100001";
      tooltip.style.fontSize = "13px";
      tooltip.style.pointerEvents = "auto";
      tooltip.style.opacity = 0;
      tooltip.style.transform = "translateY(6px)";
      tooltip.style.transition = "opacity 220ms cubic-bezier(.22,.9,.35,1), transform 220ms cubic-bezier(.22,.9,.35,1)";
      document.body.appendChild(tooltip);
    }

    if(!resizeHandler){
      resizeHandler = () => {
        if(window.guideActive){
          setTimeout(()=> {
            if(window.guideActive) showStep(currentStep)
          }, 80)
        }
      };
      window.addEventListener('resize', resizeHandler)
    }
  }

  // showStep (kept from previous implementation; it's long - works as earlier)
  async function showStep(i) {
    const steps = window.guideSteps || [];
    if (!steps || steps.length === 0) return endGuide();
    if (i < 0) i = 0;
    if (i >= steps.length) return endGuide();

    currentStep = i;
    const step = steps[i];
    if (!step || !step.selector) {
      setTimeout(nextGuide, 60);
      return;
    }

    const el = document.querySelector(step.selector);
    if (!el) {
      console.warn("Guide: element not found:", step.selector);
      setTimeout(nextGuide, 60);
      return;
    }

    createGuideElements();

    function skipGuide(){
      window.guideActive = false;
    try {
      document.getElementById("highlightBox")?.remove();
      document.getElementById("guideTooltip")?.remove();
    } catch(e){}
      showToast("Panduan dihentikan.");
    }

    // Helper: wait for scroll to settle by observing scroll events and element bounding changes
    function waitForElementCentered(element, timeout = 900, settleMs = 110, tolerancePx = 36) {
      return new Promise((resolve) => {
        let lastChange = Date.now();
        const start = Date.now();

        // track last bounding rect center
        let lastCenter = null;

        const checkCenter = () => {
          const r = element.getBoundingClientRect();
          const elemCenterY = r.top + r.height / 2;
          const viewportCenterY = window.innerHeight / 2;
          const distance = Math.abs(elemCenterY - viewportCenterY);

          // if center within tolerance, and no further movement for settleMs, consider centered
          if (distance <= tolerancePx) {
            // if lastCenter null -> set it and wait settleMs
            if (lastCenter === null) {
              lastCenter = elemCenterY;
              lastChange = Date.now();
            } else {
              // if center not changed significantly for settleMs -> done
              if (Math.abs(lastCenter - elemCenterY) < 2 && (Date.now() - lastChange) > settleMs) {
                resolve(true);
                return;
              } else {
                lastCenter = elemCenterY;
                lastChange = Date.now();
              }
            }
          } else {
            // not yet centered -> update lastCenter and continue
            lastCenter = elemCenterY;
            lastChange = Date.now();
          }

          // timeout fallback
          if (Date.now() - start > timeout) {
            resolve(false);
            return;
          }

          requestAnimationFrame(checkCenter);
        };

        // start small delay to let smooth scroll begin
        setTimeout(() => {
          requestAnimationFrame(checkCenter);
        }, 30);
      });
    }

    try {
      el.scrollIntoView({ behavior: "smooth", block: "center", inline: "nearest" });
    } catch (e) {
      try { el.scrollIntoView(true); } catch (e) {}
    }

    await waitForElementCentered(el, 1200, 120, 40);
    await new Promise(r => setTimeout(r, 28));

    const rect = el.getBoundingClientRect();
    const padding = 8;
    const targetTop = rect.top + window.scrollY - padding;
    const targetLeft = rect.left + window.scrollX - padding;
    const targetWidth = Math.max(80, rect.width + padding * 2) + "px";
    const targetHeight = Math.max(36, rect.height + padding * 2) + "px";

    highlightBox.style.display = "block";
    highlightBox.style.width = targetWidth;
    highlightBox.style.height = targetHeight;
    highlightBox.style.top = targetTop + "px";
    highlightBox.style.left = targetLeft + "px";

    tooltip.style.transition = "opacity 140ms cubic-bezier(.22,.9,.35,1), transform 180ms cubic-bezier(.22,.9,.35,1)";
    tooltip.style.opacity = 0;
    tooltip.style.transform = "translateY(6px)";

    await new Promise(r => setTimeout(r, 130));

    const isLast = i === steps.length - 1;
    tooltip.innerHTML = `
      <div style="margin-bottom:8px">${step.text || ""}</div>
      <div style="text-align:right">
        <button id="guideNextBtn" style="background:#0b74da;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer">
          ${isLast ? "Selesai" : "Lanjut âžœ"}
        </button>
      </div>
    `;

    // adaptive placement (same as before)...
    const defaultTooltipWidth = 320;
    const tooltipHeight = 140;
    const spaceBelow = window.innerHeight - rect.bottom;
    let tooltipTop;
    let left = rect.left + window.scrollX;
    let tooltipWidth = defaultTooltipWidth;

    if (step.selector === '#checkoutBtn') {
      const spaceRight = window.innerWidth - rect.right;
      const spaceLeft = rect.left;
      const topCentered = rect.top + window.scrollY + (rect.height / 2) - (tooltipHeight / 2);

      if (spaceRight > tooltipWidth + 20) {
        tooltipTop = topCentered;
        left = rect.right + window.scrollX + 12;
      } else if (spaceLeft > tooltipWidth + 20) {
        tooltipTop = topCentered;
        left = rect.left + window.scrollY - tooltipWidth - 12;
      } else {
        if (spaceBelow > tooltipHeight + 20) {
          tooltipTop = rect.bottom + window.scrollY + 12;
        } else if (rect.top > tooltipHeight + 20) {
          tooltipTop = rect.top + window.scrollY - tooltipHeight - 12;
        } else {
          tooltipTop = topCentered;
        }
        left = Math.min(Math.max(rect.left + window.scrollY - 40, 10), window.innerWidth + window.scrollX - (tooltipWidth + 40));
      }
    } else if (step.selector === '#btnStartScan') {
      tooltipWidth = 260;
      const spaceRight = window.innerWidth - rect.right;
      const spaceLeft = rect.left;
      const verticalCenter = rect.top + window.scrollY + (rect.height / 2);

      if (spaceRight >= tooltipWidth + 12) {
        tooltipTop = verticalCenter - (tooltipHeight / 2);
        left = rect.right + window.scrollX + 10;
      } else if (spaceLeft >= tooltipWidth + 12) {
        tooltipTop = verticalCenter - (tooltipHeight / 2);
        left = rect.left + window.scrollX - tooltipWidth - 10;
      } else {
        if (spaceBelow > tooltipHeight + 12) {
          tooltipTop = rect.bottom + window.scrollY + 10;
        } else if (rect.top > tooltipHeight + 12) {
          tooltipTop = rect.top + window.scrollY - tooltipHeight - 10;
        } else {
          tooltipTop = window.scrollY + window.innerHeight / 2 - tooltipHeight / 2;
        }
        left = rect.left + window.scrollY + (rect.width / 2) - (tooltipWidth / 2);
      }

      const minLeft = window.scrollX + 8;
      const maxLeft = window.scrollX + window.innerWidth - (tooltipWidth + 8);
      left = Math.min(Math.max(left, minLeft), Math.max(minLeft, maxLeft));

      const minTop = window.scrollY + 8;
      const maxTop = window.scrollY + window.innerHeight - (tooltipHeight + 8);
      tooltipTop = Math.min(Math.max(tooltipTop, minTop), Math.max(minTop, maxTop));

      tooltip.style.maxWidth = tooltipWidth + "px";
    } else {
      tooltipWidth = defaultTooltipWidth;
      tooltip.style.maxWidth = tooltipWidth + "px";

      if (spaceBelow > tooltipHeight + 20) {
        tooltipTop = rect.bottom + window.scrollY + 12;
      } else if (rect.top > tooltipHeight + 20) {
        tooltipTop = rect.top + window.scrollY - tooltipHeight - 12;
      } else {
        tooltipTop = window.scrollY + window.innerHeight / 2 - tooltipHeight / 2;
      }

      if (left + tooltipWidth > window.innerWidth + window.scrollX - 10) {
        left = window.innerWidth + window.scrollX - tooltipWidth - 10;
      }
      if (left < 10) left = 10;
    }

    tooltip.style.left = (left || 10) + "px";
    tooltip.style.top = (tooltipTop || (window.scrollY + 20)) + "px";
    tooltip.style.display = "block";

    requestAnimationFrame(() => {
      tooltip.style.opacity = 1;
      tooltip.style.transform = "translateY(0)";
    });

    const nextBtn = document.getElementById("guideNextBtn");
    if (nextBtn) {
      nextBtn.onclick = function (e) {
        e.preventDefault();
        nextBtn.disabled = true;
        setTimeout(()=> nextGuide(), 80);
      };
    }
  }

  function nextGuide(){
    currentStep++;
    if(currentStep >= window.guideSteps.length){
      endGuide();
    } else {
      showStep(currentStep);
    }
  }

  function endGuide(){
    window.guideActive = false;
    if(highlightBox){ highlightBox.remove(); highlightBox = null; }
    if(tooltip){ tooltip.remove(); tooltip = null; }
    if(resizeHandler){
      try{ window.removeEventListener('resize', resizeHandler) }catch(e){}
      resizeHandler = null;
    }
    const overlay = document.getElementById("guideOverlay");
    if(overlay) overlay.style.display = "none";
    currentStep = 0;
    setTimeout(()=>{ showToast("ðŸŽ‰ Tutorial selesai!",1600); }, 80);
  }

  function startGuide(){
    const overlay = document.getElementById("guideOverlay");
    if(overlay) overlay.style.display = "none";
    currentStep = 0;
    window.guideActive = true;
    createGuideElements();
    showStep(0);
  }

  function skipGuide(){
    window.guideActive = false;
    const overlay = document.getElementById("guideOverlay");
    if(overlay) overlay.style.display = "none";
    if(typeof endGuide === "function") endGuide();
  }

  window.createGuideElements = createGuideElements;
  window.showStep = showStep;
  window.nextGuide = nextGuide;
  window.endGuide = endGuide;
  window.startGuide = startGuide;
  window.skipGuide = skipGuide;
})();

/* ---------- REPORTS & CSV ---------- */
/* loadSales now only shows finalized transactions (as requested) */
function loadSales(){
  const from = document.getElementById("filterFrom").value;
  const to = document.getElementById("filterTo").value;
  const tbl = document.querySelector("#salesTbl tbody");
  tbl.innerHTML = "";

  let counter = 1;
  let foundData = false; // Tambahkan penanda untuk mengecek apakah ada data

  sales.forEach((s) => {
    if (!s.finalized) return; // only include finalized sales
    const dObj = new Date(s.date);
    const d = s.dateDisplay || dObj.toLocaleString();

    let valid = true;
    if (from && dObj < new Date(from)) valid = false;
    if (to && dObj > new Date(to)) valid = false;

    if (valid) {
      foundData = true; // Tandai bahwa ada data yang cocok
      tbl.innerHTML += `
        <tr>
          <td>${counter}</td>
          <td>${d}</td>
          <td>${s.invoice}</td>
          <td>${s.items.map(x => x.name + " x" + x.qty).join(", ")}</td>
          <td>Rp ${s.total.toLocaleString()}</td>
        </tr>`;
      counter++;
    }
  });

  // Tampilkan notifikasi berdasarkan hasil pencarian
  if (foundData) {
    showToast("âœ… Laporan penjualan ditampilkan.");
  } else {
    showToast("ðŸ“­ Tidak ada data penjualan pada rentang tanggal tersebut.");
  }
}

/* export only finalized sales */
function exportSales(){
  const finalized = sales.filter(s => s.finalized)
  if(finalized.length === 0) return alert("Tidak ada data penjualan");

  let csv = "No;Tanggal;Invoice;Item;Total\n";
  let counter = 1;

  finalized.forEach((s) => {
    const d = getCsvDateFromRecord(s);
    const items = s.items.map(x => `${x.name} x${x.qty}`).join(" | ");
    csv += `${counter};"${d}";"${s.invoice}";"${items}";"${s.total}"\n`;
    counter++;
  });

  downloadCSV(csv, "laporan_penjualan.csv");
}

/* ---------- helper downloadCSV ---------- */
function downloadCSV(content, filename){
  const blob = new Blob([content], { type: "text/csv;charset=utf-8;" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = filename;
  link.style.display = "none";
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

/* ---------- final stock rendering ---------- */
function renderFinalStock(){
  const tbl=document.querySelector("#finalStockTbl tbody")
  tbl.innerHTML=""
  products.forEach((p,i)=>{
    tbl.innerHTML+=`<tr><td>${i+1}</td><td>${p.sku}</td><td>${p.name}</td><td>${p.qty}</td><td>Rp ${p.price.toLocaleString()}</td></tr>`
  })
}

/* ---------- INIT ---------- */
  function openTab(id){
  // remove active state
  document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
  document.querySelectorAll(".tab-content").forEach(c=>c.classList.remove("active"));

  // set active on the button (robust selector)
  let btn = document.querySelector(`.tab-btn[onclick*="openTab('${id}')"]`);
  if(!btn){
    // fallback: match double quotes variant
    btn = document.querySelector(`.tab-btn[onclick*='openTab("${id}")']`);
  }
  if(btn) btn.classList.add("active");

  // show content
  const content = document.getElementById(id);
  if(content) content.classList.add("active");

  // call appropriate loader so tables are populated when tab opens
  if(id === 'restock'){
    // populate restock table immediately
    try { loadRestock(); } catch(e){ console.error('loadRestock error', e); }
  } else if(id === 'stok'){
    // render final stock table
    try { renderFinalStock(); } catch(e){ console.error('renderFinalStock error', e); }
  } else if(id === 'penjualan'){
    // for sales tab, call loadSales to apply filters if any
    try { loadSales(); renderSalesTable(); } catch(e){ console.error('loadSales error', e); }
  }
}
function init(){
  const autoPrintEl = document.getElementById('autoPrint')
  if(autoPrintEl) autoPrintEl.checked = false

  loadPrinterPreference()

  pendingPaidInvoice = localStorage.getItem('pendingPaidInvoice') || pendingPaidInvoice

  // migrate dateDisplay if needed
  let updated = false
  sales.forEach(s => {
    if(s.date && !s.dateDisplay){
      let dObj = new Date(s.date)
      if(isNaN(dObj)){
        const parts = s.date.split(" ")
        if(parts.length === 2){
          const [d,m,y] = parts[0].split("-")
          const [hh,mm,ss] = parts[1].split(":")
          if(d && m && y){
            dObj = new Date(y, parseInt(m)-1, d, hh||0, mm||0, ss||0)
          }
        }
      }
      if(dObj && !isNaN(dObj)){
        s.dateDisplay = dObj.toLocaleString()
        updated = true
      } else {
        s.dateDisplay = s.date
        updated = true
      }
    }
  })
  if(updated) localStorage.setItem("sales", JSON.stringify(sales))

  render(); renderFinalStock(); setInterval(renderFinalStock,5000)
  const guideOv = document.getElementById("guideOverlay");
  if(guideOv) guideOv.style.display = "flex";
}

init();
  

/* ======= CLIENT STRONG-HARDENING ======= */
(function(){
  'use strict';

  // small toast fallback
  const _toast = (typeof showToast === 'function') ? showToast : (m=>alert(m));

  // quick helper: safe JSON parse
  const safeParse = (s, def)=>{ try{ return JSON.parse(s); }catch(e){ return def; }};

  // ----- 0) Build authoritative snapshots from current localStorage (if any) -----
  const __snapshots = {
    products: safeParse(localStorage.getItem('products'), []),
    sales: safeParse(localStorage.getItem('sales'), []),
    restocks: safeParse(localStorage.getItem('restocks'), [])
  };
  try {
    Object.defineProperty(window, '__SNAPSHOTS', { value: JSON.parse(JSON.stringify(__snapshots)), writable:false, configurable:false });
  } catch(e){}

  // ----- 1) Prevent iframe embedding -----
  try { if (window.top !== window.self) { document.documentElement.innerHTML = '<div style="padding:20px;font-family:Arial">Unauthorized frame</div>'; throw 'iframe'; } } catch(e){}

  // ----- 2) Disable context menu and many shortcuts (best-effort) -----
  document.addEventListener('contextmenu', function(e){ if(!e.shiftKey) e.preventDefault(); }, {capture:true});
  document.addEventListener('keydown', function(e){
    if(e.shiftKey) return; // allow override by power user
    const K = (e.key||'').toUpperCase();
    if (K === 'F12' || (e.ctrlKey && e.shiftKey && (K==='I'||K==='J'||K==='C')) || (e.ctrlKey && (K==='U'||K==='S'||K==='A')) ){
      e.preventDefault(); e.stopPropagation();
      _toast('Akses devtools dibatasi. Tekan Shift+F12 jika perlu.');
    }
  }, {capture:true});

  // ----- 3) Aggressive console override: throw unless allowConsole true -----
  (function(){
    try {
      const orig = {
        log: console.log.bind(console),
        warn: console.warn.bind(console),
        error: console.error.bind(console),
        info: console.info.bind(console)
      };
      Object.defineProperty(window, '__console_originals', { value: orig, enumerable:false, writable:false, configurable:false });
      console.log = function(){
        if(window.__ALLOW_CONSOLE === true) return orig.log.apply(console, arguments);
        throw new Error('console disabled');
      };
      console.warn = console.error = console.info = function(){ throw new Error('console disabled'); };
    } catch(e){}
  })();

  // ----- 4) Devtools detection using multiple heuristics -----
  (function(){
    let devOpen = false;
    function check() {
      // heuristic 1: dimension diff
      const dim = (window.outerWidth - window.innerWidth) + (window.outerHeight - window.innerHeight);
      // heuristic 2: breakpoint via toString debugger trick
      let opened = dim > 160;
      try {
        const start = Date.now();
        // trigger debugger to see if paused (not reliable in all browsers)
        // Use a toString monkey: see if console is intercepted
        const f = function(){};
        const s = f.toString();
        if(s && s.length>0) {} // no-op
      } catch(e){}
      if(opened && !devOpen){ devOpen = true; handleDevOpen(); }
      if(!opened && devOpen){ devOpen = false; handleDevClose(); }
    }
    function handleDevOpen(){
      if(document.getElementById('__devtrap')) return;
      const el = document.createElement('div');
      el.id='__devtrap';
      el.style.cssText='position:fixed;top:8px;left:50%;transform:translateX(-50%);background:#ffefef;color:#900;padding:8px;border-radius:6px;z-index:2147483647;font-weight:700';
      el.innerText='Warning: DevTools detected â€” actions may be blocked';
      document.body.appendChild(el);
      // blur & slow down
      document.body.style.filter = 'blur(1px)';
      // block UI interactivity (best-effort)
      document.body.style.pointerEvents = 'none';
      // after short delay, restore pointer to allow closing devtools by user
      setTimeout(()=>{ document.body.style.pointerEvents='auto'; }, 3500);
    }
    function handleDevClose(){
      const el=document.getElementById('__devtrap'); if(el) el.remove();
      document.body.style.filter='';
    }
    setInterval(check, 700);
    window.addEventListener('resize', check, {passive:true});
  })();

  // ----- 5) Monitor localStorage changes: restore snapshot when modified -----
  (function(){
    const watchedKeys = ['products','sales'];
    // keep initial JSON strings
    const baseline = {};
    watchedKeys.forEach(k => baseline[k] = localStorage.getItem(k));
    // on storage event (other tab) or via polling, restore if unexpected
    window.addEventListener('storage', function(e){
      if(!watchedKeys.includes(e.key)) return;
      // if new value diverges a lot from snapshot, restore
      try {
        const newVal = e.newValue;
        const snap = baseline[e.key];
        if(!snap && newVal) {
          // unexpected write -> log and restore
          if(baseline[e.key] !== null) localStorage.setItem(e.key, baseline[e.key]);
        } else if(snap && newVal !== snap){
          // try to parse and compare length; if shorter or obviously tampered, restore
          if(newVal && newVal.length < 20) {
            localStorage.setItem(e.key, baseline[e.key]);
            _toast('Penyimpanan dicegah: perubahan tidak sah pada '+e.key);
          }
        }
      } catch(ex){}
    });
    // polling fallback
    setInterval(()=> {
      try {
        watchedKeys.forEach(k=>{
          const cur = localStorage.getItem(k);
          if(cur === null && baseline[k] !== null) {
            localStorage.setItem(k, baseline[k]);
            _toast('Pencegahan perubahan lokal untuk '+k);
          }
        });
      } catch(e){}
    }, 2000);
  })();

  // ----- 6) Mutation observer: detect new script tags / DOM tampering -----
  (function(){
    const whitelist = new Set();
    // gather current script srcs
    document.querySelectorAll('script').forEach(s=>{
      if(s.src) whitelist.add(s.src);
      else whitelist.add(s.innerHTML ? s.innerHTML.slice(0,120) : '');
    });
    const mo = new MutationObserver((mutations)=>{
      for(const m of mutations){
        if(m.type==='childList'){
          m.addedNodes.forEach(node=>{
            if(node.tagName && node.tagName.toLowerCase()==='script'){
              // if new script has src not in whitelist, remove and warn
              const txt = node.src || (node.innerHTML ? node.innerHTML.slice(0,120) : '');
              if(!whitelist.has(node.src) && !whitelist.has(txt)){
                try{ node.remove(); }catch(e){}
                _toast('Skrip mencurigakan diblokir.');
              }
            }
          });
        }
      }
    });
    mo.observe(document.documentElement || document.body, { childList:true, subtree:true });
  })();

  // ----- 7) Freeze important globals (friction) -----
  (function(){
    try {
      if(window.products) Object.freeze(window.products);
      if(window.sales) Object.freeze(window.sales);
      // create read-only snapshots (again)
      if(!window.__PRODUCTS_SNAPSHOT) Object.defineProperty(window, '__PRODUCTS_SNAPSHOT', { value: JSON.parse(JSON.stringify(window.products||[])), writable:false, configurable:false });
      if(!window.__SALES_SNAPSHOT) Object.defineProperty(window, '__SALES_SNAPSHOT', { value: JSON.parse(JSON.stringify(window.sales||[])), writable:false, configurable:false });
    } catch(e){}
  })();

  // ----- 8) Remove any sourceMappingURL comments in inline scripts (best-effort) -----
  (function(){
    try {
      document.querySelectorAll('script').forEach(s=>{
        if(s.innerHTML && s.innerHTML.includes('sourceMappingURL')) {
          s.innerHTML = s.innerHTML.replace(/\/\/[#\s]*sourceMappingURL=.*$/m, '');
        }
      });
    } catch(e){}
  })();

  // ----- 9) Safe wrapper for critical actions (client side check only) -----
  window.__secureAction = async function(actionName, payload){
    const token = sessionStorage.getItem('session_token');
    if(!token) {
      _toast('Aksi terlindungi. Silakan login.');
      throw new Error('Unauthorized');
    }
    // developer: replace with server call
    return fetch('/api/secure-action', {
      method:'POST',
      headers:{ 'Content-Type':'application/json', 'Authorization':'Bearer '+token },
      body: JSON.stringify({ action: actionName, payload })
    }).then(r=>r.json());
  };

  // final notice
  _toast('Proteksi klien: mode agresif aktif. Ingat: pindahkan logika sensitif ke server untuk keamanan nyata.');

})();
/* ===== END STRONG-HARDENING ===== */


</script>
</body>
</html>
